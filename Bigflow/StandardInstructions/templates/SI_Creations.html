{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} SI Creations {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<style>
.w3-bar .w3-bar-item{padding:8px 16px;float:left;width:auto;border:none;display:block;outline:0}
.w3-bar .w3-dropdown-hover,.w3-bar .w3-dropdown-click{position:static;float:left}
.w3-bar .w3-button{white-space:normal}
.w3-bar-block .w3-bar-item{width:100%;display:block;padding:8px 16px;text-align:left;border:none;white-space:normal;float:none;outline:0}
.w3-bar-block.w3-center .w3-bar-item{text-align:center}.w3-block{display:block;width:100%}
.w3-bar-block .w3-dropdown-hover,.w3-bar-block .w3-dropdown-click{width:100%}
.w3-bar-block .w3-dropdown-hover .w3-dropdown-content,.w3-bar-block .w3-dropdown-click .w3-dropdown-content{min-width:100%}
.w3-bar-block .w3-dropdown-hover .w3-button,.w3-bar-block .w3-dropdown-click .w3-button{width:100%;text-align:left;padding:8px 16px}
.w3-main,#main{transition:margin-left .4s}
.w3-modal{z-index:3;display:none;padding-top:100px;position:fixed;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgb(0,0,0);background-color:rgba(0,0,0,0.4)}
.w3-modal-content{margin:auto;background-color:#fff;position:relative;padding:0;outline:0;width:600px}
.w3-bar{width:100%;overflow:hidden}.w3-center .w3-bar{display:inline-block;width:auto}
.w3-bar .w3-bar-item{padding:8px 16px;float:left;width:auto;border:none;display:block;outline:0}
.w3-bar .w3-dropdown-hover,.w3-bar .w3-dropdown-click{position:static;float:left}
.w3-bar .w3-button{white-space:normal}
.w3-bar-block .w3-bar-item{width:100%;display:block;padding:8px 16px;text-align:left;border:none;white-space:normal;float:none;outline:0}
.w3-bar-block.w3-center .w3-bar-item{text-align:center}.w3-block{display:block;width:100%}
.w3-responsive{display:block;overflow-x:auto}
.w3-container:after,.w3-container:before,.w3-panel:after,.w3-panel:before,.w3-row:after,.w3-row:before,.w3-row-padding:after,.w3-row-padding:before,
.w3-cell-row:before,.w3-cell-row:after,.w3-clear:after,.w3-clear:before,.w3-bar:before,<div class="w3-bar:after">content:"";display:table;clear:both</div>
.w3-card-4,.w3-hover-shadow:hover{box-shadow:0 4px 10px 0 rgba(0,0,0,0.2),0 4px 20px 0 rgba(0,0,0,0.19)}
    .w3-ul.w3-hoverable li:hover{background-color:#ccc},
    .w3-ul{list-style-type:none;padding:0;margin:0}.w3-ul li{padding:8px 16px;border-bottom:1px solid #ddd}.w3-ul li:last-child{border-bottom:none}
.w3-tiny{font-size:10px!important}.w3-small{font-size:12px!important}.w3-medium{font-size:15px!important}.w3-large{font-size:18px!important}


.md-padding {
    padding: 8px;
    height: 470px !important;
}
md-tabs:not(.md-no-tab-content):not(.md-dynamic-height) {
    min-height: 470px;
}






</style>
<div class="maincontent">
    <div ng-app="makersummary" ng-controller="ctrlsummary" class="container container1">
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>SI Create</h4>
            </div>
        </div>
        <form role="form" name="si_create_form" novalidate>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>SI Header Name</label>
                            <input ng-model="si_header_name" ng-required="true">
                        </md-input-container>
                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>From Date</label>
                            <md-datepicker md-hide-icons="calendar"
                                           ng-model="models.from_date" ng-change="fromdate_changed(models.from_date)"
                                           md-hide-icons="calendar" ng-click="date" md-min-date="maxDate"
                                           md-max-date="minDate" formatDate required></md-datepicker>
                        </md-input-container>
                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>To Date</label>
                            <md-datepicker ng-model="models.to_date" ng-change="todate_changed(models.to_date)"
                                           md-hide-icons="calendar" ng-click="date" md-min-date="maxDate1"
                                           md-max-date="minDate1" formatDate required>

                            </md-datepicker>
                        </md-input-container>
                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label> Amount</label>
                            <input ng-model="models.amount" valid-number
                                   maxlength="16" required/>
                        </md-input-container>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>Recurring Period</label>
                            <md-select ng-model="models.period" ng-required="true">
                                <md-option ng-repeat="x in recuring_period" ng-value="x"
                                           ng-click="periodclick(x)">{{ x.metadata_value }}
                                </md-option>
                            </md-select>
                        </md-input-container>
                    </div>
                    <div class="col-md-3" ng-show="models.period.metadata_value == '1 MONTH'"
                         ng-disabled="from_date_status==0">
                        <md-input-container class="md-block inputrange">
                            <label>Recurring Day</label>
                            <input ng-model="models.recurringdate" type="number"
                                   ng-change="validate_recuring_date(models.recurringdate)"
                                   ng-disabled="from_date_status==0"
                                   min="{{min}}" max="{{max}}"
                            />
                        </md-input-container>
                    </div>
                    <div class="col-md-3" ng-show="models.period.metadata_value == '1 WEEK'"
                         ng-disabled="from_date_status==0">
                        <md-input-container class="md-block inputcontainer">
                            <label>Recurring Day</label>
                            <md-select ng-model="models.recurringdate">
                                <md-option ng-repeat="x in weekdays" ng-value="x.Day"
                                           ng-disabled="from_date_status==0"
                                           ng-click="periodclick(x)">{{ x.Day }}
                                </md-option>
                            </md-select>
                        </md-input-container>
                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>Supplier Name</label>
                            <md-select ng-model="models.supplierid" ng-required="true"
                                       md-on-close="clearSearchTerm()"
                                       data-md-container-class="selectdemoSelectHeader">
                                <md-select-header class="demo-select-header">
                                    <input ng-model="searchTerm1" type="search"
                                           placeholder="Search for a Supplier Name.."
                                           class="demo-header-searchbox md-text"
                                           onkeydown="mdSelectOnKeyDownOverride(event)">
                                </md-select-header>
                                <md-optgroup label="Supplier Name">
                                    <md-option ng-value="supplier.supplier_gid"
                                               ng-selected="models[tab.title].supplierid == supplier.supplier_gid"
                                               ng-click="supplierclick(supplier.supplier_gid)"
                                               ng-repeat="supplier in invoicesupplier_list |
                                                filter:searchTerm1">{{supplier.supplier_name}}
                                    </md-option>
                                </md-optgroup>
                            </md-select>
                        </md-input-container>
                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>Branch</label>
                            <md-select ng-model="models.branchid" ng-required="true">
                                <md-option ng-repeat="x in soourcedata" ng-value="x.branch_gid"
                                           ng-selected="selectedsource == x.branch_gid"
                                           ng-click="sourceclick(x)">{{
                                    x.branch_name }}
                                </md-option>
                            </md-select>
                        </md-input-container>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-2">
                        <md-checkbox type="checkbox" ng-true-value="1" class="md-primary"
                                     style="bottom: -20px;"
                                     ng-false-value="0" ng-change="gst_click(models.Isgst)"
                                     ng-model="models.Isgst">
                            <strong>Gst Applicable</strong>
                        </md-checkbox>
                    </div>
                    <div class="col-md-2">
                        <md-input-container class="md-block inputcontainer"
                                            ng-hide="models.Isgst=='1' ? false : true">
                            <label>HSN/SAC Code</label>
                            <md-select ng-model="models.hsnid"

                                       md-on-close="clearSearchTerm()"
                                       data-md-container-class="selectdemoSelectHeader">
                                <md-select-header class="demo-select-header">
                                    <input ng-model="searchTerm" type="search"
                                           placeholder="Search for a hsn.."
                                           class="demo-header-searchbox md-text"
                                           onkeydown="mdSelectOnKeyDownOverride(event)">
                                </md-select-header>
                                <md-optgroup label="HSN CODE">
                                    <md-option ng-value="hsn.hsn_gid"
                                               ng-selected="models.hsnid == hsn.hsn_gid"
                                               ng-repeat="hsn in HSN_DROPDOWN |
                                                filter:searchTerm">{{hsn.hsn_code}}
                                    </md-option>
                                </md-optgroup>
                            </md-select>
                        </md-input-container>
                    </div>

                    <div class="col-md-2">
                        <md-checkbox type="checkbox" ng-true-value="1" class="md-primary"
                                     style="bottom: -20px;"
                                     ng-false-value="0"
                                     ng-model="models.Istds">
                            <strong>TDS Applicable</strong>
                        </md-checkbox>
                    </div>


                    <div class="col-md-2" style="bottom:-20px">
                        <span class="editlink material-icons"
                              ng-click="dts_details(models[tab.title].supplierid)"
                              ng-hide="models.Istds=='1' ? false : true">
                              arrow_upward
                        </span><span>TDS Details</span>

                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer"
                                            ng-hide="models.Istds=='1' ? false : true">
                            <label>TDS Type</label>
                            <md-select ng-model="models.tds_id">
                                <md-option ng-repeat="tds in Tax_Type" ng-value="tds.subdetails_gid">
                                    {{tds.Type}}
                                </md-option>
                            </md-select>
                        </md-input-container>
                    </div>

                </div>
            </div>
            <br/>

            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-6">
                        <md-input-container class="md-block inputcontainer">
                            <label>Remarks</label>
                            <input ng-model="si_remarks">
                        </md-input-container>
                    </div>
                    <div class="col-md-1" style=" bottom: -20px;">
                        <a href="" ng-click="CCBS_ADD(tab.title)"><i
                                class="material-icons">
                            arrow_upward
                        </i>CCBS</a>
                    </div>
                    <div class="col-md-2"></div>
                    <div class="col-md-1">
                        <md-button ng-click="add_details(models.period.metadata_value)"
                                   ng-disabled="si_create_form.$invalid || models.recurringdate==null"
                                   class="md-raised md-warn">ADD
                            <md-tooltip>ADD</md-tooltip>
                        </md-button>
                    </div>
                </div>
            </div>
        </form>


        <div class="row table-responsive">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                       md-progress="deferred">
                    <thead class="header">
                    <tr>
                        <th>S NO</th>
                        <th>On Date</th>
                        <th>Monthly Amount</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="sis in si_all_data.slice(((currentPage-1)*itemsPerPage),((currentPage)*itemsPerPage)) | filter:search:strict"
                        align="center">
                        <td>
                            <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                        </td>
                        <td>{{sis.StandardInstructionDetails_ondate |date:'dd-MMM-yyyy'}}</td>
                        <td>{{sis.StandardInstructionDetails_Amount}}</td>
                        <td><a> <i class="material-icons" style="color:red"
                                   ng-click="delete_columns($index)">
                            delete
                        </i></a></td>

                    </tr>
                    <tr ng-show="si_all_data.length ==  0">
                        <td class="warning" colspan="12">
                            No Records Found.
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="3">
                            <ul uib-pagination total-items="si_all_data.length" ng-model="currentPage"
                                max-size="maxSize"
                                class="pagination-sm" boundary-links="true" items-per-page="itemsPerPage"></ul>
                        </td>
                        <td colspan="2">
                            Total Count:{{si_all_data.length}}
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>

        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="col-md-5"></div>
                <div class="col-md-2">
                    <md-button class="md-raised custbutton"
                               value="submit"
                               ng-click="create_si()"
                               ng-disabled="si_all_data.length=='0'">
                        SUBMIT
                    </md-button>
                </div>
                <div class="col-md-1">
                    <a href="StandardInstructions/SI_Summary/">
                        <md-button class="md-raised" value="close"
                                   aria-label="Close">Cancel
                        </md-button>
                    </a>
                </div>
            </div>
        </div>

        <div class="modal fade" id="mdl_ccbs" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:80%;">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="text-center" id="s">
                            CCBS Details
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="row">
                        <div class="col-md-12 col-lg-12 col-sm-12 table-responsive">
                            <h4 class="text-center">Primary CCBS </h4>
                            <div class=" text-right" ng-click="primaryclick()"><a href=""> <i class="material-icons">
                                add
                            </i></a></div>
                            <table class="table table-bordered"
                            >
                                <thead class="header">
                                <tr>
                                    <th>S NO</th>
                                    <th>BS</th>
                                    <th>CC</th>

                                </tr>
                                </thead>
                                <tbody ng-init="totall = 0">
                                <tr
                                        ng-repeat="type in ccbsdebit">
                                    <td class="text-center">
                                        {{$index+1}}
                                    </td>
                                    <td>
                                        <md-autocomplete
                                                md-clear-button="true"
                                                md-input-maxlength=126
                                                md-item-text="bs.tbs_name"
                                                ng-model="tbs_gid"
                                                md-items="bs in getbs(searchpbs)"
                                                md-min-length=0
                                                md-no-cache="true"
                                                md-search-text="searchpbs"
                                                md-selected-item="type.bs"
                                                md-selected-item-change="bsChanged_prim(bs.tbs_gid)">
                                            <md-item-template>
                                                <span md-highlight-text="searchTex"> {{bs.tbs_name}}</span>
                                            </md-item-template>
                                            <md-not-found>
                                                No BS Name matching "{{searchbs}}" were found.
                                            </md-not-found>
                                        </md-autocomplete>
                                    </td>
                                    <td>
                                        <md-autocomplete
                                                md-clear-button="true"
                                                md-input-maxlength=126
                                                md-item-text="cc.tcc_name"
                                                md-items="cc in getcc_prim(searchpcc,$index)"
                                                md-min-length=0
                                                md-no-cache="true"
                                                md-search-text="searchpcc"
                                                md-selected-item="type.cc"
                                                md-selected-item-change="CcChanged(city)">
                                            <md-item-template>
                                                <span md-highlight-text="searchTex"> {{cc.tcc_name}}</span>
                                            </md-item-template>
                                            <md-not-found>
                                                No CC Name matching "{{searchcc}}" were found.
                                            </md-not-found>
                                        </md-autocomplete>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <form role="form" name="column_valid">

                            <div class="col-md-12 col-lg-12 col-sm-12 table-responsive">
                                <h4 class="text-center">Allocation CCBS </h4>
                                <div class=" text-right" ng-click="allocationclick()">
                                    <a href=""> <i class="material-icons">
                                        add
                                    </i></a>
                                </div>
                                <table class="table table-bordered">
                                    <thead class="header">
                                    <tr>
                                        <th>S NO</th>
                                        <th>Category</th>
                                        <td>Sub Category</td>
                                        <th>BS</th>
                                        <th>CC</th>
                                        <th>Percentage</th>
                                        <th>Delete</th>
                                    </tr>
                                    </thead>
                                    <tbody ng-init="totall = 0">
                                    <tr ng-repeat="cc in ccbscredit">
                                        <td class="text-center">
                                            {{$index+1}}
                                        </td>
                                        <td>
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-input-maxlength=126
                                                    md-item-text="cat.category_name"
                                                    ng-model="cat.category_gid"
                                                    md-items="cat in getCategoryName(searchCategory)"
                                                    md-min-length=0
                                                    md-no-cache="true"
                                                    md-search-text="searchCategory"
                                                    md-selected-item="cc.cat"
                                                    md-selected-item-change="CategoryChanged(cat.category_gid)">
                                                <md-item-template>
                                                    <span md-highlight-text="searchTex"> {{cat.category_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Categpry Name matching "{{search By Category}}" were found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </td>
                                        <td>
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-input-maxlength=126
                                                    md-item-text="sub.subcategory_name"
                                                    ng-model="tbs_gid"
                                                    md-items="sub in getSubCategoryName(searchSubcat)"
                                                    md-min-length=0
                                                    md-no-cache="true"
                                                    md-search-text="searchSubcat"
                                                    md-selected-item="cc.sub"
                                                    md-selected-item-change="bsChanged_allo(sub.subcategory_gid,$index)">
                                                <md-item-template>
                                                    <span md-highlight-text="searchTex"> {{sub.subcategory_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No SubCategory Name matching "{{search Subcategory}}" were found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </td>

                                        <td>
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-input-maxlength=126
                                                    md-item-text="bs.tbs_name"
                                                    ng-model="tbs_gid"
                                                    md-items="bs in getbs(searchbs)"
                                                    md-min-length=0
                                                    md-no-cache="true"
                                                    md-search-text="searchbs"
                                                    md-selected-item="cc.bs"
                                                    md-selected-item-change="bsChanged_allo(bs.tbs_gid,$index)">
                                                <md-item-template>
                                                    <span md-highlight-text="searchTex"> {{bs.tbs_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No BS Name matching "{{searchbs}}" were found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </td>
                                        <td>
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-input-maxlength=126
                                                    md-item-text="cc.tcc_name"
                                                    md-items="cc in getcc(searchcc,$index)"
                                                    md-min-length=0
                                                    md-no-cache="true"
                                                    md-search-text="searchcc"
                                                    md-selected-item="cc.cc"
                                                    md-selected-item-change="CcChanged(city)">
                                                <md-item-template>
                                                    <span md-highlight-text="searchTex">{{cc.tcc_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No CC Name matching "{{searchcc}}" were found.
                                                </md-not-found>
                                            </md-autocomplete>

                                        </td>

                                        <td class="text-center" width="50px;">
                                            <input class="textboxgeneral" valid-number
                                                   maxlength="3" only-numbers
                                                   ng-model="cc.percentage"
                                                   ng-change="percentage_validate($index,ccbscredit[$index].percentage)"/>
                                        </td>
                                        </td>
                                        <td><a><i class="material-icons" ng-hide="$index +1 <1"
                                                  ng-click="delete_ccbs_column($index)">
                                            delete
                                        </i></a></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="Tds_Details" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="text-center">
                            TDS Details
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="row table-responsive">
                        <div class="col-md-12 col-lg-12 col-sm-12">
                            <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                   md-progress="deferred">
                                <thead class="header">
                                <tr>
                                    <th>S.No</th>
                                    <th>Type</th>
                                    <th>Rate</th>
                                    <th>Exempt Rate</th>
                                    <th>ISEXEMPT</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="tds in Tax_Type">
                                    <td>
                                        <center>{{$index+1}}</center>
                                    </td>
                                    <td class="text-center">{{tds.Type}}</td>
                                    <td class="text-center">{{tds.Rate}}</td>
                                    <td class="text-center">{{tds.Exempt_Rate}}</td>
                                    <td class="text-center">{{tds.ISEXEMPT}}</td>
                                </tr>
                                </tbody>
                                <tfoot>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


{% endverbatim %}
<style>

.btn-default.btn-on.active{background-color: #5BB75B;color: white;}
.btn-default.btn-off.active{background-color: #DA4F49;color: white;}

.btn-default.btn-on-1.active{background-color: #006FFC;color: white;}
.btn-default.btn-off-1.active{background-color: #DA4F49;color: white;}

.btn-default.btn-on-2.active{background-color: #00D590;color: white;}
.btn-default.btn-off-2.active{background-color: #A7A7A7;color: white;}

.btn-default.btn-on-3.active{color: #5BB75B;font-weight:bolder;}
.btn-default.btn-off-3.active{color: #DA4F49;font-weight:bolder;}

.btn-default.btn-on-4.active{background-color: #006FFC;color: #5BB75B;}
.btn-default.btn-off-4.active{background-color: #DA4F49;color: #DA4F49;}


.md-select-menu-container.md-active {
  z-index: 1060;
 }
.md-virtual-repeat-container.md-autocomplete-suggestions-container {
     width:10px !important;
}





</style>
<script>jQuery.event.special.touchstart = {
  setup: function( _, ns, handle ){
    if ( ns.includes("noPreventDefault") ) {
      this.addEventListener("touchstart", handle, { passive: false });
    } else {
      this.addEventListener("touchstart", handle, { passive: true });
    }
  }
};




</script>

<script>
    var app=angular.module('makersummary',['ngMaterial','ui.bootstrap','AppCommon','rzTable']).config(function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';

});
app.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "dd-MMM-yyyy");
    };
})

app.controller('ctrlsummary', ['$scope', '$filter', '$mdDateLocale', 'br_rentcreate', '$window', '$rootScope', '$mdDialog', '$element','$http','SerCommon',
    function($scope, $filter,$mdDateLocale, br_rentcreate, $window, $rootScope, $mdDialog, $element, $http, SerCommon) {
        $scope.currentPage=1;
        $scope.maxSize=3;
        $scope.itemsPerPage=10;
        $scope.from_date_day=0;
        $scope.to_date_day=0;
        $scope.from_date_status=0;
        $scope.to_date_status=0;
        $scope.selected_week_day_id=0;

        $scope.models = {};
        $scope.min = 1;

        $scope.maxDate = new Date();

        $scope.loading = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.body),
                clickOutsideToClose: false
            });
        };

        $scope.loading_popup = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.getElementById('mdl_ccbs')),
                clickOutsideToClose: false
            });
        };

        $scope.fromdate_changed=function(dates){
            $scope.maxDate1= dates;
            $scope.from_date_day=parseInt($filter('date')(dates, "dd"));
            $scope.from_date_status=1;
        }
        $scope.todate_changed=function(dates){
            $scope.to_date_day=parseInt($filter('date')(dates, "dd"));
            $scope.to_date_status=1;
        }


        $scope.validate_recuring_date=function(values){
            if(values>28){
                $scope.models.recurringdate=0;
            }
            else{
                $scope.models.recurringdate=values;
            }
        }

        var service_period = br_rentcreate.get_all_table_metadata_values();
            service_period.then(function(result) {
                var recuring_period = result.data.DATA;
                debugger;
                $scope.recuring_period = recuring_period;
                console.log($scope.recuring_period);

            }, function() {
               alert("Some Interanal Error");
        });


        $scope.tds_det=[];
        $scope.si_all_data=[];

        $rootScope.add_product = function() {
            modalshow('product_category_add');
        }

        var data = {
            "Table_name": "ap_mst_tcategory",
            "Column_1": "category_gid, category_code, category_no, category_name, category_glno, category_isactive",
            "Column_2": "",
            "Where_Common": "category",
            "Where_Primary": "",
            "Primary_Value": "",
            "Order_by": "gid"
        }

        var patch = {
            Action: "",
            Entity_Gid: $scope.entity_gid,
            data: data
        }

        var getcat = br_rentcreate.getcategory(patch);
            getcat.then(function(result) {
            debugger;
                $scope.category_all = result.data;
                $scope.category_all_copy=$scope.category_all;
                console.log($scope.category_all);
            }, function(err) {
                alert('No data!.');
        }).finally();

        $scope.getCategoryName = Change_Cate_Name;
        function Change_Cate_Name(query) {
           var result = $filter('filter')($scope.category_all, {
           'category_name': query
             });
           return result;
        }
        $scope.CategoryChanged=function(cat_gid){

           $scope.cat_gid=cat_gid;
            var data={"FILTER":{"category_gid":[$scope.cat_gid]}}
            var datam={
                        "Group":"CCBS_MASTER",
                        "Type":"ccbs_category",
                        "Sub_type":"get",
                        "data":data
            }
         $scope.loading_popup();
         var sub_category_get=br_rentcreate.get_subcategory(datam);
             sub_category_get.then(function(result)
             {
              $scope.sub_category_all = result.data;
                $scope.sub_category_all_copy=$scope.category_all;
                console.log($scope.sub_category_all);
            }, function(err) {
                alert('No data!.');
            }).finally($scope.endloading);
        };

        $scope.getSubCategoryName = Change_SubCate_Name;
        function Change_SubCate_Name(query) {
           var result = $filter('filter')($scope.sub_category_all, {
           'subcategory_name': query
             });
           return result;
        }

        $scope.SubCategoryChanged=function(sub_cat_gid){
            $scope.sub_cat_gid=sub_cat_gid;
        }


        $scope.add_details = function(recuring_period) {
            debugger;
            $scope.si_all_data=[];
            if($scope.si_all_data.length==0){
                $scope.temp_from_date="";
                $scope.temp_to_date="";
                var d1=$scope.models.from_date;
                var from_date1=$scope.models.from_date;
                var d2=$scope.models.to_date;
                $scope.all_date=[];

                var timeDiff = Math.abs(d2.getTime() - d1.getTime());
                $scope.dayDifference = Math.ceil(timeDiff / (1000 * 3600 * 24));

                var from_date_month=$filter('date')($scope.models.from_date, "MM");
                var to_date_month=$filter('date')($scope.models.to_date, "MM");

                var date = new Date($scope.models.from_date), y = date.getFullYear(), m = date.getMonth();
                $scope.temp_date = new Date(y, m, 1);

                function monthDiff(d1, d2) {
                    var months;
                    months = (d2.getFullYear() - d1.getFullYear()) * 12;
                    months -= d1.getMonth() + 1;
                    months += d2.getMonth();
                    return months <= 0 ? 0 : months;
                }

                //find_no_of_days
                $scope.no_of_months=monthDiff(d1,d2);

                if(recuring_period=="1 MONTH"){

                    if($scope.from_date_day<$scope.models.recurringdate){
                        $scope.temp_from_date=$scope.models.from_date;
                        $scope.temp_from_date.setDate($scope.models.recurringdate);
                        $scope.StandardInstructionDetails_ondate=$filter('date')($scope.temp_from_date, "yyyy-MM-dd");
                    }
                    else{
                        $scope.StandardInstructionDetails_ondate=$filter('date')($scope.models.from_date, "yyyy-MM-dd");
                    }
                    var values={"StandardInstructionDetails_ondate":$scope.StandardInstructionDetails_ondate,
                                     "StandardInstructionDetails_Status":"PENDING",
                                     "StandardInstructionDetails_Amount":$scope.models.amount,
                                     "StandardInstructionDetails_Remark":"",
                                     "StandardInstructionDetails_IsHold":"N"
                                    };
                    $scope.si_all_data.push(values);
                    $scope.center_date=$scope.models.recurringdate-2;
                    for(var i=1;i<=$scope.no_of_months;i++){
                        $scope.next_date=load_FromDatas(i);
                        $scope.next_date.setDate($scope.models.recurringdate);
                        var date_values=$filter('date')($scope.next_date, "yyyy-MM-dd");
                        var values={"StandardInstructionDetails_ondate":date_values,
                                     "StandardInstructionDetails_Status":"PENDING",
                                     "StandardInstructionDetails_Amount":$scope.models.amount,
                                     "StandardInstructionDetails_Remark":"",
                                     "StandardInstructionDetails_IsHold":"N"
                                    };
                        $scope.si_all_data.push(values);

                    }
                    function load_FromDatas(i){
                        return new Date(
                           $scope.temp_date.getFullYear(),
                           $scope.temp_date.getMonth()+i,
                           $scope.temp_date.getDate());
                    }

                    if(from_date_month!=to_date_month){
                        if($scope.to_date_day>$scope.models.recurringdate){
                            $scope.temp_to_date=$scope.models.to_date;
                            $scope.temp_to_date.setDate($scope.models.recurringdate);
                            $scope.StandardInstructionDetails_ondate=$filter('date')($scope.temp_to_date, "yyyy-MM-dd");
                        }
                        else{
                            $scope.StandardInstructionDetails_ondate=$filter('date')($scope.models.to_date, "yyyy-MM-dd");
                        }
                        var values={"StandardInstructionDetails_ondate":$scope.StandardInstructionDetails_ondate,
                                         "StandardInstructionDetails_Status":"PENDING",
                                         "StandardInstructionDetails_Amount":$scope.models.amount,
                                         "StandardInstructionDetails_Remark":"",
                                         "StandardInstructionDetails_IsHold":"N"
                                        };
                        $scope.si_all_data.push(values);
                    }
                }
                else if(recuring_period=="1 WEEK"){
                    $scope.temp_from_date_day=new Date(d1);
                    var keepGoing=true;
                    $scope.first_week_day="";
                    var today = new Date(d1).getDay();
                    var selected_day_value="";

                    for(k=0;k<$scope.weekdays.length;k++){
                        if($scope.weekdays[k].Day==$scope.models.recurringdate){
                            selected_day_value=$scope.weekdays[k].dayvalue;
                            //$scope.models.recurringdate=selected_day_value;
                            $scope.selected_week_day_id=selected_day_value;
                        }
                    }
                    for(i=0;i<7;i++){
                        var temp = load_FromDatas(i);
                        var find_first_day=new Date(temp).getDay();
                        if(find_first_day==selected_day_value){
                            $scope.first_week_day=temp;
                        }

                    }
                    function load_FromDatas(i){
                        return new Date(
                           $scope.temp_from_date_day.getFullYear(),
                           $scope.temp_from_date_day.getMonth(),
                           $scope.temp_from_date_day.getDate()+i);
                    }
                    $scope.StandardInstructionDetails_ondate=$filter('date')($scope.first_week_day, "yyyy-MM-dd");
                    var values={"StandardInstructionDetails_ondate":$scope.StandardInstructionDetails_ondate,
                                     "StandardInstructionDetails_Status":"PENDING",
                                     "StandardInstructionDetails_Amount":$scope.models.amount,
                                     "StandardInstructionDetails_Remark":"",
                                     "StandardInstructionDetails_IsHold":"N"
                                    };
                    $scope.si_all_data.push(values);

                    $scope.dayDifference=parseInt($scope.dayDifference/7);
                    $scope.dayDifference+=1;
                    for(l=1;l<$scope.dayDifference;l++){
                        var center_week_day=load_FromData(7*l);
                        if(center_week_day.getTime()<=d2.getTime()){
                            $scope.StandardInstructionDetails_ondate=$filter('date')(center_week_day, "yyyy-MM-dd");
                            var values={"StandardInstructionDetails_ondate":$scope.StandardInstructionDetails_ondate,
                                        "StandardInstructionDetails_Status":"PENDING",
                                        "StandardInstructionDetails_Amount":$scope.models.amount,
                                        "StandardInstructionDetails_Remark":"",
                                        "StandardInstructionDetails_IsHold":"N"
                                      };
                            $scope.si_all_data.push(values);
                        }
                    }
                    function load_FromData(i){
                        return new Date(
                           $scope.first_week_day.getFullYear(),
                           $scope.first_week_day.getMonth(),
                           $scope.first_week_day.getDate()+i);
                    }
                }
		    }
		    else
            {
               alert("Already Inserted");
            }
        }


        $scope.allocation_ccbs=[];
        $scope.primary_ccbs_bs_gid=0;
        $scope.primary_ccbs_cc_gid=0;


        $scope.create_si=function(){

            $scope.execute=1;
            debugger;
            $scope.total=0;

            if($scope.ccbsdebit.length!=0){
                    if($scope.ccbsdebit[0].bs!=null && $scope.ccbsdebit[0].cc!=null){
                        $scope.primary_ccbs_bs_gid=$scope.ccbsdebit[0].bs.tbs_gid;
                        $scope.primary_ccbs_cc_gid=$scope.ccbsdebit[0].cc.tcc_gid;
                    }
                    else{
                        alert("Give Primary CCBS Details");
                        $scope.execute=0;
                    }
            }
            else{
                alert("Give Primary CCBS Details");
                $scope.execute=0;
            }

            if($scope.ccbscredit.length!=0){
                for(var j=0;j<$scope.ccbscredit.length;j++){
                    if($scope.ccbscredit[j].cat!=null && $scope.ccbscredit[j].sub!=null && $scope.ccbscredit[j].cc!=null && $scope.ccbscredit[j].bs!=null){
                        var values={"StandardInstructionCCBS_CategoryGid":$scope.ccbscredit[j].cat.category_gid,
                                    "StandardInstructionCCBS_SubcategoryGid":$scope.ccbscredit[j].sub.subcategory_gid,
                                    "StandardInstructionCCBS_BSGid":$scope.ccbscredit[j].bs.tbs_gid,
                                    "StandardInstructionCCBS_CCGid":$scope.ccbscredit[j].cc.tcc_gid,
                                    "StandardInstructionCCBS_Percent":$scope.ccbscredit[j].percentage,
                                    "StandardInstructionCCBS_Remarks":""
                        }
                    }
                    $scope.total+=parseFloat($scope.ccbscredit[j].percentage);
                    if(values!=undefined){
                        $scope.allocation_ccbs.push(values);
                    }
                    else{
                        $scope.execute=0;
                        alert("Give Correct CCBS Details!...");
                    }
                }
             }
            else{
                alert("Give Allocation CCBS Details!...");
            }


            var IsGST_value="N";
            var IsTDS_value="N";
            var hsn_value=0;
            var tds_id=0;
            if($scope.models.Isgst==1){
                IsGST_value="Y";
                hsn_value=$scope.models.hsnid;
                if($scope.models.hsnid==undefined){
                    $scope.execute=0;
                    alert("Give HSN Values");
                }
            }
            if($scope.models.Istds==1){
                IsTDS_value=="Y";
                if($scope.models.tds_id==undefined){
                    $scope.execute=0;
                    alert("Give TDS Value");
                }
            }
            if($scope.execute==1){
                if($scope.ccbscredit.length!=0 && $scope.ccbsdebit.length!=0 && $scope.total==100){
                    $scope.from_date=$filter('date')($scope.models.from_date, "yyyy-MM-dd");
                    $scope.to_date=$filter('date')($scope.models.to_date, "yyyy-MM-dd");
                    if($scope.models.period.metadata_value=="1 WEEK"){
                        $scope.models.recurringdate=$scope.selected_week_day_id;
                    }
                    var datas={params:{"action":'INSERT',"type":'INSERT_STANDARD_INSTRUCTION',
                                        "filter":{"StandardInstruction_SupplierId":$scope.models.supplierid,
                                                    "StandardInstruction_FromDate":$scope.from_date,
                                                    "StandardInstruction_Name":$scope.si_header_name,
                                                    "StandardInstruction_ToDate":$scope.to_date,
                                                    "StandardInstruction_Amount":$scope.models.amount,
                                                    "StandardInstruction_RecurringDate":$scope.models.recurringdate,
                                                    "StandardInstruction_RecurringPeriod":$scope.models.period.metadata_gid,
                                                    "StandardInstruction_SupplierTaxId":tds_id,
                                                    "StandardInstruction_Status":"PENDING FOR APPROVAL",
                                                    "StandardInstruction_Branchid":$scope.models.branchid,
                                                    "StandardInstruction_Recurring":$scope.models.recurringdate,
                                                    "StandardInstruction_Isgst":IsGST_value,
                                                    "StandardInstruction_hsngid":hsn_value,
                                                    "StandardInstruction_Istds":IsTDS_value,
                                                    "StandardInstruction_BSGid":$scope.primary_ccbs_bs_gid,
                                                    "StandardInstruction_CCGid":$scope.primary_ccbs_cc_gid,
                                                    "StandardInstruction_Invoiceheader_Gid":1,
                                                    "ccbs":$scope.allocation_ccbs,"detail": $scope.si_all_data
                                                  }
                                        }
                    };

                    $scope.loading();
                    var si_create = br_rentcreate.si_set(datas);
                        si_create.then(function(result) {
                            var res=JSON.parse(result.data);
                             if (res.MESSAGE[0]=== "SUCCESS") {
                            alert("Succesfully SI Created...");
                            $window.location.href = "StandardInstructions/SI_Summary/";
                            } else {
                          alert(JSON.stringify(res));
                          }
                        }, function(err) {
                          alert('Data Not Inserted');
                        }).finally($scope.endloading);

                }
                else
                {
                    alert("Give Correct CCBS Details!...");
                }
            }



        }

        $scope.delete_columns = function(index){
             $scope.si_all_data.splice(index, 1);
        }

        $scope.delete_ccbs_column = function(index){
             $scope.ccbscredit.splice(index, 1);
        }

        $scope.percentage_validate = function(index, value) {

             var sum = 0;
            angular.forEach($scope.ccbscredit, function(value, key) {
                sum += parseFloat(value.percentage);
                if (sum > 100) {
                    value.percentage = 0;
                    value.amount = 0;
                   alert("Percentage Exists")
                }
            });
        }




        //end values

        $scope.click_titles= '';
        $scope.period = [{
            "periodname":"1 Week",
        },{
            "periodname":"1 Month",
        },];

        $scope.weekdays = [{Day: 'Monday',dayvalue: 1}, {Day: 'Tuesday',dayvalue: 2}, {Day: 'Wednesday',dayvalue: 3},
                           {Day: 'Thursday',dayvalue: 4}, {Day: 'Friday',dayvalue: 5}, {Day: 'Saturday',dayvalue: 6},
                           {Day: 'Sunday',dayvalue: 0}];
        $scope.endloading = function() {
            $mdDialog.hide();
        };
        $scope.querySearch = function(query) {
                te = $filter('filter')($scope.employee, {
                    'employee_code': query
                });
                // console.log(te)
                return te;

            }

        window.mdSelectOnKeyDownOverride = function(event) {
            event.stopPropagation();
        };

        var supplier = br_rentcreate.getdropdown("supplier");
        supplier.then(function(supplier) {

            var supplier = JSON.parse(supplier.data);

            $scope.invoicesupplier_list = supplier;

        }, function() {
            alert("Record Not Found")
        });


        $scope.branchdetails = function(value){
            $scope.expns_id = value.branchexpense_gid;
            $scope.expense_details = JSON.parse(value.branchdetails);
            modalshow('mdl_exp');

        }

         $scope.CCBS_ADD = function(value){
            $scope.click_titles=value;
            modalshow('mdl_ccbs');
         }



         $scope.ccbscredit = [];
            $scope.ccbsdebit = [];
            $scope.allocationclick = function(){
            $scope.ccbscredit.push({})
         }
         $scope.count=0;
         $scope.primaryclick = function(){
            if($scope.count<1){
                $scope.count=$scope.count+1;
               $scope.ccbsdebit.push({})
            }

         }

        function percentage(num, per) {
            return (num / 100) * per;
        }

            var databs = {
                "Table_name": "ap_mst_tbs",
                "Column_1": "tbs_code,tbs_gid,tbs_name",
                "Column_2": "",
                "Where_Common": "tbs",
                "Where_Primary": "",
                "Primary_Value": "",
                "Order_by": "gid"
            }


            $scope.getcc = Change_cc;
           function Change_cc(query,indx) {
               var result = $filter('filter')($scope.ccbscredit[indx].tccdropdown, {
               'tcc_code': query
                 });
               return result;
            }

            $scope.getcc_prim = Change_cc_prim;
            function Change_cc_prim(query,indx) {
               var result = $filter('filter')($scope.ccbsdebit[0].tccdropdown, {
               'tcc_code': query
                 });
               return result;
            }

          var bs = br_rentcreate.ccbsdata(databs);
          bs.then(function(result) {
              $scope.all_bs = result.data;
             console.log(result.data)
          });

       $scope.getbs = Change_bs;
         function Change_bs(query) {
           var result = $filter('filter')($scope.all_bs, {
           'tbs_code': query
             });
           return result;
       }
        $scope.Tax_Type = [];
         $scope.supplierclick = function (supplier_gid){
                 $scope.Tax_Type = [];
                  $scope.loading();
                var credit = br_rentcreate.creditget(supplier_gid, "SUPPLIER_DETAILS")
                credit.then(function(result) {
                        $scope.endloading();
                        $scope.Credit = result.data;
                        var key = 0;
                        angular.forEach($scope.Credit, function(value, key) {
                            if (key == 0) {
                                angular.forEach(JSON.parse(value.tds_data), function(tdsvalue, key) {
                                      if(tdsvalue.tds_tax_type != null){
                                               $scope.Tax_Type.push({
                                                    "Type": tdsvalue.tds_tax_type,
                                                    "Rate": tdsvalue.tax_rate,
                                                    "Exempt_Rate": tdsvalue.exempt_rate,
                                                    "Exempt_Threshold_Amount": tdsvalue.exempt_threshold_amount,
                                                    "ISEXEMPT": tdsvalue.ISEXEMPT,
                                                    "subdetails_gid": tdsvalue.subdetails_gid,
                                                });
                                          }
                                      })
                            }
                           // console.log($scope.Tax_Type)
                        })

                     })
         }


        $scope.bsChanged_allo = function(bs_gid,indx) {
          console.log(bs_gid);
          $scope.ccbscredit[indx].tccdropdown = [];
             $scope.datascc = {
               "Table_name":"ap_mst_tcc",
                "Column_1":"tcc_gid,tcc_code,tcc_name",
                "Column_2":"",
                "Where_Common":"tcc",
                "Where_Primary":"bsgid",
                "Primary_Value":bs_gid,
                "Order_by":"gid"
                }
             $scope.loading_popup();
             var cc = br_rentcreate.ccbsdata($scope.datascc);
             cc.then(function(result) {
               if (bs_gid != undefined){
                 $scope.ccbscredit[indx].tccdropdown = result.data;

                 }
            }, function(err) {
                alert('No data!.');
            }).finally($scope.endloading);
        };

         $scope.bsChanged_prim = function(bs_gid,indx) {
            $scope.datascc = {
               "Table_name":"ap_mst_tcc",
                "Column_1":"tcc_gid,tcc_code,tcc_name",
                "Column_2":"",
                "Where_Common":"tcc",
                "Where_Primary":"bsgid",
                "Primary_Value":bs_gid,
                "Order_by":"gid"
            }
            $scope.loading_popup();
             var cc = br_rentcreate.ccbsdata($scope.datascc);
             cc.then(function(result) {
                 $scope.ccbsdebit[0].tccdropdown = result.data;
            }, function(err) {
                alert('No data!.');
            }).finally($scope.endloading);
        };

        var datan = {
            "Table_name": "gal_mst_thsn",
            "Column_1": "hsn_gid, hsn_code,hsn_igstrate",
            "Column_2": "",
            "Where_Common": "hsn",
            "Where_Primary": "",
            "Primary_Value": "",
            "Order_by": "code"
        }
        var phsn = {
            Action: "",
            Entity_Gid: $scope.entity_gid,
            data: datan
        }
        $scope.product_productcate = [];
        var getproductcate = br_rentcreate.gethsndata(phsn)
        getproductcate.then(function(result) {
         //  console.log(result)
            $scope.HSN_DROPDOWN = result.data.DATA;
        }, function(err) {
            alert('No data!.');
        }).finally();



         $scope.dts_details=function(value){
            var values=value;
            modalshow('Tds_Details');
         }

        var resaondata = br_rentcreate.getentitydata();
        resaondata.then(function(result) {
            $scope.soourcedata = result.data.DATA

        })


    }
]);

app.service("br_rentcreate", function ($http) {

    this.gethsndata = function(phsn) {
        var respons = $http.post(Appname + "/prodget/", phsn);
        return respons;
    }

    this.getdropdown = function (tablename) {
        var responsee = $http.post(Appname+"/Dropdown_detail_ap/",{params:{"tablename":tablename,"gid":0,"name":''}});
        return responsee;
    }

    this.ccbsdata = function (data) {
        var response = $http.post(Appname+"/tablevalue/",{params:{"tablevalue":data}});
            return response;
    }

    this.creditget = function(gid,type){
        if(type == 'PPX_emp' || type == 'EMP Claim'){ var sp_type = 'EMPLOYEE_DETAILS' }else{ var sp_type = 'SUPPLIER_DETAILS' };
        var response=$http.post(Appname+"/Credit_get/",{params:{"type":sp_type,"supplier_gid":gid}});
            return response;
    }

    //added

    this.si_set=function (data) {
        var response=$http.post(Appname+"/Set_SI/",data);
        return response;
    }

    this.getentitydata = function () {
        var response=$http.post(Appname+"/classificationdata_get/",{params:{"type":"Mode","Sub_Type":"Summary",
                               "FILTER":{},"CLASSIFICATION":{"Entity_Gid":[0]}}});
        return response;
    }

    this.getcategory = function(patch){
        var respons = $http.post(Appname + "/get_tablevalue/", patch);
        return respons;
    }

    this.get_subcategory = function(patch){
        var respons = $http.post(Appname + "/get_subcate_data/", patch);
        return respons;
    }

   this.get_all_table_metadata_values = function () {
        var response=$http.post(Appname+"/Get_All_Table_Metadata_Value/",{params:{"action":"Get","type":"Metadata","sub_type":"Recuring_Period","filter":{}}});
        return response;
     }




});








</script>


{% endblock %}