{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} eClaim Expense{% endblock %}
{% block content %}
{% verbatim %}
<style xmlns:>
.modal-lg{
    width:1000px
    }
.md-virtual-repeat-container {
    width: 400px;
    }
img {
  cursor: -webkit-zoom-in;
  cursor: -moz-zoom-in;
}
.container3 {
    font-size: 12px;
    background-color: white;
    box-shadow: 0px 0px 10px 5px #c1d4dc;
    padding-bottom: 15px;
    height:100%;
}

</style>
<div class="maincontent">
    <div class="container container1"
         ng-app="eclaimapp" ng-controller="eclaimctrl" ng-cloak>
        <md-subheader ng-show="user_type" class="md-accent">On BeHalf Employee - {{emp_name}}</md-subheader>
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>eClaim Expense</h4>
            </div>
        </div>
        <div class="row" class="col-md-12">
            <!--            <div class="row">-->
            <!--                <div class="col-md-12">-->
            <!--                    <md-subheader class="md-accent">Employee</md-subheader>-->
            <!--                    <div class="col-md-3">-->
            <!--                        <md-input-container class="md-block inputcontainer">-->
            <!--                            <label>Tour ID</label>-->
            <!--                            <input disabled ng-model="tour_no" type="text"/>-->
            <!--                        </md-input-container>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-3">-->
            <!--                        <md-input-container class="md-block inputcontainer">-->
            <!--                            <label>Employee Name</label>-->
            <!--                            <input disabled ng-model="emp_name" type="text"/>-->
            <!--                        </md-input-container>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-3">-->
            <!--                        <md-input-container class="md-block inputcontainer">-->
            <!--                            <label>Designation</label>-->
            <!--                            <input disabled ng-model="designation" type="text"/>-->
            <!--                        </md-input-container>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-3">-->
            <!--                        <md-input-container class="md-block inputcontainer">-->
            <!--                            <label>Employee Grade</label>-->
            <!--                            <input disabled ng-model="emp_grade" type="text"/>-->
            <!--                        </md-input-container>-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </div>-->
        </div>
        <div class="row" class="col-md-12">
            <div class="row">
                <form name="expense_valid" novalidate role="form">
                    <fieldset data-ng-repeat="choice in choices">
                        <div class="col-md-12">
                            <md-subheader class="md-accent">Tour Expense</md-subheader>
                            <div class="col-md-3">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Tour ID</label>
                                    <input disabled ng-model="tour_no" type="text"/>
                                </md-input-container>
                            </div>

                            <div class="col-md-3">
                                <label>Tour Expense Type</label>
                                <md-autocomplete
                                        md-item-text="item.name"
                                        md-items="item in typesearch(searchtype)"
                                        md-min-length=0
                                        ng-disabled="status_check"
                                        md-no-cache="true"
                                        md-search-text="searchtype"
                                        md-selected-item="choice.selectedtyp"
                                        md-selected-item-change=""
                                        ng-required="true"
                                        placeholder="Tour Expense Type">
                                    <md-item-template>
                                        <span md-highlight-text="searchText"> {{item.name}} - {{item.code}} </span>
                                    </md-item-template>
                                    <md-not-found>
                                        No Tour Expense Type matching "{{searchtype}}" were found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div class="col-md-3">
                                <md-input-container class="md-block inputcontainer">
                                    <label>Requester Comment</label>
                                    <input maxlength="30" ng-model="choice.remaks"
                                           placeholder="Remarks"
                                           name="remaks"
                                           ng-required="true"
                                           ng-disabled="status_check"
                                           ng-pattern="/^[^`~@#$%\^&*()_+={}|[\]\\:';<>?!/]*$/"
                                           type="text"/>
                                    <span class="error" style="color:red"
                                          ng-show="expense_valid.remaks.$error.pattern">Special char Error</span>
                                    {{myForm.$error}}
                                </md-input-container>
                            </div>
                            <div class="col-md-1">
                                <md-button class="md-fab md-mini md-primary custbutton"
                                           ng-click="add_taveltype(choice)"
                                           ng-disabled="expense_valid.$invalid || status_check ">
                                    <md-icon>add</md-icon>
                                    <md-tooltip>Add Expense</md-tooltip>
                                </md-button>
                            </div>
                            <div class="col-md-1" ng-show="claim_status == 'APPROVED'">
                                <md-button class="md-fab md-mini md-primary custbutton"
                                           ng-click="get_pdf(sum)">
                                    <md-icon>insert_drive_file</md-icon>
                                    <md-tooltip>Add Tour Details</md-tooltip>
                                </md-button>
                                <md-button class="btn btn-info custbutton"
                                           ng-click="paymentstatus()">Status
                                    <md-tooltip>Payment Status</md-tooltip>
                                </md-button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="row table-responsive ">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                    <thead class="header">
                    <th class="text-center" scope="col">S.No</th>
                    <th class="text-center" scope="col">Expense Type</th>
                    <th class="text-center" scope="col">Eligible Amount</th>
                    <th class="text-center" scope="col">Claim Amount</th>
                    <th class="text-center" scope="col" ng-show="claim_status == 'APPROVED'">Approved Amount</th>
                    <th class="text-center" scope="col">Requester Comment</th>
                    <th class="text-center" scope="col">Expense Details</th>
                    </thead>
                    <tbody>
                    <tr ng-repeat="eclaim in eClaim_tavels.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage)) | orderBy:orderByField:reverseSort">
                        <td class="text-center">
                            <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                        </td>
                        <td class="text-center">{{eclaim.description}}</td>
                        <td class="text-right">{{eclaim.eligibleamount | number: 2}}</td>
                        <td class="text-right">{{eclaim.claimedamount | number: 2}}</td>
                        <td class="text-right" ng-show="claim_status == 'APPROVED'">{{eclaim.approvedamount | number:
                            2}}
                        </td>
                        <td class="text-center">{{eclaim.requestorcomment}}</td>
                        <td class="text-center">
                            <a ng-click="travel_expense(eclaim)"><i class="material-icons">
                                edit
                            </i></a>
                            <md-button ng-disabled="claim_status == 'APPROVED'||
                            claim_status == 'REJECTED' ||
                            claim_applevel == '2' || claim_applevel == '1'"
                                       ng-click="remove_travel(eclaim)"><i
                                    class="material-icons">
                                close
                            </i></md-button>
                    </tr>
                    <tr ng-show="data_len ==  0">
                        <td class="warning" colspan="17">
                            No Records Found.
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="2">
                            <ul boundary-links="true" class="pagination-sm cust_pagination"
                                items-per-page="itemsPerPage"
                                max-size="maxSize"
                                ng-model="currentPage" total-items="eClaim_tavels.length"
                                uib-pagination></ul>
                        </td>
                        <td class="text-left" colspan="1">
                            <span>Total Eligible Amount:<br/> <b
                                    class="text-right"> {{total_eligamount | number: 2}}</b></span>
                        </td>
                        <td class="text-left" colspan="1">
                            <span>Total Claim Amount:<br/> <b
                                    class="text-right"> {{total_claimamount | number: 2}}</b></span>
                        </td>
                        <td ng-show="applevel == 2 || claim_status == 'APPROVED'" class="text-left" colspan="1">
                            <span>Total Approved Amount:<br/> <b
                                    class="text-right"> {{total_approveamount | number: 2}}</b></span>
                        </td>
                        <td colspan="3">
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="row" ng-show="applevel == 2 || claim_status == 'APPROVED'">
            <div class="row">
                <div class="col-md-4">
                </div>
                <div class="col-md-2">
                    <h5> Total Claimed Amount : </h5>
                </div>
                <div class="col-md-1">
                    <h5>{{total_claimamount}}</h5>
                </div>
                <div class="col-md-2">
                    <h5> Advance to be Adjusted : </h5>
                </div>
                <div class="col-md-1">
                    <h5>{{advanceamount}}</h5>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                </div>
                <div class="col-md-2">
                    <h5>Total Approved Amount :</h5>
                </div>
                <div class="col-md-1">
                    <h5>{{total_approveamount}}</h5>
                </div>
                <div class="col-md-2">
                    <h5 style="color:blue;"> Net Payable :</h5>
                </div>
                <div class="col-md-1">
                    <h5 style="color:blue;">{{net_amount}}</h5>
                </div>
            </div>
            <div class="row" ng-show="paystatus">
                <div class="col-md-4">
                </div>
                <div class="col-md-2">
                    <h5>Payment Status :</h5>
                </div>
                <div class="col-md-2">
                    <h5 style="color:blue;">{{invoiceheader_status}}</h5>
                </div>
            </div>
        </div>
        <div class="row" class="col-md-12">
            <md-subheader class="md-accent">Attachment</md-subheader>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3">
                        <div id="file_exp">
                            <input id="files_exp" minsize="500"
                                   multiple
                                   ng-disabled="applevel == 2 || claim_status == 'APPROVED'"
                                   ng-required="true"
                                   onchange="angular.element(this).scope().imageUpload(event)"
                                   name="files"
                                   type="file"/>
                        </div>
                    </div>
                    <div class="col-md-3">
                            <span ng-show="db_file"
                                  class="error">File Count - {{files.length + stepsModel.length}}</span>
                        <md-button ng-show="db_file" class="btn btn-info custbutton"
                                   ng-click="attachment()">Attachment
                            <md-tooltip>Expense Attachment</md-tooltip>
                        </md-button>
                    </div>
                    <div class="col-md-3">
                        <span ng-show="db_file != 'false'" ng-hide="db_file" class="error">File Count - {{stepsModel.length}}</span>
                        <md-button ng-show="db_file != 'false'" ng-hide="db_file" class="btn btn-info custbutton"
                                   ng-click="viewimage()">Attachment
                            <md-tooltip>Expense Attachment</md-tooltip>
                        </md-button>
                    </div>
                    <div class="col-md-3">
                        <md-button class="btn btn-info custbutton"
                                   class="md-raised"
                                   ng-click="add_ccbs($index,eclaim)">CCBS
                            <md-tooltip>Add CCBS</md-tooltip>
                        </md-button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" class="col-md-12">
            <md-subheader class="md-accent">Acceptance</md-subheader>
            <div class="row">
                <div class="col-md-12 text-left">
                    <div style=" border: 1px solid black;">
                        <p></p>
                        <p style="color:red;">
                            <md-icon class="material-icons editlink">done</md-icon>
                            Bills are in order ,I have self attested the original of the bills.BH/BOM has affixed
                            seal and signature on each bill.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div ng-show="advanceadjust" class="row">
            <div class="col-md-12">
                <md-subheader class="md-accent">Advance Adjust</md-subheader>
                <div class="row table-responsive ">
                    <div class="col-md-8 col-lg-8 col-sm-8">
                        <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                            <thead class="header">
                            <th class="text-center" scope="col">S.No</th>
                            <th class="text-center" scope="col">CRN No</th>
                            <th class="text-center" scope="col">Date</th>
                            <th class="text-center" scope="col">Amount</th>
                            <th class="text-center" scope="col">Balance</th>
                            <!--                            <th class="text-center" scope="col">Amount to Adjust</th>-->
                            <!--                            <th class="text-center" scope="col">Action</th>-->
                            </thead>
                            <tbody>
                            <tr ng-repeat="ad in advanceadjust_data.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage)) | orderBy:orderByField:reverseSort">
                                <td class="text-center">
                                    <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                                </td>
                                <td class="text-left">{{ad.ppxheader_crno}}</td>
                                <td class="text-left">{{ad.ppxheader_date}}</td>
                                <td class="text-left">{{ad.ppxheader_amount}}</td>
                                <td class="text-left">{{ad.ppxheader_balance}}</td>
                                <!--                                <td class="text-left">-->
                                <!--                                    <input class="form-control" maxlength="10"-->
                                <!--                                           ng-model="ad.adjustamount"-->
                                <!--                                           ng-required="true"-->
                                <!--                                           ng-pattern="/^[0-9,.]/"-->
                                <!--                                           ng-change="adjust_change(ad)"-->
                                <!--                                           name="AmountAdjust"-->
                                <!--                                           ng-disabled="status_check"-->
                                <!--                                           style="width:80px"-->
                                <!--                                           placeholder="AmountAdjust"-->
                                <!--                                           type="text"/>-->
                                <!--                                </td>-->
                                <!--                                <td class="text-left">-->
                                <!--                                    <md-button-->
                                <!--                                            ng-disabled="status_check || ad.adjustamount == 0 || ad.adjustamount == ''"-->
                                <!--                                            ng-click="submit_amount(ad)"><i class="material-icons">-->
                                <!--                                        done-->
                                <!--                                    </i></md-button>-->
                                <!--                                </td>-->


                            </tr>
                            <tr ng-show="data_len ==  0">
                                <td class="warning" colspan="17">
                                    No Records Found.
                                </td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td colspan="5">
                                    <ul boundary-links="true" class="pagination-sm cust_pagination"
                                        items-per-page="itemsPerPage"
                                        max-size="maxSize"
                                        ng-model="currentPage" total-items="eClaim_tavels.length"
                                        uib-pagination></ul>
                                </td>
                                <!--                        <td class="text-left" colspan="1">-->
                                <!--                            <span>Total Count:<br/> <b class="text-centre"> {{eClaim_tavels.length}}</b></span>-->
                                <!--                        </td>-->
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <br/>
        <div class="row" class="col-md-12" ng-show="datarelaxation_status == 0 || datarelaxation_status == '0'">
            <div class="row">
                <div class="col-md-12 text-center">
                    <div>
                        <p></p>
                        <p style="color:red;">
                            This Tour Needs Spcial Permission For Date Relaxation.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" class="col-md-12" ng-hide="datarelaxation_status == 0 || datarelaxation_status == '0'">
            <md-subheader class="md-accent">To Forward/Check</md-subheader>
            <form name="submit_valid" novalidate role="form">
                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-3" ng-show="claim_status != 'REJECTED' && claim_status !='APPROVED'">
                            <label>Branch</label>
                            <md-autocomplete
                                    md-item-text="item.branch_name"
                                    md-items="item in brsearch(searchbr)"
                                    md-min-length=0
                                    ng-disabled="status_check"
                                    md-search-text="searchbr"
                                    md-selected-item="selectedbr"
                                    md-selected-item-change="branchchange(item)"
                                    placeholder="Branch">
                                <md-item-template>
                                    <span md-highlight-text="searchText"> {{item.branch_code}} {{item.branch_name}} </span>
                                </md-item-template>
                                <md-not-found>
                                    No Branch matching "{{searchbr}}" were found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>
                        <div class="col-md-3" ng-show="claim_status =='REJECTED' || claim_status =='APPROVED'">
<!--                            <md-input-container>-->
                                <label>Branch</label>
                            <br/>
                                {{ searchbr_data }}
<!--                            </md-input-container>-->
                        </div>

                        <div class="col-md-3" ng-show="claim_status != 'REJECTED' && claim_status !='APPROVED'">
                            <label>Employee</label>
                            <md-autocomplete
                                    md-item-text="item.employee_name"
                                    md-items="item in empsearch(searchemp)"
                                    md-min-length=0
                                    ng-disabled="status_check"
                                    md-no-cache="true"
                                    md-search-text="searchemp"
                                    md-selected-item="selectedemp"
                                    md-selected-item-change="selectempchange(item)"
                                    ng-required="true"
                                    md-input-name="approver"
                                    placeholder="Employee">
                                <md-item-template>
                                    <span md-highlight-text="searchText"> {{item.employee_name}} {{item.employee_code}} </span>
                                </md-item-template>
                                <md-not-found>
                                    No Employee matching "{{searchemp}}" were found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>

                        <div class="col-md-3" ng-show="claim_status =='REJECTED' || claim_status =='APPROVED' ">
<!--                            <md-input-container>-->
                                <label>Employee</label>
                                <br/>
                                {{ searchemp_data }}
<!--                            </md-input-container>-->
                        </div>

                        <div class="col-md-3">
                            <label>Submit Comments</label>
                            <textarea ng-model="comments"
                                      ng-disabled="status_check"
                                      ng-pattern="/^[^`~@#$%\^&*()_+={}|[\]\\:';<>?!/]*$/"
                                      style="width:500px"
                                      maxlength="500"
                                      ng-required="true"
                                      name="comment"
                                      type="text">
                                </textarea>
                            <span class="error" style="color:red"
                                  ng-show="submit_valid.comment.$error.pattern">Special char Error</span>
                            {{myForm.$error}}
                        </div>
                    </div>
                </div>
                <div class="col-md-12 text-center">
                    <md-button class="btn btn-info custbutton"
                               ng-click="submit_valid.$valid ? submit_data() : error_toast(submit_valid)"
                               ng-disabled="claim_status == 'APPROVED' || claim_status == 'REJECTED' || file_required || submit_date || status_check">
                        Submit
                        <md-tooltip>Submit</md-tooltip>
                    </md-button>
                    <md-button class="md-raised" ng-href="eClaim/eclaim_expense_request"
                               type="button"
                               value="Back">Back
                    </md-button>
                    <span class="error" style="color:red"
                          ng-show="file_required">Please Attach Expense File.</span>
                    <span class="error" style="color:red"
                          ng-show="submit_date">Tour Date Not End</span>
                </div>
            </form>
        </div>

        <div ng-show="approvaldata" class="row">
            <div class="col-md-12">
                <md-subheader class="md-accent">Approval Flow</md-subheader>
                <div class="row table-responsive ">
                    <div class="col-md-8 col-lg-8 col-sm-8">
                        <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                            <thead class="header">
                            <th class="text-center" scope="col">S.No</th>
                            <th class="text-center" scope="col">Employee</th>
                            <th class="text-center" scope="col">Raisedby</th>
                            <th class="text-center" scope="col">Type</th>
                            <th class="text-center" scope="col">Date</th>
                            <th class="text-center" scope="col">Comment</th>
                            <th class="text-center" scope="col">Status</th>
                            </thead>
                            <tbody>
                            <tr ng-repeat="apprl in get_approval_data.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage)) | orderBy:orderByField:reverseSort">
                                <td class="text-center">
                                    <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                                </td>
                                <td class="text-left">{{apprl.employee_name}} - {{apprl.employee_code}}</td>
                                <td class="text-left" ng-show="apprl.onbehalof == '0'">{{apprl.employee_name}} -
                                    {{apprl.employee_code}}
                                </td>
                                <td class="text-left" ng-show="apprl.onbehalof != '0'">{{apprl.onbehalof_employeename}}
                                    - {{apprl.onbehalof_employeecode}}
                                </td>
                                <td class="text-left">{{apprl.apptype}}</td>
                                <td class="text-left">{{apprl.approveddate}}</td>
                                <td class="text-left">{{apprl.appcomment}}</td>
                                <td class="text-left">
                                    <p ng-show="apprl.status == 'PENDING' && apprl.applevel == '1' ">
                                        Tour Claim Submitted To Forwarder</p>
                                    <p ng-show="apprl.status == 'PENDING' && apprl.applevel == '2' ">
                                        Tour Claim Verified and Submitted To Approver</p>
                                    <p ng-show="apprl.status == 'REJECTED' && apprl.applevel == '1' ">
                                        Tour Claim Forwarder Rejected</p>
                                    <p ng-show="apprl.status == 'REJECTED' && apprl.applevel == '2' ">
                                        Tour Claim Approver Rejected</p>
                                    <p ng-show="apprl.status == 'APPROVED' && apprl.applevel == '1'">
                                        Tour Claim Forwarder Approved</p>
                                    <p ng-show="apprl.status == 'APPROVED' && apprl.applevel == '2'">
                                        Tour Claim Approver Approved</p>
                                    <p ng-show="apprl.status == 'REQUESTED'">
                                        Tour Claim Request Created</p>
                                    <p ng-show="apprl.status == 'RETURN' && apprl.applevel == '1'">
                                        Tour Claim Returned From Forwarder</p>
                                    <p ng-show="apprl.status == 'RETURN' && apprl.applevel == '2'">
                                        Tour Claim Returned From Approver</p>
                                </td>


                            </tr>
                            <tr ng-show="data_len ==  0">
                                <td class="warning" colspan="17">
                                    No Records Found.
                                </td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td colspan="7">
                                    <ul boundary-links="true" class="pagination-sm cust_pagination"
                                        items-per-page="itemsPerPage"
                                        max-size="maxSize"
                                        ng-model="currentPage" total-items="eClaim_tavels.length"
                                        uib-pagination></ul>
                                </td>
                                <!--                        <td class="text-left" colspan="1">-->
                                <!--                            <span>Total Count:<br/> <b class="text-centre"> {{eClaim_tavels.length}}</b></span>-->
                                <!--                        </td>-->
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!--Image start-->
        <div aria-hidden="" aria-labelledby="exampleModalLabel"
             class="modal fade"
             data-backdrop="" data-keyboard="false"
             id="attach_view">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <strong>eClaim Expense Attachment View</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <!--                            <div class="row">-->
                            <!--                                <div class="col-lg-12 col-sm-12">-->
                            <!--                                    <div ng-repeat="file in files" class="text-center">-->
                            <!--                                        <img ng-show="file.type =='image'" src="{{ file.file_path }}"-->
                            <!--                                             style="width:870px;height:500px"/>-->
                            <!--                                        <br/>-->
                            <!--                                        <iframe ng-show="file.type =='pdf'" ng-src="{{file.file_url}}"-->
                            <!--                                                    style="width:870px;height:500px"></iframe>-->
                            <!--                                            <md-button class="md-icon-button md-primary" aria-label="Settings"-->
                            <!--                                                               href="common_s3_file_download?filename={{file.file_key}}">-->
                            <!--                                                        <md-icon>get_app</md-icon>-->
                            <!--                                                        <md-tooltip>Download File</md-tooltip>-->
                            <!--                                                    </md-button>-->

                            <!--                                        &lt;!&ndash;                                        <object width="870px" height="500px"&ndash;&gt;-->
                            <!--                                        &lt;!&ndash;                                                data="{{file.file_path}}" class="internal">&ndash;&gt;-->
                            <!--                                        &lt;!&ndash;                                            <embed src="{{file.file_path}}"/>&ndash;&gt;-->
                            <!--                                        &lt;!&ndash;                                            <br/>&ndash;&gt;-->
                            <!--                                        &lt;!&ndash;                                        </object>&ndash;&gt;-->
                            <!--                                        <br/>-->
                            <!--                                    </div>-->
                            <!--                                </div>-->
                            <!--                            </div>-->

                            <div class="row table-responsive ">
                                <div class="col-md-12 col-lg-12 col-sm-12">
                                    <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                                        <thead class="header">
                                        <th class="text-center" scope="col">S.No</th>
                                        <th class="text-center" scope="col">File Name</th>
                                        <th class="text-center" scope="col">View</th>
                                        <th class="text-center" scope="col">Download</th>
                                        <th class="text-center" scope="col">Remove</th>
                                        </thead>
                                        <tbody>
                                        <tr ng-repeat="file in files.slice(((currentPage-1)*itemsPerPage), ((currentPage)*itemsPerPage))">
                                            <td class="text-center">
                                                <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                                            </td>
                                            <td class="text-center">
                                                <center>{{file.file_name}}</center>
                                            </td>
                                            <td class="text-center">
                                                <a ng-click="open_file(file)"><i
                                                        class="material-icons">
                                                    arrow_upward
                                                </i></a>
                                            </td>
                                            <td class="text-center">
                                                <a href="common_s3_file_download?filename={{file.file_key}}"><i
                                                        class="material-icons">
                                                    get_app
                                                </i></a>
                                            </td>
                                            <td class="text-center">
                                                <a ng-click="remove_file(file)"><i
                                                        class="material-icons">
                                                    close
                                                </i></a>
                                            </td>
                                        </tr>
                                        <tr ng-show="data_len ==  0">
                                            <td class="warning" colspan="17">
                                                No Records Found.
                                            </td>
                                        </tr>
                                        </tbody>
                                        <tfoot>
                                        <tr>
                                            <td colspan="5">
                                                <ul boundary-links="true" class="pagination-sm cust_pagination"
                                                    items-per-page="itemsPerPage"
                                                    max-size="maxSize"
                                                    ng-model="currentPage" total-items="files.length"
                                                    uib-pagination></ul>
                                            </td>
                                            <!--                        <td class="text-left" colspan="1">-->
                                            <!--                            <span>Total Count:<br/> <b class="text-centre"> {{eClaim_tavels.length}}</b></span>-->
                                            <!--                        </td>-->
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="row" ng-show="stepsModel.length != 0">
                                <div class="col-lg-12 col-sm-12" ng-repeat="file in stepsModel">
                                    <!--                                    <img src="{{file}}" style="width:800px;height:500px"/>-->
                                    <object width="870px" height="500px"
                                            data="{{file}}" class="internal">
                                        <embed src="{{file}}"/>
                                        <br/>
                                    </object>
                                    <button class="btn" ng-click="remove_image($index)">
                                        X
                                    </button>
                                    <br/>
                                    <br/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Image start-->
        <div aria-hidden="" aria-labelledby="exampleModalLabel"
             class="modal fade"
             data-backdrop="" data-keyboard="false"
             id="imdiate_view">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel2">
                                <strong>eClaim Expense Attachment View</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-3">
                                    </div>
                                    <div class="col-md-3">
                                    </div>
                                    <div class="col-md-3">
                                    </div>
                                    <div class="col-md-2">
                                    </div>
                                    <div class="col-md-1">
                                        <button class="btn" ng-click="remove_allimage($index)">
                                            X
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <div class="row">
                                <div class="col-lg-12 col-sm-12" ng-repeat="file in stepsModel">
                                    <!--                                    <img src="{{file}}" style="width:800px;height:500px"/>-->
                                    <object width="870px" height="500px"
                                            data="{{file}}" class="internal">
                                        <embed src="{{file}}"/>
                                        <br/>
                                    </object>
                                    <br/>
                                    <button class="btn" ng-click="remove_image($index)">
                                        X
                                    </button>
                                    <br/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div ng-include="'eClaim/eClaim_ccbs_popup'"></div>
        <div aria-hidden="" aria-labelledby="exampleModalLabel"
             class="modal fade"
             data-backdrop="" data-keyboard="false"
             id="attach_view_single">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <strong>Tour Attachment View</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <p class="text-center">{{file_file_name}}</p>
                            <div class="row">
                                <div class="col-lg-12 col-sm-12">
                                    <img ng-show="file_type =='image'" src="{{ file_file_path }}"
                                         style="width:870px;height:500px"/>
                                    <br/>
                                    <iframe ng-show="file_type =='pdf'" ng-src="{{file_file_url}}"
                                            style="width:870px;height:500px"></iframe>
                                </div>
                                <p class="text-center"> If attachment is not displayed, please refresh by pressing "F5"
                                    key</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endverbatim %}
<style>
 .md-select-menu-container.md-active {
    z-index: 1060;
    }







</style>
<script>
function clearFileInputField(tagId) {
    document.getElementById(tagId).innerHTML =
        document.getElementById(tagId).innerHTML;
    }







</script>

<script>
   var myApp = angular.module('eclaimapp', ['ngMaterial','ui.bootstrap','ngMessages','AppCommon'])
    .config(function($httpProvider) {
        $httpProvider.defaults.xsrfCookieName = 'csrftoken';
        $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
    });
        myApp.run(function($mdDateLocale, $filter) {
        $mdDateLocale.formatDate = function(date) {
            return $filter('date')(date, "dd-MMM-yyyy");
        };
    })

myApp.controller('eclaimctrl',function($scope,$sce,eclaimService,$http, $window, $filter,$mdDialog, $rootScope,$element,SerCommon) {
       $element.find('input').on('keydown', function(ev) {
          ev.stopPropagation();
      });
      var detail = JSON.parse(sessionStorage.getItem('today'));
      var date = new Date(detail.date);
      $scope.today_date = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    var employee_data=JSON.parse(sessionStorage.getItem('eClaim'));
    $scope.tour_gid = employee_data.tour_gid;
    $scope.tour_no = employee_data.tour_no;
    $scope.tour_reason = employee_data.tour_reason;
    $scope.tour_requestdate = employee_data.tour_requestdate;
    $scope.emp_name = employee_data.emp_name;
    $scope.designation = employee_data.designation;
    $scope.emp_grade = employee_data.emp_grade;
    $scope.claim_status = employee_data.Status;
    $scope.claim_applevel = employee_data.applevel;
    $scope.eClaim_tavels =[];
    $scope.approvaldata = false;
    $scope.db_file = false;
    $scope.view_image = true;
    $scope.base = [];
    if(sessionStorage.getItem('eClaim_tavel')){
        $scope.base = [];
       var travel_data =JSON.parse(sessionStorage.getItem('eClaim_tavel'));
       angular.forEach(travel_data, function(item1) {
        $scope.base.push(item1);
        $scope.eClaim_tavels.push(item1);
       });
    }
    $scope.status_check = false;
    if($scope.claim_status == "PENDING" || $scope.claim_status == "APPROVED" || $scope.claim_status == "REJECTED" ){
        $scope.status_check = true;
    }
    if($scope.claim_status == "" || $scope.claim_status == " " ){
        $scope.claim_status = "NEW"
    }

    var enddate = new Date(employee_data.tour_enddate);
    $scope.tourend_date = new Date(enddate.getFullYear(), enddate.getMonth(), enddate.getDate());
    if($scope.claim_status == "NEW" || $scope.claim_status == "" || $scope.claim_status == "REQUESTED"){
        if($scope.tourend_date < $scope.today_date ){
            $scope.submit_date = false;
        }
        else{
            $scope.submit_date = true;
            error_toast(tour_not_end,time_toast);
        }
        if($scope.tourend_date == $scope.today_date ){
            $scope.submit_date = true;
            error_toast(tour_not_end,time_toast);
        }
    }


    $scope.choices = [{selectedtyp:"",remaks:""}];

    $scope.maxSize = 3;
    $scope.itemsPerPage = 10;
    $scope.currentPage = 1;
    $scope.loading = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.body),
            clickOutsideToClose: false
        });
    };
    $scope.loading_pop = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.getElementById('addpurpose')),
            clickOutsideToClose: false
        });
    };
    $scope.loading_popup_img = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.getElementById('attach_view')),
            clickOutsideToClose: false
        });
    };
    $scope.endloading = function() {
        $mdDialog.hide();
    };

    $scope.add_taveltype = function(e) {
        data = {
            claimreq_gid:0,
            gid:e.selectedtyp.gid,
            description:e.selectedtyp.name,
            expsensecode:e.selectedtyp.code,
            expensegid:e.selectedtyp.gid,
            requestorcomment:e.remaks
        }
        $scope.eClaim_tavels.push(data);
        $scope.data_len = $scope.eClaim_tavels.length;
        $scope.claim_status == "NEW";
        $scope.choices = [{selectedtyp:"",remaks:""}];
        $scope.expense_type = $filter('filter')($scope.expense_type, function(value) {
                return value.name != e.selectedtyp.name;
        });
    };

    $scope.remove_travel = function(e) {
        if(e.claimreq_gid != 0){
            $scope.loading();
            var data = {
                params: {
                    "Type": "EXPENSE_DELETE",
                    "json" : {
                        "Params": {
                            "FILTER": {
                                 "Claimrequest_gid": e.claimreq_gid
                            }
                        }
                    }
                }
            }
            var eclaim_daily = eclaimService.expense_process_set(data);
            eclaim_daily.then(function(result) {
                $scope.set_msg = result.data.MESSAGE
                if($scope.set_msg == 'SUCCESS' ){
                    success_toast();
                    $window.location.reload();
                }
                else{
                    alert($scope.set_msg);
                }
            }).finally($scope.endloading);
        }
        else{
            sessionStorage.removeItem('eClaim_tavel')
            $window.location.reload();
        }
    }

    session_dataget();
    function session_dataget(){
        var data = {
            "Params": {
                "FILTER": {
                    "type": ""
                }
            }
        }
        var get_eclaim = eclaimService.ecalim_session_get(data)
        get_eclaim.then(function(result) {
            $scope.session_type = result.data.type;
            if($scope.session_type == "ONBEHALF"){
                $scope.user_type = true;
            }
            else{
                 $scope.user_type = false;
            }
        });

    }

    loadtype();
    function loadtype(){
        var data = {
            params: {
                "Type": "CLAIM_EXPENSE",
                "json" : {
                    "Params": {
                        "FILTER": {

                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            if ($scope.tour_reason == "Deputation - Local"){
                $scope.expense_type = $filter('filter')($scope.main, function(value) {
                    return value.code === "LOCDEP";
                });
            }
            else {
                $scope.expense_type = $filter('filter')($scope.main, function(value) {
                    return value.code !== "LOCDEP";
                });
            }

        });
    }

<!--    loadbranch();-->
    function loadbranch(){
        var data = {
            params: {
                "Type": "GET_BRANCH",
                "json" : {
                    "Params": {
                        "FILTER": {
                             "Limit_Start":0,
                             "Limit_End":30,
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_branch_data = $scope.main;
        });
    }

    $scope.brsearch = gotobranch;
        function gotobranch(query) {
             if(query == "undefined"){
                query = "";
                }
            var datas = {
                params: {
                    "Type": "GET_BRANCH",
                    "json" : {
                        "Params": {
                            "FILTER": {
                                "Limit_Start":0,
                                "Limit_End":30,
                                "branch_name":"",
                                "branch_code":"",
                                "branch_detail":query
                            }
                        }
                    }
                }
            }
             return $http.get(Appname + '/eclaim_dropdata/' , datas).then(function(data) {
                var final_values=data.data.DATA;
<!--                console.log(final_values);-->
                return final_values;
             });
    }
    $scope.adjust_change = function(v){
        if(v.ppxheader_amount < v.adjustamount ){
            v.adjustamount = "";
        }
        if($scope.total_eligamount < v.adjustamount ){
            v.adjustamount = "";
        }
    }
    $scope.branchchange = function(v){
        var data = {
            params: {
                "Type": "EMP_BRANCH",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Branch_Gid":v.branch_gid
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_employee_data = $scope.main;
        });
    }
    $scope.empsearch = gotoemp;
        function gotoemp(query) {
            var result = $filter('filter')($scope.get_employee_data, {
                'employee_name': query
            });
            return result;
    }
    $scope.typesearch = gototype;
        function gototype(query) {
            var result = $filter('filter')($scope.expense_type, {
                'name': query
            });
            return result;
    }
    $scope.myfun = function() {
        $scope.eClaim_data = $filter('filter')($scope.main, {
            "tourrequestreason_name": $scope.purpose_name,
            "tourrequestreason_code": $scope.purpose_code,
        });
    }
   $scope.add_purpose = function(){
         modalshow('addpurpose');
    }
   $scope.travel_expense = function(e){
        if(e.expsensecode =="TRVL"){
            session_data (e)
            $window.location.href = "eClaim/eclaim_travel_exp";
        }
        else if(e.expsensecode =="MISC"){
            session_data (e)
            $window.location.href = "eClaim/eclaim_miscelan_exp";
        }
        else if( e.expsensecode =="LODG" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_lodg_exp";
        }
        else if(e.expsensecode =="LCONV" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_loc_conv_exp";
        }
        else if(e.expsensecode =="INCDL" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_incidental_exp";
        }
        else if(e.expsensecode =="DLYDM" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_dailydiem_exp";
        }
        else if(e.expsensecode =="PCKG" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_pkg_mov_dt";
        }
        else if(e.expsensecode =="LOCDEP" ){
            session_data (e)
            $window.location.href = "eClaim/eclaim_localdeputation_exp";
        }
        else{
            alert("Not Selected");
        }
    }

    function session_data (e){
    if($scope.claim_status == "APPROVED"){
        type = true;
    }
    else{
        type = false;
    }
        var eClaim_travel_ses = {
            claimreq_gid : e.claimreq_gid,
            gid:e.gid,
            description:e.description,
            expsensecode:e.expsensecode,
            expensegid:e.expensegid,
            requestorcomment:e.requestorcomment,
            approve:type,
            applevel:0,
            exp_add:true,
        }
        $scope.tavel_data=[];
        if(sessionStorage.getItem('eClaim_tavel')){
            var tavel_details = JSON.parse(sessionStorage.getItem('eClaim_tavel'));
            angular.forEach(tavel_details, function(item1) {
                if(item1.expsensecode != e.expsensecode){
                    $scope.tavel_data.push(item1);
                }
               });
            var result = $filter('filter')($scope.tavel_data, {
                'expsensecode': e.expsensecode
            });
            if(result.length == 0){
                $scope.tavel_data.push(eClaim_travel_ses);
                sessionStorage.setItem('eClaim_tavel', JSON.stringify($scope.tavel_data));
            }
            else{
                angular.forEach(result, function(item1) {
                    $scope.tavel_data.pop(item1);
                });
                $scope.tavel_data.push(eClaim_travel_ses);
                sessionStorage.setItem('eClaim_tavel', JSON.stringify($scope.tavel_data));

                $scope.expense_type = $filter('filter')($scope.expense_type, function(value) {
                    return value.name != e.description;
                });
            }
        }
        else{
            $scope.tavel_data.push(eClaim_travel_ses);
            sessionStorage.setItem('eClaim_tavel', JSON.stringify($scope.tavel_data));

            $scope.expense_type = $filter('filter')($scope.expense_type, function(value) {
                    return value.name != e.description;
                });
        }
    }
    $scope.error_toast = function(e){
        if(e.comment.$error.required == true || e.comment.$invalid == true){
           error_toast(remarks,time_toast);
        }
<!--        if(e.branch.$error.required == true || e.branch.$invalid == true){-->
<!--           error_toast(no_data,time_toast);-->
<!--        }-->
        if(e.approver.$error.required == true || e.approver.$invalid == true){
           error_toast(no_data,time_toast);
        }
    }

    $scope.file_required = false;
    loadeclaim();
    $scope.files =[];
    function loadeclaim(){
        $scope.loading();
        var data = {
            params: {
                "Type": "CLAIMED_EXPENSE",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Claimrequest_Tourgid": $scope.tour_gid
                        }
                    }
                }
            }
        }
        var get_eclaim = eclaimService.ecalim_drop_get(data)
        get_eclaim.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.files = result.data.FILE;
            if($scope.files.length != 0){
                $scope.db_file = true;
                $scope.view_image = false;
            }
            else{
                $scope.db_file = false;
                $scope.view_image = true;
            }
            if(result.data.MESSAGE == "NOT_FOUND" ){
                angular.forEach($scope.base, function(item1) {
                       $scope.eClaim_tavels.push(item1);
                    });

                angular.forEach($scope.eClaim_tavels, function(item1) {
                    $scope.expense_type = $filter('filter')($scope.expense_type, function(value) {
                        return value.name != item1.description;
                    });
                });
            }
            else{
                $scope.eClaim_tavels = $scope.main;
                $scope.invoiceheadergid = $scope.eClaim_tavels[0].invoiceheadergid;
                $scope.datarelaxation_status = $scope.eClaim_tavels[0].datarelaxation_status;
                if($scope.eClaim_tavels[0].approvedby != 0){
                    $scope.searchbr = $scope.eClaim_tavels[0].forwarder_branch;
                    $scope.searchbr_data = $scope.eClaim_tavels[0].forwarder_branch;
                    $scope.searchemp = $scope.eClaim_tavels[0].forwarder_name;
                    $scope.searchemp_data = $scope.eClaim_tavels[0].forwarder_name;
                    $scope.comments = $scope.eClaim_tavels[0].appcomment;
                    $scope.selectempdata = $scope.eClaim_tavels[0].approvedby;
                }
                var dd = {
                    "employee_gid" :$scope.eClaim_tavels[0].approvedby
                }
<!--                $scope.selectedemp = dd;-->
                angular.forEach($scope.eClaim_tavels, function(item1) {
                    $scope.base = $filter('filter')($scope.base, function(value) {
                        return value.expsensecode != item1.expsensecode;
                    });
                });
                if($scope.base.length != 0){
                    angular.forEach($scope.base, function(item1) {
                       $scope.eClaim_tavels.push(item1);
                    });
                }

                angular.forEach($scope.eClaim_tavels, function(item1) {
                    $scope.expense_type = $filter('filter')($scope.expense_type, function(value) {
                        return value.name != item1.description;
                    });
                });

                $scope.total_eligamount = 0;
                $scope.total_claimamount = 0;
                $scope.total_approveamount = 0;
                angular.forEach($scope.eClaim_tavels, function(item1) {
                    $scope.total_eligamount = $scope.total_eligamount + item1.eligibleamount;
                    $scope.total_claimamount = $scope.total_claimamount + item1.claimedamount;
                    $scope.total_approveamount = $scope.total_approveamount + item1.approvedamount;
                    $scope.advanceamount = item1.advanceamount;
                    if(item1.description == "Daily Diem" || item1.description == "Lodging"
                        || item1.description == "Packaging/Freight"){
                            if($scope.files.length == 0){
                                $scope.file_required = true;
                            }
                    }

                });
                $scope.net_amount = Math.abs($scope.total_approveamount - $scope.advanceamount);
                $scope.data_len = $scope.eClaim_tavels.length;
                $scope.pageLength = $scope.eClaim_tavels.length;
                $scope.Totalpages = Math.ceil($scope.eClaim_tavels.length / $scope.itemsPerPage)    ;
            }
        }).finally($scope.endloading);
    }

    $scope.attachment = function(){
         $scope.loading_popup_img();
         if($scope.files.length != 0){
            angular.forEach($scope.files, function(item1) {
                var name = item1.file_name.split('.');
                if(name[1] == "pdf" || name[1] == "PDF" ){
                    complete_url ='http://docs.google.com/gview?url=' + encodeURIComponent(item1.file_path) + '&embedded=true';
                    //Using a function of the library $sce called trustAsResourceUrl()
                    item1.file_url = $sce.trustAsResourceUrl(complete_url);
                    item1.type = "pdf";
                }
                else{
                    item1.type = "image";
                }
            });

         }
         else{
            alert("No Document..");
         }
         $scope.endloading();
         var model = modalshow('attach_view');
    }

    $scope.stepsModel = [];
    $scope.filenames = [];
    $scope.files = [];

    $scope.imageUpload = function(event){
         var files = event.target.files; //FileList object

         for (var i = 0; i < files.length; i++) {
             var file = files[i];
                 var reader = new FileReader();
                 reader.onload = $scope.imageIsLoaded;
                 reader.readAsDataURL(file);
                 if($scope.files.length != 0){
                    if(file.name != $scope.files.file_name){
                        $scope.filenames.push(file);
                        $scope.file_required = false;
                    }
                    else{
                        alert("File Already Uploaded")
                    }
                 }
                 else{
                    $scope.filenames.push(file);
                    $scope.file_required = false;
                 }
         }
    }

    $scope.remove_image = function(i) {
        $scope.stepsModel.splice(i, 1);
        $scope.filenames.splice(i, 1);
    }

    $scope.remove_allimage = function(i) {
        $scope.stepsModel = [];
        $scope.filenames =[];
    }

    $scope.imageIsLoaded = function(e){
        $scope.$apply(function() {
            $scope.stepsModel.push(e.target.result);
        });
    }
    $scope.viewimage = function(){
        var model = modalshow('imdiate_view');
    }
    $scope.clear_image = function(e){
        event.target.files.pop(e);
    }

    $scope.open_file = function(e){
        if(e.type == "pdf" || e.type == "PDF"){
            complete_url ='http://docs.google.com/gview?url=' + encodeURIComponent(e.file_path) + '&embedded=true';
            //Using a function of the library $sce called trustAsResourceUrl()
            $scope.file_file_url = $sce.trustAsResourceUrl(complete_url);
            $scope.file_type = e.type;
            $scope.file_file_name = e.file_name;
            var model = modalshow('attach_view_single');
        }
        else {
            $scope.file_file_path = e.file_path;
            $scope.file_type = e.type;
            $scope.file_file_url = e.file_url;
            $scope.file_file_name = e.file_name;
            var model = modalshow('attach_view_single');
        }

    }

    $scope.add = [];
    $scope.save = function(eclaim) {
        if(eclaim.purpose_name != undefined && eclaim.purpose_code != undefined ){
            $scope.master_data(eclaim);
        }
        else{
            error_toast(no_data,time_toast);
            return false;
        }
   };
   $scope.make_expense=function(detail){
            $scope.Invoice_detail = detail;
            var eClaim_session = {
                tour_gid: detail.tourrequest_tourgid,
                tour_no: detail.tourrequest_tourrequestno,
                tour_requestdate: detail.tourrequest_tourrequestdate,
                emp_name: detail.employee_name,
                designation: detail.designation_name,
                emp_grade: detail.tourrequest_empgrade,
            };
            sessionStorage.setItem('eClaim', JSON.stringify(eClaim_session));
            $window.location.href = "ECF_billentry_checker";
        }

   $scope.selectempchange = function(e){
        $scope.selectempdata = e.employee_gid
   }


   $scope.keepGoing = true;
   $scope.submit_data = function(){
        $scope.files_len = $scope.filenames.length;
        angular.forEach($scope.eClaim_tavels, function(item1) {
            if($scope.keepGoing) {
                if(item1.description == "Daily Diem" || item1.description == "Lodging"
                || item1.description == "Packaging/Freight"){
                    if($scope.claim_status == "RETURN"){
                        if($scope.files.length != 0){
                            $scope.submit_data_next();
                            $scope.keepGoing = false;
                        }
                        else{
                            alert("Please attach File")
                        }
                    }
                    else{
                        if($scope.files_len != 0){
                            $scope.submit_data_next();
                            keepGoing = false;
                        }
                        else{
                            alert("Please attach File")
                        }
                    }
                }
                else{
                        $scope.submit_data_next();
                }
            }
        });
   }
   $scope.submit_data = function(){
   if($scope.CCBS.length !=0){
        var sum = 0;
        angular.forEach($scope.CCBS, function(item1) {
            sum = parseFloat(sum) + parseFloat(item1.amount);
        });
        if (sum != $scope.total_claimamount){
            alert("CCBS Amount not matched");
            return 0;
        }
        if($scope.claim_status == "NEW" || $scope.claim_status == "REQUESTED" || $scope.claim_status == "RETURN" && $scope.CCBS.length !=0){
            $scope.loading();
            var img = new FormData();
            for(i = 0; i < $scope.filenames.length; i++){
                   var file_img = $scope.filenames[i]
                   var filename = file_img.name
                   var index = filename.lastIndexOf(".");
                   $scope.strsubstring = filename.substring(index, filename.length);
                   if($scope.strsubstring ==".jpg" || $scope.strsubstring ==".jpeg" || $scope.strsubstring ==".png" || $scope.strsubstring ==".pdf" || $scope.strsubstring ==".PDF"){
                        img.append('file'+i, file_img);
                        img.append('fileext'+i, $scope.strsubstring);
                    }
            };
            var ccbs_details = JSON.stringify($scope.CCBS);
            var advanceadjust = JSON.stringify($scope.advanceadjust_data);
            img.append("Type", "MOVE_APPROVE");
            img.append("tourgid", $scope.tour_gid);
            img.append("approvedby", $scope.selectempdata);
            img.append("appcomment", $scope.comments);
            img.append("status", "PENDING");
            img.append("apptype", "CLAIM");
            img.append("CCBS", ccbs_details);
            img.append("ADVANCE", advanceadjust);
            img.append("applevel", "1");
            $scope.keepGoing = false;
                var eclaim_daily = eclaimService.ecalim_withimg(img);
                eclaim_daily.then(function(result) {
                    $scope.set_msg = result.data.MESSAGE
                    if($scope.set_msg == 'SUCCESS' ){
                        $scope.keepGoing = false;
                        success_toast();
                        $window.location.href = "eClaim/eclaim_expense_request";
                    }
                    else{
                        alert($scope.set_msg);
                    }
                }).finally($scope.endloading);
            }
            else{
                alert("Cannot Submit...")
            }
        }
        else{
            alert("CCBS Missing")
        }
    }

    $scope.paystatus = false;
    $scope.paymentstatus = function(){
        $scope.loading();
        var data = {
            params: {
                "Type": "PAYMENT_STATUS",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Invoice_Header_Gid":$scope.invoiceheadergid
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.invoiceheader_status = $scope.main[0].invoiceheader_status;
            $scope.paystatus = true;

         }).finally($scope.endloading);
    }

    $scope.get_approval_data = [];
    loadapprovalflow();
    function loadapprovalflow(){
        var data = {
            params: {
                "Type": "APPROVAL_FLOW",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "TourGid":$scope.tour_gid,
                            "AppType":"CLAIM"
                        }
                    }
                }
            }
        }
        var eclaim_daily = eclaimService.ecalim_drop_get(data);
        eclaim_daily.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_approval_data = $scope.main;
            if(result.data.MESSAGE != "NOT_FOUND"){
                $scope.get_approval_data = $scope.main;
                $scope.approvaldata = true;
            }
            else {
                $scope.approvaldata = false;

            }
        }).finally($scope.endloading);
    }


    $scope.submit_amount = function(e){
        var data = {
            params: {
                "Type": "ADVANCE_ADJUST",
                "json" : {
                    "Params": {
                        "DETAILS": {
                            "advance_gid":e.advancegid,
                            "ppx_headergid":e.ppxheader_gid,
                            "adjustamount":e.adjustamount
                        },
                    }
                }
            }
        }
        var get_drop = eclaimService.expense_process_set(data)
        get_drop.then(function(result) {
            $scope.set_msg = result.data.MESSAGE
                if($scope.set_msg == 'SUCCESS' ){
                    success_toast();
                    $window.location.reload();
                    $scope.claim_status == "NEW";
                }
                else{
                    alert($scope.set_msg);
                }
        });
    }


    $scope.advanceadjust_data = [];
    advance_adjust();
    function advance_adjust(){
        var data = {
            params: {
                "Type": "AP_ADVANCE",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "TourGid":$scope.tour_gid,
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
<!--            $scope.advanceadjust_data = $scope.main;-->
            if(result.data.MESSAGE == "FOUND"){
                $scope.advanceadjust_data = $scope.main;
<!--                angular.forEach($scope.advanceadjust_data, function(item1) {-->
<!--                    item1.adjustamount = '';-->
<!--                });-->
                $scope.advanceadjust = true;
            }
            else {
                $scope.advanceadjust_data = [];
                $scope.advanceadjust = false;
            }
        });
    }


    $scope.get_pdf = function(e){
     $scope.loading();
        var datas={"params":{
                        "filter":{
                            "action":"GET",
                            "type":"BARCODE_GENERATION",
                            "InvoiceHeader_Gid": $scope.invoiceheadergid
                        }
                    }
                };
        var summary = eclaimService.get_ecf_data(datas);
        summary.then(function(result) {
                 var data = result.data;
                 var file = new Blob([data], { type: 'application/pdf' });
                 saveAs(file, 'Claims.pdf');
            }).finally($scope.endloading);
     }
    $scope.CCBS = [];
    ccbs_data();
    function ccbs_data(){
        var data = {
            params: {
                "Type": "CCBS_GET",
                "json" : {
                    "Params": {
                        "FILTER": {
                            "Tour_Gid":$scope.tour_gid,
                            "CCBS_Type":"2"
                        }
                    }
                }
            }
        }
        var get_drop = eclaimService.ecalim_drop_get(data)
        get_drop.then(function(result) {
            $scope.main = result.data.DATA;
            if(result.data.MESSAGE == "NOT_FOUND" ){
                $scope.CCBS = [];
            }
            else{
                $scope.CCBS = $scope.main;
            }
        });
    }

    $scope.arr_index = '';
    $scope.add_asset = false;
    $scope.add_ccbs = function(){
        $scope.choices_ccbs = [];
        if($scope.total_claimamount != 0){
            $scope.claimamount = $scope.total_claimamount;
                if($scope.CCBS.length == 0){
                    $scope.choices_ccbs = [{
                    gid:0,
                    amount:"",
                    percentage:""}];
                    modalshow('viewmodals');
                }
                else{
                    angular.forEach($scope.CCBS, function(item2) {
                        $scope.choices_ccbs.push(item2);
                    });
                    modalshow('viewmodals');
                }
            }
    }

    bsdata();
    function bsdata(){
        var data = {
            params: {
                "Type": "BS",
                "json" : {

                    }
                }
            }
        var get_bs_data = eclaimService.ecalim_drop_get(data)
            get_bs_data.then(function(result) {
                $scope.main = result.data.DATA;
<!--                $scope.get_bs = $scope.main;-->
                $scope.get_bs = $filter('filter')($scope.main, function(value) {
                    return value.bs_name !== "GST";
                });

            })
    }
    $scope.querySearchcc = gotocc;
    function gotocc(query) {
        var result = $filter('filter')($scope.get_cc, {
            'cc_name': query
        });
        return result;
    }

    $scope.ccchange = function(cc,choice){
        choice.ccgid = cc.cc_gid;
    }
    $scope.bschange = function(bs,choice){
        var data = {
            params: {
                "Type": "CC",
                "json" : {
                    "Bs_gid": bs.bs_gid
                    }
                }
            }
        var get_cc_data = eclaimService.ecalim_drop_get(data)
        get_cc_data.then(function(result) {
            $scope.main = result.data.DATA;
            $scope.get_cc = $scope.main;
            choice.bsgid = bs.bs_gid;
        })
        return $scope.get_cc;
    }

    $scope.querySearchbs = gotobs;
    function gotobs(query) {
        var result = $filter('filter')($scope.get_bs, {
            'bs_name': query
        });
        return result;
    }

    $scope.percen_calc = function(i,v){
        var value = (v / $scope.claimamount)*100;
        $scope.choices_ccbs[i].percentage = value;
    }

    $scope.amount_calc = function(i,v){
        var value = (v /100)* $scope.claimamount;
        $scope.choices_ccbs[i].amount = value;
    }
    $scope.removeChoice = function() {
        var lastItem = $scope.choices.length-1;
        $scope.choices_ccbs.splice(lastItem);
        $scope.add_asset = false;
    };
    $scope.addNewChoice = function() {
        var sum = 0;
        for (i = 0; i < $scope.choices_ccbs.length; i++) {
            sum = parseFloat(sum) + parseFloat($scope.choices_ccbs[i].amount);
        }
            if (sum > $scope.claimamount){
                $scope.add_asset = true;
                var len = $scope.choices_ccbs.length - 1;
                $scope.choices_ccbs[len].amount ="";
                $scope.choices_ccbs[len].percentage ="";
                warning_toast(not_matched,time_toast);
            }
            else if(sum < $scope.claimamount){
                var newItemNo = $scope.choices_ccbs.length+1;
                $scope.len_asset = $scope.len_asset + 1;
                $scope.choices_ccbs.push({
                gid:0,
                amount:"",
                percentage:""});
            }
            else if(sum == $scope.claimamount){
                $scope.enable_update = false;
                $scope.reason = true;
            }
            else {
               error_toast(no_data,time_toast);
            }
    };

    $scope.ccbs_save = function(){
        var sum = 0;
        for (i = 0; i < $scope.choices_ccbs.length; i++) {
            sum = parseFloat(sum) + parseFloat($scope.choices_ccbs[i].amount);
        }
            if (sum == $scope.claimamount){
                $scope.CCBS = [];
                angular.forEach($scope.choices_ccbs, function(item1) {
                    var data = {
                        "gid":item1.gid,
                        "type":"2",
                        "ccgid":item1.ccgid,
                        "bsgid":item1.bsgid,
                        "percentage":item1.percentage,
                        "amount":item1.amount
                    }

                     $scope.CCBS.push(data);
                });
                success_toast();
                modalhide('viewmodals');
            }
            else{
                error_toast(no_data,time_toast);
            }
    }
    $scope.remove_file = function(e) {
        if(e.file_gid != 0){
            var data = {
                params: {
                    "Type": "FILE_DELETE",
                    "json" : {
                        "Params": {
                            "FILTER": {
                                 "file_gid": e.file_gid
                            }
                        }
                    }
                }
            }
            var eclaim_daily = eclaimService.expense_process_set(data);
            eclaim_daily.then(function(result) {
                $scope.set_msg = result.data.MESSAGE
                if($scope.set_msg == 'SUCCESS' ){
                    success_toast();
                    $window.location.reload();
                }
                else{
                    alert($scope.set_msg);
                }
            });
        }
    }


});
myApp.service("eclaimService", function($http) {
    this.ecalim_drop_get = function(data) {
        var response = $http.get(Appname + "/eclaim_dropdata/",data);
        return response;
    }

    this.ecalim_withimg = function(data) {
        var response = $http.post(Appname + "/eclaim_withfile_set/",data, {
                transformRequest: angular.identity,
                headers: {
                    'Content-Type': undefined
                }
            });
        return response;
    }

    this.get_ecf_data = function(data) {
        var response = $http.post(Appname + "/ecf_data_get/",data);
        return response;
    }

    this.expense_process_set = function(data) {
        var response = $http.post(Appname + "/eclaim_process_set/",data);
        return response;
    }
    this.ecalim_session_get = function(data) {
        var response = $http.post(Appname + "/session_get_expnese/",data);
        return response;
    }

});

myApp.directive("preventTypingGreater", function() {
  return {
    link: function(scope, element, attributes) {
      var oldVal = null;
      element.on("keydown keyup", function(e) {
    if (Number(element.val()) > Number(attributes.max) &&
          e.keyCode != 46 // delete
          &&
          e.keyCode != 8 // backspace
        ) {
          e.preventDefault();
          element.val(oldVal);
        } else {
          oldVal = Number(element.val());
        }
      });
    }
  };
});




















</script>

{% endblock %}