{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} Ticket Followup {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}

<div class="maincontent">
    <div ng-app="App_maker_summary" ng-controller="Ctrl_followup" class="container container1">
        <div class="row">
            <div class="row-header col-ms-12 col-sm-12">
                <h4>Ticket Followup </h4>
            </div>
        </div>
        </br>

        <div class="row">
            <div class="col-md-12">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <h5>Ticket Followup Details</h5>
                                </div>
                                <!-- /.panel-heading -->
                                <div class="panel-body">

                                    <div class="col-lg-5">
                                        <div class="row">
                                            <h5>Ticket Code</h5>
                                            <input type="text" class="form-control" ng-model="ticketheader_code"
                                                   disabled>
                                        </div>
                                        <div class="row">
                                            <h5>Branch Name</h5>
                                            <input type="text" class="form-control" ng-model="branch_name" disabled>
                                        </div>
                                        <div class="row">
                                            <h5>Problem Description</h5>
                                            <textarea rows="8" cols="62" name="comment"
                                                      disabled>{{ticketheader_description}}</textarea>
                                        </div>

                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-lg-5">
                                        <div class="row">
                                            <h5>Problem</h5>
                                            <input type="text" class="form-control" ng-model="ticketheader_summary"
                                                   disabled>
                                        </div>
                                        <div class="row">
                                            <h5>Nature Of The Problem</h5>
                                            <input type="text" class="form-control" ng-model="errorcategory_name"
                                                   disabled>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <md-input-container class="md-block inputcontainer">
                                                    <label>Engineer Name</label>
                                                    <input ng-model="track_engineername" ng-disabled="!editable"/>
                                                </md-input-container>
                                            </div>
                                            <div class="col-md-1" style="top:10px;">
                                                <md-button class="md-raised" ng-click="edits()">Edit
                                                </md-button>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <md-input-container class="md-block inputcontainer">
                                                    <label>Visiting Date</label>
                                                    <md-datepicker md-hide-icons="calendar"
                                                                   ng-model="track_visitdate"
                                                                   md-hide-icons="calendar" ng-click="date"
                                                                   md-min-date="maxDate"
                                                                   md-max-date="minDate" formatDate
                                                                   ng-disabled="!editable"></md-datepicker>
                                                </md-input-container>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <label><h5>Visiting Time:</h5></label>
                                                <input type="time" id="vist_time" ng-disabled="!editable"
                                                       placeholder="hh:mm:ss">
                                            </div>

                                        </div>
                                        <!--                                        <div class="row">-->
                                        <!--                                            <div class="col-md-10">-->
                                        <!--                                                <md-input-container class="md-block inputcontainer">-->
                                        <!--                                                    <label>Phone Number</label>-->
                                        <!--                                                    <input ng-model="phone" ng-disabled="!editable"/>-->
                                        <!--                                                </md-input-container>-->
                                        <!--                                            </div>-->
                                        <!--                                        </div>-->
                                    </div>

                                </div>
                                <!-- /.panel-body -->
                            </div>
                            <!-- /.panel -->
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-md-12">
                <div class="col-md-12">
                    <div class="panel-group">

                        <div class="panel panel-primary">
                            <div class="panel-heading">Ticket Follwups</div>

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a href="#content-2" data-toggle="collapse" data-parent="#accordion">Click to
                                            View-Follow-Ups</a>
                                    </h4>
                                </div>
                                <div class="panel-collapse collapse" id="content-2">
                                    <div class="panel-body followups">
                                        <ul class="timeline" ng-repeat="track in followup_all_data_summary">
                                            <!--                                            <ul class="timeline" ng-repeat="tra in track.followupdetail">-->
                                            <li ng-if="$even">

                                                <div class="timeline-badge">
                                                    <i class="glyphicon glyphicon-check"></i>
                                                </div>
                                                <div class="timeline-panel">
                                                    <div ng-repeat="tra in track.followupdetail">
                                                        <div class="timeline-body">
                                                            <p>{{tra.metadata_value}}</p>
                                                        </div>
                                                        <div class="timeline-heading">
                                                            <h4 ng-if="tra.metadata_value!='FILE'"
                                                                class="timeline-title">{{tra.metadata_data}}</h4>
                                                            <h4 ng-if="tra.metadata_value=='FILE'"
                                                                class="timeline-title">
                                                                <a href="{{tra.metadata_data}}">Atached File</a>
                                                            </h4>

                                                        </div>
                                                    </div>
                                                    <p><small class="text-muted">
                                                        <i class="glyphicon glyphicon-time"></i>
                                                        {{track.followupdate}}</small></p>
                                                </div>
                                            </li>
                                            <li class="timeline-inverted" ng-if="$odd">
                                                <div class="timeline-badge warning"><i
                                                        class="glyphicon glyphicon-credit-card"></i></div>
                                                <div class="timeline-panel">
                                                    <div ng-repeat="tra in track.followupdetail">
                                                        <div>
                                                            <div class="timeline-body">
                                                                <p>{{tra.metadata_value}}</p>
                                                            </div>
                                                            <div class="timeline-heading">
                                                                <h4 ng-if="tra.metadata_value!='FILE'"
                                                                    class="timeline-title">{{tra.metadata_data}}</h4>
                                                                <h4 ng-if="tra.metadata_value=='FILE'"
                                                                    class="timeline-title">
                                                                    <a href="{{tra.metadata_data}}">Atached File</a>
                                                                </h4>

                                                            </div>
                                                        </div>
                                                        <p><small class="text-muted">
                                                            <i class="glyphicon glyphicon-time"></i>
                                                            {{track.followupdate}}</small></p>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="col-md-12">
                    <div class="panel-group">

                        <div class="panel panel-primary">
                            <div class="panel-heading">Assets</div>

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a href="#content-3" data-toggle="collapse" data-parent="#accordion">Click to
                                            View-Asset Details</a>
                                    </h4>
                                </div>
                                <div class="panel-collapse collapse" id="content-3">
                                    <div class="panel-body followups">
                                        <div class="row table-responsive">
                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                                       md-progress="deferred">
                                                    <thead class="header">
                                                    <tr align="center" style="background-color:#55aa7f;">
                                                        <th>S.NO</th>
                                                        <th>Asset ID</th>
                                                        <th>Asset Name</th>

                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr ng-repeat="ts in asset_data.slice(((currentPage-1)*itemsPerPage),((currentPage)*itemsPerPage)) | filter:search:strict"
                                                        align="center">
                                                        <td>
                                                            <center>{{((currentPage-1)*itemsPerPage)+$index+1}}
                                                            </center>
                                                        </td>
                                                        <td>{{ts.assetdetails_id}}</td>
                                                        <td>{{ts.product_name}}</td>
                                                    </tr>
                                                    </tbody>
                                                    <tfoot>
                                                    <tr>
                                                        <td colspan="2">
                                                            <ul uib-pagination total-items="asset_data.length"
                                                                ng-model="currentPage"
                                                                max-size="maxSize"
                                                                class="pagination-sm" boundary-links="true"
                                                                items-per-page="itemsPerPage"></ul>
                                                        </td>
                                                        <td colspan="2">
                                                            Total Count:{{asset_data.length}}
                                                        </td>
                                                    </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="col-md-12">
                    <div class="panel-group">

                        <div class="panel panel-primary">
                            <div class="panel-heading">PR Creation</div>

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a href="#content-4" data-toggle="collapse" data-parent="#accordion">
                                            Click-To-Create-PR</a>
                                    </h4>
                                </div>
                                <div class="panel-collapse collapse" id="content-4">
                                    <div class="panel-body followups">
                                        <div class="row table-responsive">
                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                <div class="col-md-10"></div>
                                                <div class="col-md-1">
                                                    <a title="View Assets" ng-click="create_pr()" align="center"
                                                       data-toggle="modal"
                                                       data-target="#view_pr"
                                                       style='cursor: pointer; text-decoration:none;'>
                                                        <md-button class="md-fab md-mini md-warn" ng-click="amc_add()">
                                                            <md-icon>add</md-icon>
                                                            <md-tooltip>Create PR</md-tooltip>
                                                        </md-button>
                                                    </a>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <form method="post" enctype="multipart/form-data">
                <div class="col-md-12">
                    <div class="jumbotron" style="background-color:#f2f3ff;">
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Respond this Ticket</h4>
                                <h5>Comments</h5>
                                <textarea rows="8" cols="70" name="comment" ng-model="comments"></textarea>
                                <h5>Give New Status</h5>
                                <div class="row">

                                    <md-input-container class="md-block inputcontainer">
                                        <md-radio-group layout="row" ng-change="check_radio()"
                                                        ng-model="ticketheader_status">
                                            <md-radio-button value="open">Open</md-radio-button>
                                            <md-radio-button value="reopen">Reopen</md-radio-button>
                                            <md-radio-button value="close ticket">Close Ticket</md-radio-button>
                                            <md-radio-button value="duplicated ticket">Duplicated Ticket
                                            </md-radio-button>
                                        </md-radio-group>
                                    </md-input-container>

                                </div>
                                <br/>
                                <div class="row">
                                    <div class="col-md-6">
                                        <md-autocomplete
                                                md-clear-button="true"
                                                md-floating-label="Change Owner"
                                                md-input-maxlength=126
                                                md-item-text="itemc.employee_name"
                                                md-items="itemc in getemployee_Name(searchemp)"
                                                md-selected-item-change="EmpChanged(itemc.employee_gid)"
                                                md-min-length=0
                                                md-search-text="searchemp"
                                                ng-model="itemc.employee_name"
                                                ng-value="ticketheader_assignedto"
                                                md-no-cache="true"
                                                size="5"
                                                md-selected-item="itemc.employee_name">
                                            <md-item-template>
                                                <span md-highlight-text="searchTex"> {{itemc.employee_name}}</span>
                                            </md-item-template>
                                            <md-not-found>
                                                No Employee Name matching "{{search Employee}}" were
                                                found.
                                            </md-not-found>
                                        </md-autocomplete>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="col-md-3" style="margin-top: 35px;">
                                            <input class="ng-isolate-scope" file-model="files"
                                                   fileinput="file"
                                                   id="file"
                                                   multiple
                                                   type="file"/>
                                        </div>

                                    </div>

                                </div>
                            </div>
                            <!--                            <div class="col-md-6">-->
                            <!--                                <div class="tab-content">-->
                            <!--                                    <div class="tab-pane active" id="home">-->
                            <!--                                        <div class="row">-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <md-input-container class="md-block inputcontainer">-->
                            <!--                                                    <label>Engineer Visited</label>-->
                            <!--                                                </md-input-container>-->
                            <!--                                            </div>-->
                            <!--                                            <div class="col-md-6">-->
                            <!--                                                <md-select placeholder="Engineer Visted" ng-model="visited">-->
                            <!--                                                    <md-option value="Yes">Yes</md-option>-->
                            <!--                                                    <md-option value="No">No</md-option>-->
                            <!--                                                </md-select>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->
                            <!--                                        <div class="row" ng-show="visited == 'No'">-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <md-input-container class="md-block inputcontainer">-->
                            <!--                                                    <label>123</label>-->
                            <!--                                                    <input ng-model="ticket" disabled/>-->
                            <!--                                                </md-input-container>-->
                            <!--                                            </div>-->

                            <!--                                            <div class=col-md-3" style="margin-top:25px">-->
                            <!--                                                <md-checkbox ng-model="do">Send Mail to Do</md-checkbox>-->
                            <!--                                                <md-checkbox ng-model="vendor">Send Mail to Vendor</md-checkbox>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->
                            <!--                                        <div class="row" ng-show="visited == 'No'">-->
                            <!--                                            <div class="col-md-3 col-md-offset-3    ">-->
                            <!--                                                <button type="button" class="btn btn-primary">Send Mail to Do/Vendor-->
                            <!--                                                </button>-->
                            <!--                                            </div>-->

                            <!--                                        </div>-->

                            <!--                                        <div class="row" ng-show="visited == 'Yes'">-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <md-input-container class="md-block inputcontainer">-->
                            <!--                                                    <label>Problem Resolved</label>-->
                            <!--                                                </md-input-container>-->
                            <!--                                            </div>-->
                            <!--                                            <div class="col-md-6">-->
                            <!--                                                <md-select placeholder="Problem Solved" ng-model="solved">-->
                            <!--                                                    <md-option value="Yes">Yes</md-option>-->
                            <!--                                                    <md-option value="No">No</md-option>-->
                            <!--                                                </md-select>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->
                            <!--                                        <div class="row" ng-show="solved=='Yes'" ng-if="visited=='Yes'">-->
                            <!--                                            <div class="col-md-8">-->
                            <!--                                                <md-input-container class="md-block inputcontainer">-->
                            <!--                                                    <label>Remarks</label>-->
                            <!--                                                    <input ng-model="remarks" maxlength="250"/>-->
                            <!--                                                </md-input-container>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->
                            <!--                                        <div class="row" ng-show="solved=='Yes'" ng-if="visited=='Yes'">-->
                            <!--                                            <div class=col-md-3" style="margin-top:25px">-->
                            <!--                                                <md-checkbox ng-model="manager">Resolved by under Manager Power-->
                            <!--                                                </md-checkbox>-->
                            <!--                                                <md-checkbox ng-model="do_solved">Send Mail to Do</md-checkbox>-->
                            <!--                                            </div>-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <md-button class="md-raised custbutton" value="submit"-->
                            <!--                                                           ng-click="">-->
                            <!--                                                    Submit and Close Ticket-->
                            <!--                                                </md-button>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->
                            <!--                                        <div class="row" ng-show="solved=='No'" ng-if="visited=='Yes'">-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <md-input-container class="md-block inputcontainer">-->
                            <!--                                                    <label>Escalate To</label>-->
                            <!--                                                </md-input-container>-->
                            <!--                                            </div>-->
                            <!--                                            <div class="col-md-6">-->
                            <!--                                                <md-select placeholder="Escalate To" ng-model="types"-->
                            <!--                                                           ng-change="change_tyeps(types)">-->
                            <!--                                                    <md-option value=Do>DO</md-option>-->
                            <!--                                                    <md-option value="Manager">Manager</md-option>-->
                            <!--                                                </md-select>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->
                            <!--                                        <div class="row" ng-show="types == 'Do'" ng-if="solved=='No' && visited=='Yes'">-->
                            <!--                                            <div class=col-md-3" style="margin-top:25px">-->
                            <!--                                                <md-checkbox ng-model="manager">Send Mail to DO-->
                            <!--                                                </md-checkbox>-->
                            <!--                                                <md-checkbox ng-model="do_solved">Send Mail To Vendor</md-checkbox>-->
                            <!--                                            </div>-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <div class="col-md-3 col-md-offset-3    ">-->
                            <!--                                                    <button type="button" class="btn btn-info">Send Mail to Do/Vendor-->
                            <!--                                                    </button>-->
                            <!--                                                </div>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->

                            <!--                                        <div class="row" ng-show="types == 'Manager'"-->
                            <!--                                             ng-if="solved=='No' && visited=='Yes'">-->
                            <!--                                            <div class=col-md-3" style="margin-top:25px">-->
                            <!--                                                <md-checkbox ng-model="manager">Send Mail to Manger</md-checkbox>-->
                            <!--                                                <md-checkbox ng-model="do_solved">Send Mail to Vendor-->
                            <!--                                                </md-checkbox>-->
                            <!--                                            </div>-->
                            <!--                                            <div class="col-md-3">-->
                            <!--                                                <div class="col-md-3 col-md-offset-3    ">-->
                            <!--                                                    <button type="button" class="btn btn-info">Send Mail to Do and-->
                            <!--                                                        Manger-->
                            <!--                                                    </button>-->
                            <!--                                                </div>-->
                            <!--                                            </div>-->
                            <!--                                        </div>-->

                            <!--                                    </div>-->
                            <!--                                </div>-->
                            <!--                            </div>-->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="col-md-2 col-md-offset-5">
                                <md-button class="md-raised" ng-click="update_click1()">Update
                                </md-button>
                            </div>
                            <div class="col-md-2">
                                <a href="ServiceManagement/SM_Ticket_Summary/">
                                    <md-button class="md-raised md-warn" value="close"
                                               aria-label="Close">Cancel
                                    </md-button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="modal fade" id="view_pr" tabindex="-1" role="dialog" data-backdrop="static"
                 data-keyboard="false"
                 aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                PR Creation
                                <button type="button" class="close" data-dismiss="modal" ng-click="close_pr_popup()"
                                        aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                        <div class="body">

                            <form class="modal-body popup-body" name="pr_creation" novalidate>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose BS"
                                                    md-input-maxlength=126
                                                    md-item-text="itemc.tbs_name"
                                                    md-items="itemc in getbs(searchBS)"
                                                    md-selected-item-change="bsChanged(itemc.tbs_gid)"
                                                    md-min-length=0
                                                    md-search-text="searchBS"
                                                    ng-model="itemc"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itemc.tbs_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchTex"> {{itemc.tbs_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No BS Name matching "{{search BS}}" were
                                                    found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose CC"
                                                    md-input-maxlength=126
                                                    md-item-text="item.tcc_name"
                                                    md-items="item in getcc(searchCC)"
                                                    md-selected-item-change="ccChanged(item.tcc_gid)"
                                                    md-min-length=0
                                                    md-search-text="searchCC"
                                                    ng-model="item"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="item.tcc_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchTex"> {{item.tcc_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No CC Name matching "{{search CC}}" were
                                                    found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose Product Category"
                                                    md-input-maxlength=126
                                                    md-item-text="itemp.productcategory_name"
                                                    md-items="itemp in getProductCategory(searchProCat)"
                                                    md-selected-item-change="ProductCategoryChanged(itemp.productcategory_gid)"
                                                    md-min-length=0
                                                    md-search-text="searchProCat"
                                                    ng-model="itemp"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itemp.productcategory_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchProCat"> {{itemp.productcategory_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Product Category Name matching "{{search Product
                                                    Category}}"
                                                    were
                                                    found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>
                                        <div class="col-md-2" style="margin-top:25px">
                                            <md-checkbox ng-model="dts_selected"
                                                         ng-change="Changed_dts(dts_selected)">DTS
                                            </md-checkbox>
                                        </div>

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose Product Category Type"
                                                    md-input-maxlength=126
                                                    md-item-text="itempt.producttype_name"
                                                    md-items="itempt in getProductCategoryType(searchProCatType)"
                                                    md-selected-item-change="ProductCategoryTypeChanged(itempt.producttype_productcategory_gid)"
                                                    md-min-length=0
                                                    md-search-text="searchProCatType"
                                                    ng-model="itempt"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itempt.producttype_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchProCatType"> {{itempt.producttype_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Product Category Type Name matching "{{search Product
                                                    Category Type}}"
                                                    were found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>

                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose Product Name"
                                                    md-input-maxlength=126
                                                    md-item-text="itempn.product_name"
                                                    md-items="itempn in getProductName(searchProName)"
                                                    md-selected-item-change="ProductNameChanged(itempn.product_gid)"
                                                    md-min-length=0
                                                    md-search-text="searchProName"
                                                    ng-model="itempn"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itempn.product_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchProName"> {{itempn.product_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Product Category Type Name matching "{{search Product
                                                    Name}}"
                                                    were
                                                    found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose Commodity Name"
                                                    md-input-maxlength=126
                                                    md-item-text="itemco.commodity_name"
                                                    md-items="itemco in getCommodity(searchCommodity)"
                                                    md-selected-item-change="CommodityChanged(itemco.commodityprod_commoditygid)"
                                                    md-min-length=0
                                                    md-search-text="searchCommodity"
                                                    ng-model="itemco"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itemco.commodity_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchCommodity"> {{itemco.commodity_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Commodity Name matching "{{search Commodity Name}}"
                                                    were
                                                    found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose Supplier Name"
                                                    md-input-maxlength=126
                                                    md-item-text="itempn.supplier_name"
                                                    md-items="itempn in getSupplierName(searchSuplierName)"
                                                    md-selected-item-change="supplierNameChanged(itempn.supplierproduct_gid)"
                                                    md-min-length=0
                                                    md-search-text="searchSuplierName"
                                                    ng-model="itempn"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itempn.supplier_name">
                                                <md-item-template>
                                                    <span md-highlight-text="searchSuplierName"> {{itempn.supplier_name}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Supplier Name matching "{{search Supplier Name}}"
                                                    were
                                                    found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-md-3">
                                            <md-autocomplete
                                                    md-clear-button="true"
                                                    md-floating-label="Choose Branch Code"
                                                    md-input-maxlength=126
                                                    md-item-text="itembr.branch_code"
                                                    md-items="itembr in getBranchCode(searchBranchCode)"
                                                    md-selected-item-change="BranchCodeChanged(itembr.branch_gid,itembr.branch_code,itembr.branch_name)"
                                                    md-min-length=0
                                                    md-search-text="searchBranchCode"
                                                    ng-model="itembr"
                                                    md-no-cache="true"
                                                    size="5"
                                                    ng-required="true"
                                                    md-selected-item="itembr.branch_code">
                                                <md-item-template>
                                                    <span md-highlight-text="searchBranchCode"> {{itembr.branch_code}}</span>
                                                </md-item-template>
                                                <md-not-found>
                                                    No Branch Code matching "{{search Code}}" were found.
                                                </md-not-found>
                                            </md-autocomplete>
                                        </div>
                                        <div class="col-md-3">
                                            <md-input-container class="md-block inputcontainer">
                                                <label>Branch Name</label>
                                                <input ng-model="pr_branch_name" disabled/>
                                            </md-input-container>
                                        </div>
                                        <div class="col-md-5">
                                            <md-input-container class="md-block inputcontainer">
                                                <label>Product Description</label>
                                                <input ng-model="pro_desc">
                                            </md-input-container>
                                        </div>


                                        <div class="col-md-1 text-right">
                                            <a>
                                                <md-button class="md-fab md-mini md-primary custbutton"
                                                           ng-disabled="pr_creation.$invalid"
                                                           value="submit"
                                                           ng-click="add_pr(searchBS,searchCC,searchProName,searchProCat,searchProCatType,searchCommodity,searchSuplierName,pro_desc)">
                                                    <md-icon>add</md-icon>
                                                    <md-tooltip>Add PR</md-tooltip>
                                                </md-button>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>

                            <form name="final_pr_form" novalidate>
                                <div class="row table-responsive">
                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                        <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                               md-progress="deferred">
                                            <thead class="header">
                                            <tr>
                                                <th>S NO</th>
                                                <th>BS</th>
                                                <th>CC</th>
                                                <th>Product Category</th>
                                                <th>Product Category Type</th>
                                                <th>Product Name</th>
                                                <th>Commdity Name</th>
                                                <th>Branch Name</th>
                                                <th>Supplier Name</th>
                                                <th>UOM</th>
                                                <th>Quantity</th>
                                                <th>Unit Price</th>
                                                <th>Amount</th>
                                                <th>Action</th>

                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr ng-repeat="pr in pr_added_values.slice(((currentPage-1)*itemsPerPage),((currentPage)*itemsPerPage)) | filter:search:strict"
                                                align="center">
                                                <td>
                                                    <center>{{((currentPage-1)*itemsPerPage)+$index+1}}</center>
                                                </td>
                                                <td>{{pr.searchBS}}</td>
                                                <td>{{pr.searchCC}}</td>
                                                <td>{{pr.searchProCat}}</td>
                                                <td>{{pr.searchProCatType}}</td>
                                                <td>{{pr.searchProName}}</td>
                                                <td>{{pr.searchCommodity}}</td>
                                                <td>{{pr.pr_branch_name}}</td>
                                                <td>{{pr.searchSuplierName}}</td>
                                                <td>{{pr.uom_name}}</td>
                                                <td style="width:150px">
                                                    <input align="right" type="text"
                                                           ng-model="pr.quantity" numbers-only
                                                           class="form-control" ng-change="getTotal()"
                                                           ng-required="true">

                                                </td>
                                                <td style="width:150px;">{{pr.sup_unit_price}}</td>
                                                <td style="width:150px;">

                                                    <md-input-container class="md-block inputcontainer">
                                                        <label style="top:-40px;" ng-value="pr.quantity*sup_unit_price"
                                                               ng-model="pr.every_values">{{pr.quantity*pr.sup_unit_price}}</label>
                                                    </md-input-container>
                                                </td>
                                                <td><a> <i class="material-icons"
                                                           ng-click="delete_column($index)">
                                                    delete
                                                </i></a></td>

                                            </tr>
                                            <tr ng-show="pr_added_values.length ==  0">
                                                <td class="warning" colspan="12">
                                                    No Records Found.
                                                </td>
                                            </tr>
                                            </tbody>
                                            <tfoot>
                                            <tr>
                                                <td colspan=12>
                                                    <ul uib-pagination total-items="pr_added_values.length"
                                                        ng-model="currentPage"
                                                        max-size="maxSize"
                                                        class="pagination-sm" boundary-links="true"
                                                        items-per-page="itemsPerPage"></ul>
                                                </td>
                                                <td colspan="2">
                                                    Total Count:{{pr_added_values.length}}
                                                </td>
                                            </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-md-8"></div>
                                        <div class="col-md-2"><h5>Total Quantity:{{total_quantity}}</h5></div>

                                        <div class="col-md-2"><h5>Total Amount:{{all_amt}}</h5></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-7"></div>
                                    <div class="col-md-2">
                                        <md-autocomplete
                                                md-clear-button="true"
                                                md-floating-label="Choose Approver"
                                                md-input-maxlength=126
                                                md-item-text="itememp.employee_name"
                                                md-items="itememp in getApprover(searchempCode)"
                                                md-selected-item-change="ApproerChanged(itememp.employee_gid,itememp.employee_code)"
                                                md-min-length=0
                                                md-search-text="searchempCode"
                                                ng-model="itememp.employee_name"
                                                ng-value="ticketheader_assignedto"
                                                md-no-cache="true"
                                                size="5"
                                                ng-required="true"
                                                md-selected-item="itememp.employee_name">
                                            <md-item-template>
                                                <span md-highlight-text="searchTex"> {{itememp.employee_name}}</span>
                                            </md-item-template>
                                            <md-not-found>
                                                No Employee Name matching "{{search Employee}}" were
                                                found.
                                            </md-not-found>
                                        </md-autocomplete>
                                    </div>
                                    <div class="col-md-2">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>Employee Code</label>
                                            <input ng-model="emp_code" disabled/>
                                        </md-input-container>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-md-2 col-md-offset-5">
                                            <md-button class="md-raised md-warn"
                                                       value="submit"
                                                       ng-click="create_new_pr()()"
                                                       ng-disabled="final_pr_form.$invalid">
                                                Create PR
                                            </md-button>
                                        </div>
                                        <div class="col-md-2">
                                            <a>
                                                <md-button class="md-raised" value="close" data-dismiss="modal"
                                                           ng-click="close_pr_popup()"
                                                           aria-label="Close">Cancel
                                                </md-button>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


{% endverbatim %}

<script>
var myApp = angular.module('App_maker_summary', ['ngMaterial','ui.bootstrap','ngMessages']).config(function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});

 myApp.run(function($mdDateLocale, $filter) {
        $mdDateLocale.formatDate = function(date) {
            return $filter('date')(date, "dd-MMM-yyyy");
        };
    })


  myApp.directive('numbersOnly', function () {
		return {
			require: 'ngModel',
			link: function (scope, element, attr, ngModelCtrl) {
				function fromUser(text) {
					if (text) {
						var transformedInput = text.replace(/[^0-9]/g, '');
						if (transformedInput !== text) {
							ngModelCtrl.$setViewValue(transformedInput);
							ngModelCtrl.$render();
						}
						return transformedInput;
					}
					return undefined;
				}
				ngModelCtrl.$parsers.push(fromUser);
			}
		};
	});


myApp.directive('fileModel', ['$parse', function ($parse) {
            return {
               restrict: 'A',
               link: function(scope, element, attrs) {
                  var model = $parse(attrs.fileModel);
                  var modelSetter = model.assign;

                  element.bind('change', function() {
                     scope.$apply(function() {
                        modelSetter(scope, element[0].files[0]);
                     });
                  });
               }
            };
         }]);

myApp.controller('Ctrl_followup', ['$scope','$http','Service_followup','$mdDialog','$window','$filter','$timeout', '$q','$mdToast',
function($scope,$http,Service_followup,$mdDialog,$window,$filter,$timeout, $q,$mdToast) {
  $scope.currentPage=1;
    $scope.maxSize=10;
    $scope.itemsPerPage=10;
    $scope.maintable = [];
    $scope.followup=[];
    $scope.update="";
    $scope.ticketheader_summary=[];
    $scope.track_gid=0;
    $scope.followupdetail="";
    $scope.pr_added_values=[];
    $scope.pr_branch_name="";
    $scope.sup_uom="";
    $scope.sup_unit_price=0;
    $scope.total_quantity=0;
    $scope.commodity_gid=0;
    $scope.approver_gid=0;
    $scope.file_status=1;
    $scope.file_data=[];

    $scope.maxDate = new Date();




     if (sessionStorage.getItem('ticket_detail') != null)
        {
            var ticket_all = JSON.parse(sessionStorage.getItem('ticket_detail'));
            $scope.update = ticket_all.view;
            $scope.Ticketheader_Gid=ticket_all.ticket_values.ticketheader_gid;

        }
        else{
        alert("No Ticket Header Gid");

        }


    $scope.edits=function(){
        $scope.editable=1;

    }

   $scope.loading = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.body),
                clickOutsideToClose: false
            });
    };

    $scope.loading_popup = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.getElementById('view_pr')),
            clickOutsideToClose: false
        });
    };

    $scope.endloading = function() {
        $mdDialog.hide();
    };

    $scope.types="";
    $scope.change_tyeps = function(t){
            if(t== "Do"){
                $scope.types="Do";
            }
            else{
                $scope.types="Manager";
            }
       }

    var datas={params:{"type":"GET","sub_type":"FOLLOW_UP_GET",
                                       "filter":{"Ticketheader_Gid":$scope.Ticketheader_Gid}
                                      }
                     };

    $scope.loading();
        var folloup_data = Service_followup.get_ticket_data(datas);
         folloup_data.then(function(result) {
         debugger;
                var followup_all_data = JSON.parse(JSON.stringify(result.data))
                $scope.followup_all_data_summary=followup_all_data;
                if($scope.followup_all_data_summary.length!=0 && $scope.followup_all_data_summary.length!=undefined){

                    console.log($scope.followup_all_data_summary);
                    $scope.followupdetail=$scope.followup_all_data_summary[0].followupdetail[0].metadata_data;
                    $scope.ticketheader_summary=$scope.followup_all_data_summary[0].ticketheader_summary;

                    $scope.asset_data=$scope.followup_all_data_summary[0].asset_name;

                    $scope.ticketheader_code=$scope.followup_all_data_summary[0].ticketheader_code;
                    $scope.branch_name=$scope.followup_all_data_summary[0].branch_name;
                    $scope.errorcategory_name=$scope.followup_all_data_summary[0].errorcategory_name;
                    $scope.searchemp=$scope.followup_all_data_summary[0].employee_name;

                    $scope.ticketheader_assignedto=$scope.followup_all_data_summary[0].ticketheader_assignedto;
                    $scope.ticketheader_assignedto_old=$scope.followup_all_data_summary[0].ticketheader_assignedto;

                    $scope.ticketheader_status=$scope.followup_all_data_summary[0].ticketheader_status;
                    $scope.ticketheader_status_old=$scope.followup_all_data_summary[0].ticketheader_status;

                    $scope.ticketheader_description=$scope.followup_all_data_summary[0].ticketheader_description;

                    $scope.trackdetails=$scope.followup_all_data_summary[0].trackdetails;
                    if($scope.trackdetails!=null){
                    $scope.track_gid=$scope.followup_all_data_summary[0].trackdetails[0].track_gid;
                    $scope.track_details_all= $scope.trackdetails;


                    $scope.track_engineername_old=$scope.track_details_all[0].track_engineername;
                    $scope.track_engineername=$scope.track_details_all[0].track_engineername;

                    $scope.track_visitdate=$scope.track_details_all[0].track_visitdate;

                    $scope.track_visittime_old=$scope.track_details_all[0].track_visittime;

                   document.getElementById("vist_time").value = $scope.track_visittime_old;
                   }
                   else{
                    $scope.trackdetails=0;
                    }


    <!--                $scope.find_emp($scope.ticketheader_assignedto);-->

                    console.log($scope.followup_all_data_summary)
                }


            },
            function(err) {
                alert(result);
    }).finally($scope.endloading);



    $scope.loading_popup();
    var bs = Service_followup.bsdata();

        bs.then(function(result) {
        $scope.all_bs = result.data.DATA;
        $scope.all_bs1 = result.data.DATA;
        console.log($scope.all_bs);
        },
            function(err) {
                alert(result);
    }).finally($scope.endloading);
    $scope.endloading


    $scope.getbs = bs_name;
       function bs_name(query) {
           var result = $filter('filter')($scope.all_bs, {
           'tbs_name': query
             });
           return result;
   }

   $scope.bsChanged=function(tbs_gid){
        $scope.tbs_gid=tbs_gid;
        $scope.loading_popup();
        if($scope.tbs_gid!=0 && $scope.tbs_gid!=undefined){
           var cc = Service_followup.ccdata(tbs_gid);
            cc.then(function(result) {
                $scope.all_cc = result.data.DATA;
                $scope.all_cc1 = result.data.DATA;
                console.log($scope.all_cc);
            },function(err) {
                    alert(result);
            }).finally($scope.endloading);

        }
        $scope.endloading();

   };

    $scope.getcc = cc_name;
       function cc_name(query) {
           var result = $filter('filter')($scope.all_cc, {
           'tcc_name': query
             });
           return result;
    }

    $scope.ccChanged=function(tcc_gid){
        $scope.tcc_gid=tcc_gid;
    }

    var pro_cat_name = Service_followup.pro_cat_data();

            pro_cat_name.then(function(result) {
                $scope.all_pro_cat = result.data.DATA;
                $scope.all_pro_cat1 = result.data.DATA;
                console.log($scope.all_pro_cat);
                 },function(err) {
                    alert(result);
            }).finally($scope.endloading);


    $scope.getProductCategory = pro_name;
       function pro_name(query) {
           var result = $filter('filter')($scope.all_pro_cat, {
           'productcategory_name': query
             });
           return result;
    }

    $scope.ProductCategoryChanged=function(productcategory_gid){
        $scope.productcategory_gid=productcategory_gid;

        if($scope.productcategory_gid!=0 && $scope.productcategory_gid!=undefined){
            $scope.loading_popup();
           var pro_cat_type = Service_followup.product_cate_type_data(productcategory_gid);
            pro_cat_type.then(function(result) {
                $scope.all_pro_cat_type = result.data.DATA;
                $scope.all_pro_cat_type1 = result.data.DATA;
                console.log($scope.all_pro_cat_type);
            },function(err) {
                    alert(result);
            }).finally($scope.endloading);


        }

    }


    $scope.getProductCategoryType = pro_cat_type_name;
       function pro_cat_type_name(query) {
           var result = $filter('filter')($scope.all_pro_cat_type, {
           'producttype_name': query
             });
           return result;
    }

    $scope.dts_value="N";
    $scope.Changed_dts=function(value){
       if(value==true){
            $scope.dts_value="Y";
        }
        else{
         $scope.dts_value="N";
        }
    }


    $scope.ProductCategoryTypeChanged=function(productcategory_type_gid){
        $scope.product_category_type_id=productcategory_type_gid;


        if($scope.product_category_type_id!=0 && $scope.product_category_type_id!=undefined){
           $scope.loading_popup();
           var pro_name = Service_followup.get_product_type($scope.product_category_type_id,$scope.dts_value);
            pro_name.then(function(result) {
                $scope.all_product_list = result.data;
                $scope.all_product_list = result.data;

                $scope.sup_uom=$scope.all_product_list[0].uom_name;
                $scope.supplierproduct_gid=$scope.all_product_list[0].supplierproduct_gid;

                $scope.sup_unit_price=$scope.all_product_list[0].supplierproduct_unitprice;

                console.log($scope.all_product_list);
            },function(err) {
                    alert(result);
            }).finally($scope.endloading);
        }


    }

    $scope.getProductName = product_name;
       function product_name(query) {
           var result = $filter('filter')($scope.all_product_list, {
           'product_displayname': query
             });
           return result;
    }

    $scope.ProductNameChanged=function(product_gid){
        $scope.product_gid=product_gid;

        if($scope.product_gid!=0 && $scope.product_gid!=undefined){
            $scope.loading_popup();
           var supplier = Service_followup.supplier_detail($scope.product_gid);
                supplier.then(function(result) {
                $scope.all_supplier_list = result.data;
                $scope.all_supplier_list1= result.data;
                console.log($scope.all_product_list);
            },function(err) {
                    alert(result);
            }).finally($scope.endloading);

            var commodity = Service_followup.commodity_detail($scope.product_gid);
                commodity.then(function(result) {
                $scope.all_commodity_list = result.data;
                $scope.all_commodity_list1 = result.data;
                console.log($scope.all_commodity_list);
            },function(err) {
                    alert(result);
            }).finally($scope.endloading);



        }
    }

     $scope.getCommodity = commodity_name;
       function commodity_name(query) {
           var result = $filter('filter')($scope.all_commodity_list, {
           'commodity_name': query
             });
           return result;
    }

     $scope.CommodityChanged=function(com_gid){
        $scope.commodity_gid=com_gid;
        }


      $scope.getSupplierName = supplier_name;
       function supplier_name(query) {
           var result = $filter('filter')($scope.all_supplier_list, {
           'supplier_name': query
             });
           return result;
      }

     $scope.supplierNameChanged=function(sup_gid){
        $scope.supplier_gid=sup_gid;
     }


     var Branch = Service_followup.get_branchs();
                Branch.then(function(result) {
                $scope.all_branch_list = result.data.DATA;
                $scope.all_branch_list1= result.data.DATA;
                console.log($scope.all_branch_list);
            },function(err) {
                    alert(result);
            }).finally($scope.endloading);


    $scope.getBranchCode = get_branch_name;
       function get_branch_name(query) {
           var result = $filter('filter')($scope.all_branch_list, {
           'branch_code': query
             });
           return result;
      }

     $scope.BranchCodeChanged=function(branch_gid,branch_code,branch_name){
        $scope.branch_gid=branch_gid;
        $scope.branch_code=branch_code;
        $scope.pr_branch_name=branch_name;

     }

    $scope.add_pr=function(searchBS,searchCC,searchProName,searchProCat,searchProCatType,searchCommodity,searchSuplierName,pro_desc){
        $scope.temp=[];
    if($scope.pr_added_values.length<1){
            $scope.temp={"searchBS":searchBS,"searchCC":searchCC,"searchProName":searchProName,"searchProCat":searchProCat,
            "searchProCatType":searchProCatType,"searchCommodity":searchCommodity,"searchSuplierName":searchSuplierName,
            "pr_branch_name":$scope.pr_branch_name,"uom_name":$scope.sup_uom,"sup_unit_price":$scope.sup_unit_price,"product_desc":pro_desc}

            $scope.pr_added_values.push($scope.temp);
    <!--        $scope.searchBS="";-->
    <!--        $scope.searchCC="";-->
    <!--        $scope.searchProName="";-->
    <!--        $scope.searchProCat="";-->
    <!--        $scope.searchProCatType="";-->
    <!--        $scope.dts_selected="";-->
    <!--        $scope.searchCommodity="";-->
    <!--        $scope.searchSuplierName="";-->
    <!--        $scope.searchBranchCode="";-->
    <!--        $scope.pro_desc="";-->
    <!--        $scope.pr_creation.$setUntouched()-->

        }
        else{
        alert("Only Allow One Recods!...");
        }
    }

    $scope.close_pr_popup=function(){
        $mdDialog.cancel();
        $scope.searchBS="";
        $scope.searchCC="";
        $scope.searchProName="";
        $scope.searchProCat="";
        $scope.searchProCatType="";
        $scope.dts_selected="";
        $scope.searchCommodity="";
        $scope.searchSuplierName="";
        $scope.searchempCode="";
        $scope.pr_branch_name="";
        $scope.pr_added_values=[];
        $scope.sup_uom="";
        $scope.sup_unit_price=0;
        $scope.pro_desc="";
        $scope.emp_code="";
        $scope.searchBranchCode="";
        $scope.approver_gid=0;
        $scope.all_amt=0;
        $scope.total_quantity=0;
        $scope.pr_creation.$setUntouched()
        $scope.final_pr_form.$setUntouched()

    }



    $scope.delete_column = function(index){
             $scope.pr_added_values.splice(index, 1);
     }



    var emp = Service_followup.getemployee();
        emp.then(function(result) {
            var employee_data =result.data;
                $scope.employee = employee_data;
                console.log($scope.employee = employee_data);
                $scope.employee1= employee_data;
        }, function() {
            alert("No Data")
   });


    $scope.getemployee_Name = Change_emp_name;
       function Change_emp_name(query) {
           var result = $filter('filter')($scope.employee1, {
           'employee_gid':query,
             });
           return result;
      }

    $scope.EmpChanged=function(emp_gid){
    $scope.new_emp_gid=emp_gid;

    };

    $scope.getApprover = Change_emp_name;
       function Change_emp_name(query) {
           var result = $filter('filter')($scope.employee1, {
           'employee_name':query,
             });
           return result;
      }

    $scope.ApproerChanged=function(emp_gid,code){
    $scope.approver_gid=emp_gid;
    $scope.emp_code=code;

    };



    $scope.getTotal = function(){
        $scope.all_amt = 0;
        $scope.total_quantity=0;
        for(var i = 0; i < $scope.pr_added_values.length; i++){
            $scope.all_amt+= (parseInt($scope.pr_added_values[i].quantity)*$scope.pr_added_values[i].sup_unit_price);
            $scope.total_quantity+=parseInt($scope.pr_added_values[i].quantity);
        }
    }

    var detail = JSON.parse(sessionStorage.getItem('today'));
			$scope.employgid = detail.employee_gid;
			$scope.entity_gid = detail.entity_gid;
			$scope.empcode = detail.employee_code;
			$scope.today = detail.date;


    $scope.create_new_pr=function(){
        $scope.total_pr_amount=0;

        if($scope.pr_added_values!=0){
            if($scope.approver_gid!=0){


                var status = "Pending for next level to " + $scope.emp_code;
                var get_date=new Date();
                var new_date=$filter('date')(get_date, "yyyy-MM-dd");

                $scope.header={"HEADER": [{"Date":new_date, "Emp_gid": $scope.employgid, "Statuss": status, "Branchgid": $scope.branch_gid,"Totalamount": $scope.all_amt,
                "Commodity_gid":$scope.commodity_gid,"mepno":100, "PR_Header_Gid": 0, "dropdown_gid":$scope.approver_gid}]};

                $scope.detail={"DETAIL": [{"product_name":$scope.searchProName , "branch_gid": $scope.branch_gid,"commodity_name":$scope.searchCommodity,
                 "commodity_gid": $scope.commodity_gid, "product_gid": $scope.product_gid, "supplierproduct_unitprice": 7, "supplierproduct_gid":$scope.supplierproduct_gid,
                  "supplier_gid": $scope.supplier_gid,"uom_name": $scope.sup_uom, "supplier_name":$scope.searchSuplierName, "branch_name":$scope.pr_branch_name, "detail_edit": "Y",
                  "PRdetail_gid": 0,"CCBS": [{"prccbs_bs": $scope.tbs_gid, "prbs_code": $scope.searchBS, "prccbs_cc": $scope.tcc_gid, "prcc_code":$scope.searchCC,"prccbs_code": "0",
                 "delivery_type": "PO_BRANCH", "prccbs_reftablegid": 1,"prccbs_remarks": " ", "prccbs_edit": "N", "prccbs_GID": 0,
                 "location": {"branch_gid":$scope.branch_gid, "branch_code":$scope.branch_code, "branch_name": $scope.pr_branch_name}, "prccbs_qty":$scope.total_quantity }],
                 "quantity": $scope.total_quantity}]};


                var datas={params:{"action":"insert","type":"PR_DETAILS_INSERT","filter":$scope.header,"classification":$scope.detail}};

                $scope.loading();
                    var save_pr = Service_followup.set_pr(datas);
                        save_pr.then(function(result) {
                            var res=result.data;
                             if (res[0]=== "SUCCESS") {
                            alert("Succesfully PR Created...");
                            $scope.close_pr_popup();
                            modalhide("view_pr");

                            } else {
                          alert(JSON.stringify(res));
                          }
                        }, function(err) {
                          alert('Data Not Inserted');
                        }).finally($scope.endloading);
                $scope.endloading();
            }
            else{
            alert("Select Approver");
            }

        }
        else{
        alert("Please Insert Atlease One Values!...");

        }

    };


    $scope.loadfile=function(img){
            promise.then(function() {

                 $scope.loading();
                 var upload = Service_followup.save_file(img);
                 upload.then(function(result) {

                    $scope.file_data = result.data;
                    $scope.file_status=1;

                }).finally($scope.endloading);
              }).then(function() {
                // callback();
            });
            deferred.resolve();
    };
        $scope.loaddata = function(file_img,img, callback) {
            var deferred = $q.defer();
            var promise = deferred.promise;
            promise.then(function() {
                if(file_img!=undefined){
                  $scope.loading();
                     var upload = Service_followup.save_file(img);
                     upload.then(function(result) {

                        $scope.file_data = result.data;
                        $scope.file_status=1;
                        callback();

                    }).finally($scope.endloading);
                }else{
                 $scope.file_status=1;
                callback();
                }
            }).then(function() {
                // callback();
            });
            deferred.resolve();
        };

    $scope.update_click1=function(){
    debugger;
        $scope.file_status=1;
        var file_img = document.getElementById('file').files[0];
         var img = new FormData();
         var UPLOAD_FILE="";

        if(file_img!=undefined){
            $scope.file_status=0;
            var file_name=file_img.name;

            var filename = file_img.name;
            var index = filename.lastIndexOf(".");
            $scope.strsubstring = filename.substring(index, filename.length);

            img.append('file', file_img);
            img.append('name', filename);

        }
        $scope.loaddata(file_img,img, function() {

            if($scope.file_status==1){
                $scope.assign_status=1;

                $scope.status_status=1;
                $scope.track_status=1;
                $scope.comment_status=1;
                $scope.tran_all=[];

                var eng_time=document.getElementById("vist_time").value;
                if(eng_time==""){
                    eng_time=undefined;
                }
                var eng_date=$filter('date')($scope.track_visitdate, "yyyy-MM-dd");
                $scope.track_visitdate_changed=$filter('date')($scope.track_visitdate, "yyyy-MM-dd");

                if($scope.trackdetails==0){
                    $scope.track_isinnsert="Y";
                }
                else{
                    $scope.track_isinnsert="N";
                }

                var ASSIGN={"Followuptran_OldValue":"  ","Followuptran_NewValue":"  ", "Followuptran_AssignFrom":$scope.ticketheader_assignedto_old,
                            "Followuptran_AssignTo":$scope.new_emp_gid,"metadata_value":"ASSIGN","track_isinnsert":"N","track_gid":0};

                var STATUS={"Followuptran_OldValue":$scope.ticketheader_status_old,"Followuptran_NewValue":$scope.ticketheader_status,
                            "Followuptran_AssignFrom":0,"Followuptran_AssignTo":0,"metadata_value":"STATUS","track_isinnsert":"N","track_gid":0};

                var TRACK={"Followuptran_OldValue":" ","Followuptran_NewValue":" ","Followuptran_AssignFrom":0,"Followuptran_AssignTo":0,
                             "metadata_value":"TRACK","track_isinnsert":$scope.track_isinnsert,"track_gid":$scope.track_gid};

                if($scope.track_engineername!=$scope.track_engineername_old)
                {
                   TRACK["track_engineername"]=$scope.track_engineername;
                }


                if(eng_date!=$scope.track_visitdate)
                {
                  TRACK["track_visitdate"]=eng_date;
                }

                if($scope.track_visittime_old!=eng_time)
                {
                  TRACK["track_visittime"]=eng_time;
                }

                var COMMENT={"Followuptran_OldValue":" ","Followuptran_NewValue":$scope.comments,
                            "Followuptran_AssignFrom":0,"Followuptran_AssignTo":0, "metadata_value":"COMMENT","track_isinnsert":"N","track_gid":0}



                if($scope.ticketheader_assignedto_old==$scope.new_emp_gid || $scope.new_emp_gid==undefined){ $scope.assign_status=0;  }
                if($scope.ticketheader_status_old==$scope.ticketheader_status){  $scope.status_status=0;    }
                if($scope.track_engineername==$scope.track_engineername_old && eng_date==$scope.track_visitdate && $scope.track_visittime_old==eng_time){
                    $scope.track_status=0;
                }
                if($scope.comments==undefined){$scope.comment_status=0; }
                if($scope.assign_status==1){$scope.tran_all.push(ASSIGN)}
                if($scope.status_status==1){$scope.tran_all.push(STATUS)}
                if($scope.track_status==1){$scope.tran_all.push(TRACK)}
                if($scope.comment_status==1){$scope.tran_all.push(COMMENT)}

                if($scope.file_data.length!=0){UPLOAD_FILE=[{'Ref_Table_Gid':'0', 'File_Name': file_name,
                   'File_Extension':file_name.substr(file_name.lastIndexOf('.')+1), 'File_Base64data': $scope.file_data.file}];
                }


                if($scope.tran_all.length!=0){
                         var datas={params:{"action":'INSERT',"type":'INSERT_FOLLOWUP',
                                          "filter":{"Followup_Ticketheadergid":$scope.Ticketheader_Gid,"Followup_Title":" ",
                                                    "Followup_Description":" ","Followup_Status":"active","tran":$scope.tran_all,
                                                    "File_Data":UPLOAD_FILE
                                                   }
                                          }
                         };
                    $scope.loading();
                    var followup = Service_followup.save_followup_details(datas);
                        followup.then(function(result) {
                            var res=JSON.parse(result.data);
                                if (res.MESSAGE[0]=== "SUCCESS") {
                                    alert("Succesfully Updated...");
                                    $window.location.href = "ServiceManagement/SM_Ticket_Summary/";
                                } else {
                              alert(JSON.stringify(res));
                              }
                            }, function(err) {
                              alert('Data Not Inserted');
                            }).finally($scope.endloading);
                            $scope.endloading();
                    }
                else{
                    alert("Not Updated.Atleat One Field Change !...");
                }
            }
       });
    }
}]);



 myApp.service("Service_followup", function ($http) {

          this.get_ticket_data=function(datas){
             var response=$http.post(Appname+"/Get_Service_Management/",datas);
             return response;
          }

          this.getemployee=function(){
              var response=$http.get(Appname+"/Get_Employee/");
              return response;
          }
          this.save_followup_details=function(datas){
              var response=$http.post(Appname+"/Set_Service_Management/",datas);
              return response;
          }

          this.bsdata = function () {
                var response = $http.post(Appname+"/Get_All_Table_Metadata/",{params:{"action":"Get","type":"Metadata","sub_type":"BS_DATA",
                               "filter":{}}});
                return response;
          }


          this.ccdata = function (bs_gid) {
                var response = $http.post(Appname+"/Get_All_Table_Metadata/",{params:{"action":"Get","type":"Metadata","sub_type":"CC_DATA",
                               "filter":{"bs_gid":bs_gid}}});
                return response;
          }

          this.pro_cat_data = function () {
                var response = $http.post(Appname+"/Get_All_Table_Metadata/",{params:{"action":"Get","type":"Metadata","sub_type":"Pro_Category",
                               "filter":{}}});
                return response;
          }

          this.product_cate_type_data = function (productcategory_gid) {
                var response = $http.post(Appname+"/Get_All_Table_Metadata/",{params:{"action":"Get","type":"Metadata","sub_type":"Pro_Category_Type",
                               "filter":{"productcategory_gid":productcategory_gid}}});
                return response;
          }

          this.get_product_type=function(product_type_gid,dts){
             var response = $http.post(Appname+"/Get_Service_Management/",{params:{"type":"GET","sub_type":"SUPPLIER_PRODUCT_TYPE",
                               "filter":{"product_producttype_gid":product_type_gid,"supplierproduct_gid":"","supplierproduct_dts":dts}}});
                return response;
          }

          this.supplier_detail=function(product_gid){
             var response = $http.post(Appname+"/Get_Service_Management/",{params:{"type":"GET","sub_type":"GET_SUPPLIER",
                               "filter":{"SupplierProduct_Product_Gid":product_gid}}});
                return response;
          }

          this.commodity_detail=function(product_gid){
             var response = $http.post(Appname+"/Get_Service_Management/",{params:{"type":"GET","sub_type":"GET_COMMODITY",
                               "filter":{"Commodityprod_Productgid":product_gid}}});
                return response;
          }

          this.get_branchs = function (productcategory_gid) {
                var response = $http.post(Appname+"/Get_All_Table_Metadata/",{params:{"action":"Get","type":"Metadata","sub_type":"GET_BRANCH"}});
                return response;
          }

          this.set_pr = function (datas) {
                var response = $http.post(Appname+"/Set_Service_Management/",datas);
                return response;
          }



          this.save_file=function(img){
              var response=$http.post(Appname+"/SMS_Followup_File_Upload/",img,
                   {
                     transformRequest: angular.identity,
                     headers: {
                        'Content-Type': undefined
                     }
                   }
              );
              return response;
          }

 });




















</script>

<style>


@media (min-width: 1200px) {
  .modal-lg {
    width: 1200px;
  }
}

.hint {
  position: absolute;
  left: 5px;
  right: auto;
  bottom: 0px;
  font-size: 14px;
  line-height: 14px;
  transition: all 0.3s cubic-bezier(0.55, 0, 0.55, 0.2);
  color: grey;
}

.followups{
height:450px;
overflow:auto;
}

    .timeline {
    list-style: none;
    padding: 20px 0 20px;
    position: relative;
}

    .timeline:before {
        top: 0;
        bottom: 0;
        position: absolute;
        content: " ";
        width: 3px;
        background-color: #eeeeee;
        left: 50%;
        margin-left: -1.5px;
    }

    .timeline > li {
        margin-bottom: 20px;
        position: relative;
    }

        .timeline > li:before,
        .timeline > li:after {
            content: " ";
            display: table;
        }

        .timeline > li:after {
            clear: both;
        }

        .timeline > li:before,
        .timeline > li:after {
            content: " ";
            display: table;
        }

        .timeline > li:after {
            clear: both;
        }

        .timeline > li > .timeline-panel {
            width: 46%;
            float: left;
            border: 1px solid #d4d4d4;
            border-radius: 2px;
            padding: 20px;
            position: relative;
            -webkit-box-shadow: 0 1px 6px rgba(0, 0, 0, 0.175);
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.175);
        }

            .timeline > li > .timeline-panel:before {
                position: absolute;
                top: 26px;
                right: -15px;
                display: inline-block;
                border-top: 15px solid transparent;
                border-left: 15px solid #ccc;
                border-right: 0 solid #ccc;
                border-bottom: 15px solid transparent;
                content: " ";
            }

            .timeline > li > .timeline-panel:after {
                position: absolute;
                top: 27px;
                right: -14px;
                display: inline-block;
                border-top: 14px solid transparent;
                border-left: 14px solid #fff;
                border-right: 0 solid #fff;
                border-bottom: 14px solid transparent;
                content: " ";
            }

        .timeline > li > .timeline-badge {
            color: #fff;
            width: 50px;
            height: 50px;
            line-height: 50px;
            font-size: 1.4em;
            text-align: center;
            position: absolute;
            top: 16px;
            left: 50%;
            margin-left: -25px;
            background-color: #999999;
            z-index: 100;
            border-top-right-radius: 50%;
            border-top-left-radius: 50%;
            border-bottom-right-radius: 50%;
            border-bottom-left-radius: 50%;
        }

        .timeline > li.timeline-inverted > .timeline-panel {
            float: right;
        }

            .timeline > li.timeline-inverted > .timeline-panel:before {
                border-left-width: 0;
                border-right-width: 15px;
                left: -15px;
                right: auto;
            }

            .timeline > li.timeline-inverted > .timeline-panel:after {
                border-left-width: 0;
                border-right-width: 14px;
                left: -14px;
                right: auto;
            }

.timeline-badge.primary {
    background-color: #2e6da4 !important;
}

.timeline-badge.success {
    background-color: #3f903f !important;
}

.timeline-badge.warning {
    background-color: #f0ad4e !important;
}

.timeline-badge.danger {
    background-color: #d9534f !important;
}

.timeline-badge.info {
    background-color: #5bc0de !important;
}

.timeline-title {
    margin-top: 0;
    color: inherit;
}

.timeline-body > p,
.timeline-body > ul {
    margin-bottom: 0;
}

    .timeline-body > p + p {
        margin-top: 5px;
    }

@media (max-width: 767px) {
    ul.timeline:before {
        left: 40px;
    }

    ul.timeline > li > .timeline-panel {
        width: calc(100% - 90px);
        width: -moz-calc(100% - 90px);
        width: -webkit-calc(100% - 90px);
    }

    ul.timeline > li > .timeline-badge {
        left: 15px;
        margin-left: 0;
        top: 16px;
    }

    ul.timeline > li > .timeline-panel {
        float: right;
    }

        ul.timeline > li > .timeline-panel:before {
            border-left-width: 0;
            border-right-width: 15px;
            left: -15px;
            right: auto;
        }

        ul.timeline > li > .timeline-panel:after {
            border-left-width: 0;
            border-right-width: 14px;
            left: -14px;
            right: auto;
        }
}


textarea { resize: none; }
body{
    overflow:auto;
}








































































</style>
{% endblock %}