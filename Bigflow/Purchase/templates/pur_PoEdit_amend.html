{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} PO Modification {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<div class="maincontent">
    <div class="container container1" ng-app="Appprapproval" ng-controller="Ctrlprapproval" ng-cloak>
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>PO Modification</h4>
            </div>
        </div>

        <div class="modal fade" id="potermview_template" tabindex="-1">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <strong>VIEW TEMPLATE Details</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="col-md-12">
                                <br>
                                <div ng-repeat="tempobj in slectedtemplate">
                                    <span style="margin-right:12px">{{$index+1}}. {{tempobj.potermstemplate_desc}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12" align="center">
                            <md-button class="md-raised" data-dismiss="modal">
                                close
                            </md-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="potermview_modal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel1">
                                <strong>PO TEMPLATE Details</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="col-md-12">
                                <md-input-container class="md-block inputcontainer">
                                    <md-radio-group layout="row" ng-change="check_radio()" ng-model="radio_data">
                                        <md-radio-button value="P"><b>Product Template</b></md-radio-button>
                                        <md-radio-button value="S"><b>Service Template</b></md-radio-button>
                                        <md-radio-button value="N"><b>Click To Add New Template</b></md-radio-button>
                                    </md-radio-group>
                                </md-input-container>
                                <br>
                                <div ng-hide="create_temp" ng-repeat="tempobj in fulltemplate">
                                    <input type="checkbox" ng-model="tempobj.Selected"/>

                                    <span style="margin-right:12px">{{tempobj.potermstemplate_desc}}</span>
                                </div>
                                <div ng-show="create_temp">
                                    <form name="potemp">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>New Template</label>
                                            <input ng-model="new_template" autocomplete="off" required/>
                                        </md-input-container>
                                    </form>
                                    <md-button class="md-raised custbutton" ng-if="potemp.$valid"
                                               ng-click="addintable()">Submit
                                        <md-tooltip>Submit</md-tooltip>
                                    </md-button>
                                    <table class="table table-striped table-bordered table-condensed table-hover md-primary">
                                        <thead class="header">
                                        <tr>
                                            <th>S.No</th>
                                            <th>Template(s)</th>
                                            <th>Delete</th>
                                        </tr>
                                        </thead>
                                        <tr ng-repeat="obj in Add_Templates">
                                            <td class="text-center">{{$index + 1}}</td>
                                            <td class="text-center">{{obj.new_template}}</td>
                                            <td align="center"><a href="" ng-click="deletetemp($index)"><i
                                                    class="material-icons"
                                                    style="material-icons.line-height:3px">delete</i></a>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <br>
                                <form name="form_name">
                                    <div class="col-md-6" ng-hide="create_temp">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>PO Term Name</label>
                                            <input type="text" ng-model="po_name" letter-numbers autocomplete="off"
                                                   maxlength="64"
                                                   required/>
                                        </md-input-container>
                                    </div>
                                </form>
                                <form name="form_name_1">
                                    <div class="col-md-6" ng-show="create_temp">
                                        <md-autocomplete md-clear-button="true" md-floating-label="PO Template Name"
                                                         md-item-text="item.poterms_name" md-input-maxlength=126
                                                         md-min-length=0
                                                         md-items="item in getpoterm(searchText)" md-no-cache="true"
                                                         md-search-text="searchText" md-selected-item="ddlpoterms"
                                                         required>
                                            <md-item-template>
                                                <span md-highlight-text="searchText"> {{item.poterms_name}} </span>
                                            </md-item-template>
                                            <md-not-found>
                                                No Template matching "{{searchText}}" were found.
                                            </md-not-found>
                                        </md-autocomplete>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12" align="center">
                            <md-button class="md-raised custbutton" ng-if="form_name.$valid" ng-click="submitclck()">
                                Submit
                            </md-button>
                            <md-button class="md-raised custbutton" ng-show="create_temp" ng-if="form_name_1.$valid"
                                       ng-click="submitclck_temp()">
                                Submit
                            </md-button>
                            <md-button class="md-raised" data-dismiss="modal">
                                close
                            </md-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </br>
        <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" data-backdrop="static"
            data-keyboard="false" id="viewprheader" role="dialog" style="height:auto;width:100%" tabindex="-1">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalabel">
                                <strong> PO Header File(s)</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="row table-responsive">
                                <div class="col-md-12 col-lg-12 col-sm-12">
                                    <table
                                        class="table table-striped table-bordered table-condensed table-hover md-primary"
                                        md-progress="deferred">
                                        <thead class="header">
                                            <tr>
                                                <td align="right">
                                                    S.No
                                                </td>
                                                <td>File Name</td>
                                                <td>Download File</td>
                                                <td>View File</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="obj in posummary1">
                                                <td>
                                                    <center>{{$index+1}}</center>
                                                </td>
                                                <td class="text-center">
                                                    {{obj.file_path}}
                                                </td>
                                                <td class="text-center">
                                                    <span title="Download {{obj.file_path}}" class="editlink">
                                                        <a class="material-icons"
                                                            href="/common_downloadfile/?filename={{obj.file_path}}"
                                                            target="_blank">get_app</a>
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <span title="View {{obj.file_path}}"
                                                          class="editlink">
                                                        <a
                                                           class="material-icons"
                                                           ng-click="clkview(obj.file_path)"
                                                           target="_blank">touch_app</a>
                                                    </span>
                                                </td>
                                            </tr>

                                        </tbody>
                                        <tfoot>
                                            <tr>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <md-button class="md-raised" data-dismiss="modal">Back
                                <md-tooltip>close</md-tooltip>
                            </md-button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
         <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" data-backdrop="static"
            data-keyboard="false" id="viewprfile" role="dialog" style="height:auto;width:100%">
            <div class="modal-dialog modal-lg modal-style" role="document">
                <div class="modal-content">
                    <div class="header">
                        <div class="modal-header popup-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <strong> Viewing {{filename}}</strong>
                                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="body">
                        <div class="modal-body popup-body">
                            <div class="row">
                                <div class="col-md-12 text-center">
<span title="Zoom in">
     <a href="" onclick="zoomin()" style="font-size:50px"><i style="font-size:50px" class="material-icons">zoom_in
                        </i></a>
</span>
                                    <span title="Zoom Out">
                        <a href="" onclick="zoomout()" style="font-size:50px"><i style="font-size:50px"
                                                                                 class="material-icons">
                            zoom_out
                        </i></a>
                                        </span>
                                </div>
                            </div>
                            <div class="row table-responsive">
                                <div class="col-md-12 col-lg-12 col-sm-12">
                                     <img src="{{viewfilepath}}"
            id="zooming" GFG="250">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <md-button class="md-raised" data-dismiss="modal">Back
                                <md-tooltip>close</md-tooltip>
                            </md-button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="row row-search" ng-form="searchfrom">
            <form role="form">
                <div class="col-md-3">
                    <md-input-container class="md-block inputcontainer">
                        <label>PO No</label>
                        <input class="textboxgeneral" ng-disabled="true" ng-model="poheader_no"/>
                    </md-input-container>
                </div>
            </form>
            <form id="create" method="post" name="prform">

                    <div class="col-md-3" ng-disabled="true">
                        <md-autocomplete ng-disabled="true"
                                         md-floating-label="Supplier Name" md-item-text="item.supplier_name"
                                         md-input-maxlength=126 md-min-length=0
                                         md-items="item in getsupper(searchText2)"
                                         md-no-cache="true" md-search-text="searchText2"
                                         md-selected-item="chk.ddlstatus"
                                         md-selected-item-change="supplierclick(item)"
                                         required>
                            <md-item-template>
                                <span md-highlight-text="searchText2">{{item.supplier_name}}</span>
                            </md-item-template>
                            <md-not-found>
                                No dispatch matching "{{searchText2}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                    <div class="col-md-2" style='margin-top:25px'>
                         <a ng-repeat= "e in poeditamendment" title="" align="center"
                               ng-click="poheaderfiles(e)">
                                <i class="material-icons">folder</i>
                                <md-tooltip>Click to View PO Header Files</md-tooltip>
                            </a>
                    </div>
                    <div class="col-md-4">
                        <md-autocomplete md-clear-button="true" md-floating-label="Choose Approver"
                                         md-input-maxlength=126 md-item-text="item.employee_name"
                                         md-items="item in getcust(searcheployee)" md-min-length=0
                                         md-no-cache="true"
                                         md-search-text="searcheployee" md-selected-item="chk.lim"
                                         required>
                            <md-item-template>
                                <td md-highlight-text="searcheployee" ng-value="item.employee_gid">
                                    <code>{{item.employee_code}}</code>
                                    {{item.employee_name}}
                                    <span>{{&nbsp;&nbsp;&nbsp;&nbsp;}}</span>
                                    <span ng-if="item.delmat_limit > 0">
                                            <code>{{item.delmat_limit}}</code>
                                        </span>
                                    <span ng-if="item.delmat_limit == undefined">
                                            {{item.delmat_limit}}
                                        </span>
                                </td>
                            </md-item-template>
                            <md-not-found>
                                No Approver matching "{{searchText}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-1">
                            <md-button class="md-fab md-mini md-primary custbutton" ng-click="addtermsandcond(pr)">
                                <md-icon>add</md-icon>
                                <md-tooltip>Create New Terms and Conditions</md-tooltip>
                            </md-button>
                        </div>
                        <div class="col-md-3">
                            <md-autocomplete md-clear-button="true" md-floating-label="Term And Condition"
                                             md-item-text="item.poterms_name" md-input-maxlength=126 md-min-length=0
                                             md-items="item in getcond(searchText3)" md-no-cache="true"
                                             md-search-text="searchText3" md-selected-item="chk.ddlstatus1"
                                             md-selected-item-change="ccbsglno(chk)" required>
                                <md-item-template>
                                    <span md-highlight-text="searchText3"> {{item.poterms_name}} </span>
                                </md-item-template>
                                <md-not-found>
                                    No Term matching "{{searchText2}}" were found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>
                        <div class="col-md-1" style="margin-top:25px">
                            <a title="" align="center" style='cursor: pointer; text-decoration:none;'
                               ng-click="viewpo()">
                                <i class="material-icons">remove_red_eye</i>
                                <md-tooltip>View Term Templates</md-tooltip>
                            </a>
                        </div>
                        <div class="col-md-2">
                            <md-input-container class="md-block inputcontainer">
                                <label>From Date</label>
                                <md-datepicker md-hide-icons="calendar" ng-model="chk.from_date"
                                               md-min-date="minDate" required></md-datepicker>
                            </md-input-container>
                        </div>
                        <div class="col-md-2">
                            <md-input-container class="md-block inputcontainer">
                                <label>To Date</label>
                                <md-datepicker ng-model="chk.to_date" md-hide-icons="calendar"
                                               md-min-date="chk.from_date" required>
                                </md-datepicker>
                            </md-input-container>
                        </div>
                        <div class="col-md-3">
                            <md-autocomplete md-clear-button="true" md-floating-label="Branch Name"
                                             md-input-maxlength=126 md-item-text="item.branch_name"
                                             md-items="item in getbranch(searchText1)" md-min-length=0
                                             md-no-cache="true"
                                             md-search-text="searchText1" md-selected-item="chk.branch_name"
                                             md-selected-item-change="ACselectchange(item)" required>
                                <md-item-template>
                                    <td md-highlight-text="searchText1">
                                        {{item.branch_name}}-{{item.branch_code}}
                                    </td>
                                </md-item-template>
                                <md-not-found>
                                    No found.
                                </md-not-found>
                            </md-autocomplete>
                        </div>
                    </div>
                </div>
                <br>
            </form>
        </div>
        <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" data-backdrop="static"
             data-keyboard="false" id="mdl_present1" role="dialog" tabindex="-1">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header popup-header aa" style="background-color: rgb(75, 122, 130)">
                        <h5 class="modal-title" id="lo">
                            Cc Bs Details
                            <button aria-label="Close" class="close" ng-click="cancel()" type="button">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="modal-body popup-body">
                        <div class="row">
                            <!--ccbs details-->

                            <!--Data Table-->
                            <div class="col-md-12 col-lg-12 col-sm-12">
                                  <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                        md-progress="deferred">
                                        <thead class="header">
                                    <tr>
                                        <th class="text-center">S.No</th>
                                        <th class="text-center">Location</th>
                                        <th class="text-center">Bs Name</th>
                                        <th class="text-center">Quantity</th>
                                    </tr>
                                    </thead>
                                    <tbody ng-init="total = 0">
                                    <tr ng-repeat="pur in delivery_details">
                                        <td>
                                            <center>{{$index+1}}</center>
                                        </td>

                                        <td>{{pur.prbs_name}}<br/>
                                            <b style="color:black;">Desription</b><span>:{{pur.prccbs_prdetailsgid}}</span>
                                        </td>
                                        <td>{{pur.prcc_name}}<br/>
                                            <b style="color:black;">Desription</b><span>:{{pur.prpoqty_prccbs_gid}}</span>
                                        </td>
                                        <td align="">
                                            <form name="ccbsform" novalidate>
                                                <input align="center" class="form-control" name="qty"
                                                       ng-change="totalqty(pur)"
                                                       ng-model="pur.ccbs_qty" required style="width:100px"
                                                       type="text" numbers-only>
                                                <div ng-messages="ccbsform.qty.$error">
                                                    <div ng-message="number">Should be a number</div>
                                                    <div ng-message="max">your quantity order exceeds 10000</div>
                                                    <div ng-message="min">your quantity should not be zero</div>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                        </td>

                                    </tbody>
                                </table>
                            </div>
                            <div class="col-lg-12 col-sm-12 text-center">
                                <p type="hidden" ng-model="canin"></p>
                                <button class="btn btn-success" ng-click="saveccbsdata(ccbsddl,$index,allocatedqty)"

                                        style="  margin-right: 10px"
                                        type="button" value="Submit" value="Save">
                                    Save
                                </button>
                                <button class="btn btn-default" ng-click="cancel(canin)" type="button" value="Submit">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row  table-responsive">
            <div class="col-lg-12 col-sm-12">
                <table datatable="ng"
                       class="table  table-striped table-bordered table-condensed table-hover">
                    <thead class="header">
                    <tr>
                        <td rowspan="2 " style="width:25px;" align="right">
                            S.No
                        </td>
                        <td rowspan="2" style="width:10%;">
                            Product Category
                        </td>
                        <td rowspan="2" style="width: 25%;">
                            Product Type
                        </td>
                        <td rowspan="2" style="width: 10%;">
                            Product Name
                        </td>
                        <td rowspan="2" style="width: 5%;">
                            Product Desc
                        </td>
                        <td rowspan="2" style="width: 5%;">
                            UOM
                        </td>
                        <td rowspan="2" style="width: 5%;">
                            Quantity
                        </td>
                        <td rowspan="2" style="width: 10%;" align="right">
                            Unit Price
                        </td>
                        <td rowspan="2" style="width: 10%;" align="right">
                            Amount
                        </td>
                        <td rowspan="2" style="width: 10%;" align="right">
                            Total Amount
                        </td>
                        <td>Delivery Details</td>
                        <td>Download File</td>
                        <td>View File</td>
                    </tr>
                    </thead>
                    <tbody  ng-init="totall = 0">
                    <tr ng-repeat="poapp in poeditamendment">
                        <td align="right">
                            {{$index+1}}
                        </td>
                        <td>
                            <span>{{poapp.productcategory_name}}</span>
                        </td>
                        <td>
                            <span>{{poapp.producttype_name}}</span>
                        </td>
                        <td>
                            <span>{{poapp.product_name}}</span>
                        </td>
                        <td>
                            <span>{{poapp.po_desc}}</span>
                        </td>
                        <td>
                            <span>{{poapp.podetails_uom}}</span>
                        </td>
                        <td align="right">
                            <form name="demoForm_form">
                                <input align="right" numbers-only style="width:102px" name="qty"
                                       ng-model="poapp.podetails_qty" class="form-control" required
                                       ng-disabled="pur.qty_match" min="1" max="500">
                                <div ng-messages="demoForm_form.qty.$error">
                                    <div ng-message="number">Should be a number</div>
                                    <div ng-message="max">your quantity order exceeds 10000</div>
                                    <div ng-message="min">your quantity should not be zero</div>
                                </div>
                            </form>
                        </td>
                        <td align="right" ng-hide="true">
                            <span>{{poapp.assetqty=poapp.podetails_qty -poapp.podetails_qtyold}}</span>
                        </td>
                        <td align="right" ng-hide="true">
                            <span>{{poapp.assetqtyminus=poapp.podetails_qtyold -poapp.podetails_qty}}</span>
                        </td>
                        <td align="right">
                            <span>{{poapp.podetails_unitprice| number:2}}</span>
                        </td>
                        <td align="right">
                            <span>{{poapp.podetails_amount = poapp.podetails_qty * poapp.podetails_unitprice| number:2}}</span>
                        </td>
                        <td align="right">
                            <span>{{poapp.podetails_totalamount = (poapp.podetails_qty * poapp.podetails_unitprice)| number:2 }}</span>
                        </td>
                        <td align="center">
                                        <span class="editlink"><a style="color:green;" ng-click="Addccbs($index,poapp)">
                                                <i class="material-icons">send</i></a>
                                            <md-tooltip>Send</md-tooltip>
                                        </span>
                        </td>
                         <td class="text-center">
                                 <span class="material-icons" ng-class="poapp.podetails_imagepath==' '? '':'editlink'"
                                  ng-click="clkdownload(poapp.podetails_imagepath)"
                                  title="{{poapp.podetails_imagepath==' ' ? 'No File To Download':'Download' +' '+ poapp.podetails_imagepath}}">get_app</span>
                            </td>
                            <td>
                                 <span class="material-icons" ng-class="poapp.podetails_imagepath==' '? '':'editlink'"
                                  onclick="clk()" ng-click="clkview(poapp.podetails_imagepath)"
                                  title="{{poapp.podetails_imagepath==' ' ? 'No File To View': 'View' +' '+ poapp.podetails_imagepath}}">touch_app</span>
                            </td>

                    </tr>
                    <tr ng-show="poapproval.length ==  0">
                        <td class="warning" colspan="9">
                            No Records Found.
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="9" align="right"> Total</td>
                        <td class="text-right" ng-bind="totalbilling(poeditamendment)">
                        <td ng-show="false" class="text-right" ng-bind="totalbillng(poeditamendment)">
                        <td ng-hide="true" class="text-right" ng-bind="totalqty(poeditamendment)">
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="col-md-row">
            <div class="col-md-12">
            <div class="text-right">
                <md-button ng-click="close()" class="md-raised">Close
                        <md-tooltip>Close</md-tooltip>
                    </md-button>
        <md-button class="md-raised custbutton" ng-click="Updateclk()">
            Update
        </md-button>
            </div>
            </div>
    </div>
</div>
</div>
</div>
{% endverbatim %}
<script>
        function zoomin() {
            var GFG = document.getElementById("zooming");
            var currWidth = GFG.clientWidth;
            GFG.style.width = (currWidth + 150) + "px";
        }
        function zoomout() {
            var GFG = document.getElementById("zooming");
            var currWidth = GFG.clientWidth;
            GFG.style.width = (currWidth - 150) + "px";
        }
        function clk(){
            var GFG = document.getElementById("zooming");
            var currWidth = GFG.clientWidth;
            GFG.style.width = (892) + "px";
        }
</script>
<script>
    var myApp = angular.module('Appprapproval', ['ngMaterial', 'ui.bootstrap', 'ngMessages','AppCommon']).config(function (
        $httpProvider) {
        $httpProvider.defaults.xsrfCookieName = 'csrftoken';
        $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
    });
    myApp.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "dd-MMM-yyyy");
    };
})

    myApp.controller('Ctrlprapproval', ['$scope', '$http', 'Servicepoamend', '$mdDialog', '$window', '$filter', '$q',
        '$timeout',
        function ($scope, $http, Servicepoamend, $mdDialog, $window, $filter, $q, $timeout) {
            $scope.currentPage = 1;
            $scope.maxSize = 3;
            $scope.itemsPerPage = 8;
            $scope.start = 0;
            $scope.end = 60;
            $scope.maintable = [];
            $scope.IsDisabled = false;

            $scope.loading = function () {
                $mdDialog.show({
                    templateUrl: 'loaderSpinner',
                    parent: angular.element(document.body),
                    clickOutsideToClose: false
                });
            };

            $scope.endloading = function () {
                $mdDialog.hide();
            };

           $scope.clkdownload = function(e){
            if(e!=" "){
            $window.location.href = "/common_downloadfile/?filename="+e;
            }
            else{
            return false;
            }
            }


            var detail = JSON.parse(sessionStorage.getItem('today'));
            $scope.employgid = detail.employee_gid;
            $scope.entity_gid = detail.entity_gid;
            $scope.empcode = detail.employee_code;
            $scope.pr_gid = sessionStorage.getItem('getdatas');


            var data = {"FILTER":{"poheader_gid":$scope.pr_gid},
            "CLASSIFICATION": {
                            "Entity_Gid": $scope.entity_gid
                        }
                        }

    var data = {
                    "Group":"MODIFICATION_AMENDMENT",
                    "Action": "GET",
                    "Type": "PO_TRAN",
                    "DETAIL": data
                }

            var get_prdetails = Servicepoamend.getpo_amend(data)
            get_prdetails.then(function (result) {
                // $scope.loading();
                $scope.poamendment = result.data.DATA;
                $scope.poeditamendment = [];
for(i=0;i<$scope.poamendment.length;i++){
var data = {
"prpoqty_prdetails_gid" : $scope.poamendment[i].prpoqty_prdetails_gid,
"productcategory_name": $scope.poamendment[i].productcategory_name,
"producttype_name": $scope.poamendment[i].producttype_name,
"product_name": $scope.poamendment[i].product_name,
 "podetails_gid": $scope.poamendment[i].podetails_gid,
 "podetails_imagepath": $scope.poamendment[i].podetails_imagepath,
    "product_status": "Y",
    "product_gid": ($scope.poamendment[i].podetails_product_gid).toString(),
    "podetails_uom": $scope.poamendment[i].podetails_uom,
    "podetails_unitprice": $scope.poamendment[i].podetails_unitprice,
    "podetails_amount": ($scope.poamendment[i].podetails_amount).toString(),
    "podetails_qty": ($scope.poamendment[i].podetails_qty).toString(),
    "podetails_qtyold": ($scope.poamendment[i].podetails_qty).toString(),
    "singleunittax": $scope.poamendment[i].podetails_taxamount/$scope.poamendment[i].podetails_qty,
    "podetails_taxamount": ($scope.poamendment[i].podetails_taxamount).toString(),
    "podetails_totalamount": ($scope.poamendment[i].podetails_totalamount).toString(),
    "product_remove": "",
    "Activity":"NO",
    "image": {},
    "delivery_details": JSON.parse($scope.poamendment[i].Delivery_Details),
    "file_path": JSON.parse($scope.poamendment[i].file_path),
    "poheader_no" :  $scope.poamendment[i].poheader_no
}
$scope.poeditamendment.push(data);
}


                $scope.product_gid = $scope.poamendment[0].product_gid;
                $scope.c_gid = $scope.poamendment[0].poheader_commodity_gid;
                $scope.chk.ddlstatus = $scope.poamendment[0].supplier_name;
                $scope.supplier_gid = $scope.poamendment[0].supplier_gid;
                    $scope.poheader_no =  $scope.poamendment[0].poheader_no;
                    $scope.poheader_date = $scope.poamendment[0].poheader_date;
                    $scope.poterms_gid = $scope.poamendment[0].poterms_gid
                    $scope.teamandcond_name = $scope.poamendment[0].poterms_name;
                        $scope.chk.branch_name = $scope.poamendment[0].branch_name;
                        $scope.chk.ddlstatus1 = $scope.poamendment[0].poterms_name;
                        $scope.poheader_amount = $scope.poamendment[0].poheader_amount;
                        $scope.poheader_amendment = $scope.poamendment[0].poheader_amendment; //check with params 1 or 2
                        $scope.chk.from_date = $scope.poamendment[0].poheader_validfrom;
                        $scope.chk.to_date= $scope.poamendment[0].poheader_validto;
                         $scope.chk.lim = $scope.poamendment[0].employee_name;
                         $scope.chk.emp_code = $scope.poamendment[0].employee_code;
                         $scope.tran_to =  $scope.poamendment[0].tran_from;
                         $scope.branch_gid = $scope.poamendment[0].poheader_branchgid;
                         $scope.poheader_mepno = $scope.poamendment[0].poheader_mepno;

                        getsupplier_data($scope.product_gid)
            }, function () {
                alert('no data');
            })


            $scope.submitclck_temp = function(){

            $scope.fulltemp = [];
            for(i=0;i<$scope.Add_Templates.length;i++){

            if($scope.Add_Templates[i].new_template!= ''){
            $scope.fulltemp.push($scope.Add_Templates[i].new_template)
            }


            }



            var data = {
                    "Params": {
                        "DETAIL": {
                            "Po_Gid": $scope.ddlpoterms.poterms_gid,
                            "Po_templatetype": $scope.ddlpoterms.poterms_value,
                            "Po_Details_Template": $scope.fulltemp
                        }
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": $scope.entity_gid
                    }
                }
                var data = {
                    "Action": "INSERT",
                    "Type": "PO_TERMS_TEMPLATE",
                    "DETAIL": data,
                }
                var set_state = Servicepoamend.set_poterms(data)
                set_state.then(function (result) {
                        $scope.prodge = result.data.DATA[0];
                        if ($scope.prodge == "SUCCESS") {
                            alert($scope.prodge);
                            $window.location.href = "editamendment";
                        } else {
                            alert($scope.prodge);
                        }
                    }, function (err) {
                        alert('No data!.');
                    })
                    .finally();
            };


$scope.poheaderfiles = function(e){
            $scope.posummary1 = e.file_path;
            if($scope.posummary1.length>0){
            if($scope.posummary1[0].file_path!= null){
            modalshow('viewprheader');
            }
            else{
            alert("No File for against "+e.poheader_no);
            }
            }
            }

            $scope.submitclck = function () {
                $scope.ary = [];
                for (i = 0; i < $scope.fulltemplate.length; i++) {
                    if ($scope.fulltemplate[i].Selected) {
                        var ary = {
                            "Gid": $scope.fulltemplate[i].potermstemplate_gid
                        }
                        $scope.ary.push(ary);
                    }
                }

                var data = {
                    "Params": {
                        "DETAIL": {
                            "Po_Name": $scope.po_name,
                            "Po_Details_Gid": $scope.ary,
                            "Po_Suppliergid": $scope.supplier_gid
                        }
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": $scope.entity_gid
                    }
                }
                var data = {
                    "Action": "INSERT",
                    "Type": "PO_TERMS",
                    "DETAIL": data,
                }
                var set_state = Servicepoamend.set_poterms(data)
                set_state.then(function (result) {
                        $scope.prodge = result.data[0];
                        if ($scope.prodge == "SUCCESS") {
                            alert($scope.prodge);
                            loadpoterm($scope.supplier_gid);
                        } else {
                            alert($scope.prodge);
                        }
                    }, function (err) {
                        alert('No data!.');
                    })
                    .finally();
            };


$scope.totalbilling = function(data) {
        var totall = 0;
        if (data) {
            if (data.length == 0) {
                return totall;
            } else {
                for (var i = 0; i < data.length; i++) {
                    totall = totall + data[i].podetails_totalamount;
                }
                $scope.poheader_totamount = totall;
                return totall;
            }
        } else {
            return totall;
        }
    }










$scope.totalqty = function(data) {
        var totall = 0;
        if (data) {
            if (data.length == 0) {
                return totall;
            } else {
                for (var i = 0; i < data.length; i++) {
                    totall = totall + data[i].podetails_qty;
                }
                $scope.po_header_qty = totall;
                return totall;
            }
        } else {
            return totall;
        }
    }




<!--Delivery details-->
$scope.Addccbs = function(indedx,e){

$scope.delivery_details = e.delivery_details;
modalshow('mdl_present1');
}


       $scope.cancel = function ($index) {
                    modalhide('mdl_present1');
            };

            $scope.saveccbsdata = function(){
                   modalhide('mdl_present1');
            }


     $scope.close = function () {
                sessionStorage.setItem('getdatas', '');
                $window.location.href = "poamendsmry";
            }

            $scope.clkview = function(e){
$scope.filename = e;
if($scope.filename != " "){
var data ={"Filename":e}
            var get_purchase = Servicepoamend.getviewfile(data)
                get_purchase.then(function (result) {
                    $scope.viewfilepath = result.data;
                    if($scope.viewfilepath != ''){
                    modalshow('viewprfile');
                    }
                }).finally($scope.endloading);
            }
            }

$scope.Updateclk = function(){
for(i=0;i<$scope.poeditamendment.length;i++){

if($scope.poeditamendment[i].assetqtyminus < 0 ){
alert("You Cannot Increase a Quantity against"+ ' '+ $scope.poeditamendment[i].product_name);
return false;
}
}

for(i=0;i<$scope.poeditamendment.length;i++){
$scope.delivery = $scope.poeditamendment[i].delivery_details;
 var total = 0;
for(j=0;j<$scope.delivery.length;j++){
 total += parseInt($scope.delivery[j].ccbs_qty);
}
if($scope.poeditamendment[i].podetails_qty != total){
alert('Given Quantity is not matched with Delivery Details');
return false;
}
}

fromdate = Date.parse($scope.chk.from_date);
todate = Date.parse($scope.chk.to_date);
headerdate = Date.parse($scope.poheader_date);

if($scope.chk.ddlstatus1.poterms_gid > 0){
$scope.poterms_gid = $scope.chk.ddlstatus1.poterms_gid;
}
else{
$scope.poterms_gid = $scope.poterms_gid;
}

if($scope.chk.branch_name.branch_gid > 0){
$scope.branch_gid = $scope.chk.branch_name.branch_gid;

}
else{
$scope.branch_gid = $scope.branch_gid;
}

if($scope.chk.lim.employee_gid > 0){
$scope.tran_to = $scope.chk.lim.employee_gid;
$scope.empcode = $scope.chk.lim.employee_code;
}
else{
$scope.tran_to = $scope.tran_to;
$scope.empcode = $scope.chk.emp_code;
}


for(i=0;i<$scope.poeditamendment.length;i++){

if($scope.poeditamendment[i].assetqty>0){
$scope.poeditamendment[i].Activity = 'ADD';

}
if($scope.poeditamendment[i].assetqty<0){
$scope.poeditamendment[i].assetqty = ($scope.poeditamendment[i].assetqty * -1);
$scope.poeditamendment[i].Activity = 'SUB';
}
}


var data={
   "FILTER": {
"Poheader_Gid":$scope.pr_gid,
"poheader_date":$filter('date')(headerdate, "yyyy-MM-dd"),
"poheader_supplier_gid":($scope.supplier_gid).toString(),
"poheader_poterms_gid": ($scope.poterms_gid).toString(),
"tran_to": ($scope.tran_to).toString(),
"poheader_amount": ($scope.poheader_totamount).toString(),
"poheader_commodity_gid": ($scope.c_gid).toString(),
"poheader_amendment": ($scope.poheader_amendment).toString(),
"poheader_status": "Pending for next level to "+$scope.empcode,
"poheader_validfrom": $filter('date')(fromdate, "yyyy-MM-dd"),
"poheader_no":$scope.poheader_no,
"poheader_validto": $filter('date')(todate, "yyyy-MM-dd"),
"poheader_branchgid": ($scope.branch_gid).toString(),
 "poheader_version":"1",
 "ref_name":"POMAKER",
"poheader_mepno": $scope.poheader_mepno,
"podetails": $scope.poeditamendment,
"Header_img":[]
},
 "CLASSIFICATION": {
                            "Entity_Gid": $scope.entity_gid
                        }

}

  var data = {
                    "Group":"UPDATE_AMENDMENT",
                    "Action": "SET",
                    "Type": "POHeader_UPDATE",
                    "DETAIL": data
                }
                var set_state = Servicepoamend.getpo_amend(data)
                set_state.then(function (result) {

                 if (result.data.MESSAGE == 'SUCCESS') {
                        alert(result.data.MESSAGE);
                        sessionStorage.removeItem('getdatas');
                        $window.location.href = "poamendsmry";
                    } else {
                        alert(result.data.MESSAGE);
                    }
                })
                .finally($scope.endloading);
            }





 $scope.totalsum=function()
         {

             var sum=0;
             $scope.array1.forEach(function(v)
             {
                    sum=sum+(((v.total_quatity * v.supplier_unit_price)*
                            (v.tax_amount))/100) + (v.total_quatity * v.supplier_unit_price)
             });
             return sum;
         }




 $scope.getsupper = getsupplier1;

            function getsupplier1(query) {
                var result = $filter('filter')($scope.SupplierData, {
                    'supplier_name': query
                });
                return result;
            }

            function getsupplier_data(e) {
                var data = {
                    "Params": {
                        "filter": {
                            "product_gid": e
                        },
                        "type": "SUPPLIER_PRODUCT_MAPPING",
                        "Action": "Get"
                    },
                }

                var get_supplier = Servicepoamend.Pr_approvalget(data)
                get_supplier.then(function (result) {
                        $scope.SupplierData = result.data.DATA;
                    }, function (err) {
                        alert('No data!.');
                    })
                    .finally();
            }


 //dropdown for appeoval
            $scope.getcust =function gotocust(query) {
               var data = {
                    'commodity_gid': $scope.c_gid,
                    "employee_name":'',
                    "employee_detail":query,
                    'Limit_Start': 0,
                    'Limit_End': 50,
                }
                var params1 = {
                    'params': data,
                    'action': 'limit',
                    'type': 'po_Dir_limit',
                    'amount': 0,
                }

            return $http.post(Appname + "/approvalview/", params1)
                    .then(function (data) {
                        $scope.limitamt_copy = JSON.parse(data.data);
                        return $scope.limitamt_copy;
                    });
            }
              $scope.check_radio = function () {
            $scope.ddlpoterms = "";
            $scope.po_name = '';
            $scope.Add_Templates = [];
            $scope.new_template = "";
                if ($scope.radio_data == "P") {
                    var e = $scope.radio_data;
                    $scope.create_temp = false;
                    getfulltemplate(e)
                } else if($scope.radio_data == "S") {
                    var e = $scope.radio_data;
                    $scope.create_temp = false;
                    getfulltemplate(e)
                }
                 else {
                    var e = $scope.radio_data;
                    $scope.create_temp = true;
                }
            }
$scope.Add_Templates = [];
            $scope.addintable = function(){

                        if ($scope.new_template != undefined) {
                var movie = [];
                movie.new_template = $scope.new_template;
                $scope.Add_Templates.push(movie);
                $scope.new_template = null;
            }

            }
            $scope.deletetemp = function(index){
            $scope.Add_Templates.splice(index, 1);
            }


            function getfulltemplate(e) {
                var data = {
                    "Params": {
                        "DETAIL": {
                            "potermstemplate_type": e
                        }
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": $scope.entity_gid
                    }
                }
                var data = {
                    "Action": "GET_ALLTEMPLATE",
                    "Type": "PO_TEMPLATE",
                    "DETAIL": data,
                }

                var set_state = Servicepoamend.set_poterms(data)
                set_state.then(function (result) {
                        if (result.data.MESSAGE == "FOUND") {
                            $scope.fulltemplate = result.data.DATA;
                        }
                    }, function (err) {
                        alert('No data!.');
                    })
                    .finally();
            }

$scope.addtermsandcond = function () {
                $scope.radio_data = "P"
                var e = $scope.radio_data;
                modalshow('potermview_modal');
                getfulltemplate(e)
            }

 $scope.getcond = getcondition;

$scope.getpoterm = getpoterm;
            $scope.PO_Terms = [{"poterms_name":"PRODUCTS","poterms_value":"P","poterms_gid":"1"},
            {"poterms_name":"SERVICES","poterms_value":"S","poterms_gid":"2"}]
              function getpoterm(query) {
                var result = $filter('filter')($scope.PO_Terms, {
                    'poterms_name': query
                });
                return result;
            }

            function getcondition(query) {
                var result = $filter('filter')($scope.POTerms_Condt, {
                    'poterms_name': query
                });
                return result;
            }
            loadpoterm(0)

            function loadpoterm(e) {
                var data = {
                    "Params": {
                        "DETAIL": {
                            "Po_Suppliergid": e
                        }
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": $scope.entity_gid
                    }
                }
                var data = {
                    "Action": "GET_ALLTERM",
                    "Type": "PO_TERMS",
                    "DETAIL": data
                }

                var set_state = Servicepoamend.set_poterms(data)
                set_state.then(function (result) {
                        if (result.data.MESSAGE == "FOUND") {
                            $scope.POTerms_Condt = result.data.DATA;
                        }
                    }, function (err) {
                        alert('No data!.');
                    })
                    .finally();
            }

  $scope.viewpo = function () {
  if($scope.chk.ddlstatus1.poterms_gid > 0){
$scope.poterms_gid = $scope.chk.ddlstatus1.poterms_gid;
}
else{
$scope.poterms_gid = $scope.poterms_gid;
}
                modalshow('potermview_template');
                var data = {
                    "Params": {
                        "DETAIL": {
                            "Po_termsgid": $scope.poterms_gid
                        }
                    },
                    "CLASSIFICATION": {
                        "Entity_Gid": $scope.entity_gid
                    }
                }
                var data = {
                    "Action": "VIEW_ALLTEMPLATE",
                    "Type": "PO_TERMSVIEW",
                    "DETAIL": data,
                }

                var set_state = Servicepoamend.set_poterms(data)
                set_state.then(function (result) {

                        if (result.data.MESSAGE == "FOUND") {
                            $scope.slectedtemplate = result.data.DATA;
                        }
                    }, function (err) {
                        alert('No data!.');
                    })
                    .finally();
            }


            $scope.getbranch= function goto(query) {
                       data = {
                    "Table_name": "gal_mst_tbranch",
                    "Column_1": "branch_gid,branch_code,branch_name",
                    "Column_2": "",
                    "Where_Common": "branch",
                    "Where_Primary": "code",
                    "Primary_Value": "",
                    "Search_Column_Name": query,
                    "Limits": 0 + "," + 30,
                    "Order_by": "gid"
                }

                return $http.post(Appname + "/prodget/", {
                        "data": data,
                        "Action": ''
                    })
                    .then(function (result) {

                        if (result.data.MESSAGE == "FOUND") {
                            $scope.brncode = result.data.DATA;
                        } else {
                            $scope.brncode = [];
                        }
                        return $scope.brncode;
                    });
            }






        }
    ]);

    myApp.service("Servicepoamend", function ($http) {
           this.getpo_amend = function (data) {
            var response = $http.post(Appname + "/getpoamend/", data)
            return response;
        }
                this.Pr_approvalget = function (data) {
            var response = $http.post(Appname + "/Pr_approvalget/", data)

            return response;
        }
                this.set_poterms = function (data) {
            var response = $http.post(Appname + "/setpoterms/", data)
            return response;
        }
             this.getviewfile = function (data) {
            var response = $http.post(Appname + "/common_viewfile/", data);
            return response;
        }
    });


</script>
{% endblock %}