{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} Budget Summary {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        .center_budget{
            text-align: center;
        }
        .right_budget{
            text-align: right;
        }
        .left_budget{
            text-align: left;
        }
    </style>




</head>

<body ng-app="Budget_Summary" ng-controller="myCtrl">
    <div class="maincontent">
        <div class="container container1">
            <div class="row">
                <div class="row-header col-lg-12 col-sm-12">
                    <h4>Budget Summary</h4>
                </div>
            </div>
            <!-- 1 row -->
            <div class="row">
                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="Fin-Year" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.pprbudget_finyear"
                                    md-items="item in fin_year | filter:finyear_searchText" md-min-length="0"
                                    md-no-cache="true" md-search-text="finyear_searchText"
                                    md-selected-item="finyear_selected" md-selected-item-change="" required=""
                                    md-has-not-found="true" tabindex="-1" class="ng-isolate-scope">
                                    <span md-highlight-text="finyear_searchText"
                                        md-highlight-flags="^i">{{item.pprbudget_finyear}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>


                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="Branch" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.branch_detail"
                                    md-items="item in branch_fun(branch_searchText)" md-min-length="0"
                                    md-no-cache="true" md-search-text="branch_searchText"
                                    md-selected-item="branch_selected" md-selected-item-change="" required=""
                                    md-has-not-found="true" tabindex="-1" class="ng-isolate-scope">
                                    <span md-highlight-text="branch_searchText"
                                        md-highlight-flags="^i">{{item.branch_detail}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>

                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="Sector" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.pprbudget_sectorname"
                                    md-items="item in sector | filter:sector_searchText" md-min-length="0"
                                    md-no-cache="true" md-search-text="sector_searchText"
                                    md-selected-item="sector_selected" md-selected-item-change="" required=""
                                    md-has-not-found="true" tabindex="-1" class="ng-isolate-scope">
                                    <span md-highlight-text="sector_searchText"
                                        md-highlight-flags="^i">{{item.pprbudget_sectorname}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>

                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="Business" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.pprbudget_bizname"
                                    md-items="item in bussiness | filter:business_searchText" md-min-length="0"
                                    md-no-cache="true" md-search-text="business_searchText"
                                    md-selected-item="business_selected" md-selected-item-change="" required=""
                                    md-has-not-found="true" tabindex="-1" class="ng-isolate-scope">
                                    <span md-highlight-text="business_searchText"
                                        md-highlight-flags="^i">{{item.pprbudget_bizname}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>
                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="BS" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.pprbudget_bsname"
                                    md-items="item in BS_item | filter:BS_text" md-min-length="0" md-no-cache="true"
                                    md-search-text="BS_text" md-selected-item="BS_selected" md-selected-item-change=""
                                    required="" md-has-not-found="true" tabindex="-1" class="ng-isolate-scope">
                                    <span md-highlight-text="BS_text"
                                        md-highlight-flags="^i">{{item.pprbudget_bsname}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>
                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="CC" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.pprbudget_ccname"
                                    md-items="item in CC_item | filter:CC_text" md-min-length="0" md-no-cache="true"
                                    md-search-text="CC_text" md-selected-item="CC_selected" md-selected-item-change=""
                                    required="" md-has-not-found="true" tabindex="-1" class="ng-isolate-scope">
                                    <span md-highlight-text="CC_text"
                                        md-highlight-flags="^i">{{item.pprbudget_ccname}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>
                <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <md-autocomplete md-clear-button="true" md-floating-label="Expense Group" ng-disabled=""
                                    md-input-maxlength="126" md-item-text="item.expense_head"
                                    md-items="item in Expense_item | filter:Expense_text" md-min-length="0"
                                    md-no-cache="true" md-search-text="Expense_text" md-selected-item="Expense_selected"
                                    md-selected-item-change="" required="" md-has-not-found="true" tabindex="-1"
                                    class="ng-isolate-scope">
                                    <span md-highlight-text="Expense_text"
                                        md-highlight-flags="^i">{{item.expense_head}}</span>
                                    <md-not-found>
                                        Not found.
                                    </md-not-found>
                                </md-autocomplete>
                            </div>
                            <div>
                                <div class="md-errors-spacer"></div>
                            </div>
                        </form>
                    </md-input-container>
                </div>
                <!-- <div class="col-lg-3 col-sm-3">
                    <md-input-container class="md-block inputcontainer md-input-has-placeholder md-input-has-value">
                        <form>
                            <div class="process">
                                <label>Expense Group</label>
                                <md-select ng-model="exp_gid_searchText" multiple="" ng-disabled="expenseBTN">
                                    <md-optgroup label="Expense Group">
                                        <md-option ng-value="item.expensegrp_gid" ng-repeat="item in Expence_BUSGID">
                                            {{item.expensegrp_name}}
                                        </md-option>
                                    </md-optgroup>
                                </md-select>
                            </div>
                        </form>
                    </md-input-container>
                </div> -->
                <div class="col-md-1">
                    <button class="md-fab md-mini md-primary custbutton md-button md-ink-ripple" type="button"
                        ng-click="Table_Content_Fun()" ng-disabled="" style="margin-top:15px" aria-label="Search"
                        md-labeled-by-tooltip="md-tooltip-3">
                        <md-icon class="ng-scope material-icons" role="img" aria-label="search">search</md-icon>
                    </button>
                </div>

                <div class="col-md-1 ">
                    <a>
                        <button class="md-fab md-mini md-primary custbutton md-button md-ink-ripple" type="button"
                            style="margin-top:15px" ng-click="redirect_page()" aria-label="Create New"
                            md-labeled-by-tooltip="md-tooltip-4">
                            <md-icon class="ng-scope material-icons" role="img" aria-label="add">add</md-icon>
                        </button>
                    </a>
                </div>
            </div>
            <!-- 2 row -->
            <div class="row">






            </div>

            <div class="row">

                <div class="col-md-12 col-lg-12 col-sm-12">
                    <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                        md-progress="deferred">

                        <thead>
                            <tr>
                                <th class="header">Fin-Year</th>
                                <th class="header">Month</th>
                                <th class="header">Quarterly</th>
                                <th class="header">Branch</th>
                                <th class="header">Sector</th>
                                <th class="header">Business</th>
                                <th class="header">BS</th>
                                <th class="header">CC</th>
                                <th class="header">Category</th>
                                <th class="header">Sub-Category</th>
                                <th class="header">GL.No</th>
                                <th class="header">Amount</th>

                            </tr>
                        </thead>

                        <tbody>
                            <tr ng-repeat="data in table_body">
                                <td class="center_budget">{{data.pprbudget_finyear}}</td>
                                <td class="center_budget">{{data.pprbudget_transactionmonth}}</td>
                                <td class="center_budget">{{data.pprbudget_quarter}}</td>
                                <td class="left_budget">{{data.branch_data}}</td>
                                <td class="center_budget">{{data.pprbudget_sectorname}}</td>
                                <td class="center_budget">{{data.pprbudget_bizname}}</td>
                                <td class="center_budget">{{data.pprbudget_bsname}}</td>
                                <td class="center_budget">{{data.pprbudget_ccname}}</td>
                                <td class="center_budget">{{data.cat_name}}</td>
                                <td class="center_budget">{{data.subcat_name}}</td>
                                <td class="center_budget">{{data.pprbudget_apsubcatgl}}</td>
                                <td class="right_budget">{{amount_money_convert(data.amount)}}</td>


                            </tr>
                        </tbody>

                    </table>
                </div>

            </div>


        </div>


        <script>
            var app = angular.module('Budget_Summary', ['ngMaterial', 'ui.bootstrap'], function ($httpProvider) {
                $httpProvider.defaults.xsrfCookieName = 'csrftoken';
                $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
            });

            app.controller('myCtrl', function ($scope,
                Budget_service, $rootScope, $http, $window, $mdDialog) {



                $scope.amount_money_convert = function (value) {
                    var value = (Number(value)).toLocaleString(
                        undefined, {
                            minimumFractionDigits: 2
                        }
                    );
                    return value
                }
                var detail = JSON.parse(sessionStorage.getItem('today'));
                employgid = detail.employee_gid;
                entitygid = detail.entity_gid;
                $scope.employgid = employgid;
                $scope.entitygid = entitygid;
                $scope.finyear_selected = ''
                $scope.branch_selected = ''
                $scope.sector_selected = ''
                $scope.business_selected = ''
                $scope.BS_selected = ''
                $scope.CC_selected = ''
                $scope.Expense_selected = ''


                //loader spinner start
                $scope.loading = function () {
                    $mdDialog.show({
                        templateUrl: 'loaderSpinner',
                        parent: angular.element(document.body),
                        clickOutsideToClose: false
                    });
                };
                $scope.loading_popup = function () {
                    $mdDialog.show({
                        templateUrl: 'loaderSpinner',
                        parent: angular.element(document.getElementById('view_pop_up')),
                        clickOutsideToClose: false
                    });
                };
                $scope.endloading = function () {
                    $mdDialog.hide();
                };
                //loader spinner ends

                $scope.FinYear_fun = function () {
                    var params = {
                        "Params": {},
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'FinYear_Fetch',
                        'Action': "GET",
                        'data': params
                    }

                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {
                        $scope.fin_year = response.data.DATA

                    })

                }

                $scope.branch_fun = function (query) {
                    $rootScope.fin_year_selected = $scope.searchText5;
                    var datas = {
                        params: {
                            "type": "Mode",
                            "Sub_Type": "Summary_new",
                            "FILTER": {
                                "Limit_Start": 0,
                                "Limit_End": 30,
                                "branch_name": "",
                                "branch_detail": query,
                                "branch_code": ""
                            },
                            "CLASSIFICATION": {
                                "Entity_Gid": [0]
                            }
                        }
                    };
                    return $http.post(Appname + '/classificationdata_get/', datas).then(function (data) {
                        var final_values = data.data.DATA;
                        return final_values;
                    });
                }
                $scope.Sector_Fun = function () {
                    var params = {
                        "Params": {},
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'Sector_Fetch',
                        'Action': "GET",
                        'data': params
                    }

                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {

                        $scope.sector = response.data.DATA

                    })
                }

                $scope.Bussiness_Fun = function () {
                    var params = {
                        "Params": {},
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'Business_Fetch',
                        'Action': "GET",
                        'data': params
                    }

                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {

                        $scope.bussiness = response.data.DATA

                    })
                }

                $scope.BS_Fun = function () {
                    var params = {
                        "Params": {},
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'Bs_Fetch',
                        'Action': "GET",
                        'data': params
                    }

                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {

                        $scope.BS_item = response.data.DATA

                    })
                }

                $scope.CC_Fun = function () {
                    var params = {
                        "Params": {},
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'CC_Fetch',
                        'Action': "GET",
                        'data': params
                    }

                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {

                        $scope.CC_item = response.data.DATA

                    })
                }

                $scope.Expense_Fun = function () {
                    var params = {
                        "Params": {},
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'Expense_grp',
                        'Action': "GET",
                        'data': params
                    }

                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {

                        $scope.Expense_item = response.data.DATA

                    })
                }







                $scope.Table_Content_Fun = function () {

                    var fin_year = check_null_undefind($scope.finyear_selected, 'pprbudget_finyear')
                    var branch = check_null_undefind($scope.branch_selected, 'branch_gid')
                    var sector = check_null_undefind($scope.sector_selected, 'pprbudget_sectorname')
                    var business = check_null_undefind($scope.business_selected, 'pprbudget_bizname')
                    var BS = check_null_undefind($scope.BS_selected, 'pprbudget_bsname')
                    var CC = check_null_undefind($scope.CC_selected, 'pprbudget_ccname')
                    var Expense_id = check_null_undefind($scope.Expense_selected, 'expense_gid')

                    var params = {
                        "Params": {
                            "fin_year": fin_year,
                            "Branch": branch,
                            "Sector": sector,
                            "Business": business,
                            "BS_name": BS,
                            "CC_name": CC,
                            "Expense_id": Expense_id
                        },
                        "Classification": {
                            "Entity_Gid": entitygid,
                            "Create_By": employgid
                        }
                    }

                    var url_parmas = {
                        'Group': 'SUMMARY',
                        'Action': "GET",
                        'data': params
                    }
                    // console.log(url_parmas)
                    $scope.loading()
                    var _api = Budget_service.budget_summary(url_parmas)
                    _api.then(function (response) {

                        console.log(response.data.DATA)
                        $scope.table_body = response.data.DATA
                        $scope.endloading()

                    })

                }

                function check_null_undefind(data, key) {

                    if (data == undefined || data == null || data == '') {
                        return data = String("")
                    }
                    return data[key]
                }
                // Filter Functions Calling
                $scope.FinYear_fun()
                $scope.Sector_Fun()
                $scope.Bussiness_Fun()
                $scope.BS_Fun()
                $scope.CC_Fun()
                $scope.Expense_Fun()
                $scope.Table_Content_Fun()



                // XL redirect_page
                $scope.redirect_page = function () {
                    $window.location.href = "budget_excel";
                }

            });
            app.service('Budget_service', function ($http) {
                this.budget_summary = function (params) {
                    var response = $http.post(Appname + "/ppr_budget_get_summary/", params);
                    return response;
                }

            });
        </script>


        {% endverbatim %}
</body>
{% endblock content %}

</html>