{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %}New Overall Report{% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<div class="maincontent">
    <div class="container container1" ng-app="Appemployee" ng-controller="Ctrlemployee">
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <div class="col-lg-10 col-sm-10">
                    <h4><strong> New Overall Report</strong></h4>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <form name="myform">
                    <div class="col-md-3">
                        <md-autocomplete
                                md-clear-button="true" md-floating-label="Module Name"

                                md-input-maxlength=126
                                md-item-text="item.module_name"
                                md-items="item in get_data_eb(searchdata)"
                                md-selected-item-change="changed_data(item)"
                                md-min-length=0 md-search-text="searchdata"
                                md-no-cache="true" size="5"
                                md-selected-item="selected_data_electricity" required>
                            <md-item-template>
                                <span md-highlight-text="searchdata"> {{item.module_name}}</span>
                            </md-item-template>
                            <md-not-found>
                                No Module Name matching "{{searchdata}}"
                                were
                                found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                    <div class="col-md-3">
                        <md-autocomplete
                                md-clear-button="true" md-floating-label="Report Name"
                                autocomplete="off"
                                md-input-maxlength=126
                                md-item-text="item.reportname_name"
                                md-items="item in get_data_report(searchdata_1)"
                                md-selected-item-change="changed_data_1(item)"
                                md-min-length=0 md-search-text="searchdata_1"
                                md-no-cache="true" size="5"
                                md-selected-item="selected_data_electricity_1" required>
                            <md-item-template>
                                <span md-highlight-text="searchdata_1"> {{item.reportname_name}}</span>
                            </md-item-template>
                            <md-not-found>
                                No Report Name matching "{{searchdata_1}}"
                                were
                                found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                    <!--                    <div class="col-md-3">-->
                    <!--                        <md-autocomplete-->
                    <!--                                md-clear-button="true" md-floating-label="Sub Report Name"-->
                    <!--                                autocomplete="off"-->
                    <!--                                md-input-maxlength=126-->
                    <!--                                md-item-text="item.reportemp_name"-->
                    <!--                                md-items="item in get_data_subreport(searchdata_2)"-->
                    <!--                                md-selected-item-change="changed_data_2(item)"-->
                    <!--                                md-min-length=0 md-search-text="searchdata_2"-->
                    <!--                                md-no-cache="true" size="5"-->
                    <!--                                md-selected-item="selected_data_electricity_2" required>-->
                    <!--                            <md-item-template>-->
                    <!--                                <span md-highlight-text="searchdata_2"> {{item.reportemp_name}}</span>-->
                    <!--                            </md-item-template>-->
                    <!--                            <md-not-found>-->
                    <!--                                No Sub Report Name matching "{{searchdata_2}}"-->
                    <!--                                were-->
                    <!--                                found.-->
                    <!--                            </md-not-found>-->
                    <!--                        </md-autocomplete>-->
                    <!--                    </div>-->
                </form>

            </div>
        </div>
        <div class="row table-responsive">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                       md-progress="deferred">
                    <thead class="header">
                    <tr>
                        <th>S.No</th>
                        <th>Column Name</th>
                        <th>Display Column</th>
                        <th>Parameter</th>
                        <!--                        <th>Operator</th>-->
                        <!--                        <th>Value 1</th>-->
                        <!--                        <th>Value 2</th>-->
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="pr in channel">
                        <td>
                            <center>{{$index+1}}</center>
                        </td>
                        <td align="center">{{pr.data}}</td>
                        <td align="center"><input type="checkbox"
                                                  ng-model="pr.ischecked"
                        ></td>
                        <td align="center"><input type="checkbox"
                                                  ng-model="pr.paramchecked"
                        ></td>
                        <!--                        <td>-->
                        <!--                            <md-autocomplete-->
                        <!--                                    md-clear-button="true" md-floating-label="Operators"-->
                        <!--                                    md-input-maxlength=40-->
                        <!--                                    md-item-text="item.data"-->
                        <!--                                    md-items="item in get_data_cycle(searchdatacycl)"-->
                        <!--                                    md-selected-item-change="change_operator(pr.selected_operator_cycle,$index)"-->
                        <!--                                    md-min-length=0 md-search-text="searchdatacycl"-->
                        <!--                                    md-no-cache="true"-->
                        <!--                                    md-selected-item="pr.selected_operator_cycle" ng-show="pr.ischecked" required>-->
                        <!--                                <md-item-template>-->
                        <!--                                    <span md-highlight-text="searchdatacycl"> {{item.data}}</span>-->
                        <!--                                </md-item-template>-->
                        <!--                                <md-not-found>-->
                        <!--                                    No operator matching "{{searchdatacycl}}"-->
                        <!--                                    were-->
                        <!--                                    found.-->
                        <!--                                </md-not-found>-->
                        <!--                            </md-autocomplete>-->
                        <!--                        </td>-->
                        <!--                        <td align="right">-->
                        <!--                                <input align="right" style="width:102px" name="qty" type="text"-->
                        <!--                                       ng-model="pr.whr_condition" class="form-control"-->
                        <!--                                       ng-blur="validation_condition($index,pr)" required-->
                        <!--                                       ng-show="pr.selec">-->
                        <!--                            <md-input-container ng-show="pr.selec_date" class="md-block inputcontainer">-->
                        <!--                                <label>From Date</label>-->
                        <!--                                <md-datepicker md-hide-icons="calendar" md-max-date="maxDate"-->
                        <!--                                               md-open-on-focus-->
                        <!--                                               ng-model="pr.from_date"></md-datepicker>-->
                        <!--                            </md-input-container>-->
                        <!--                        </td>-->
                        <!--                        <td align="right">-->
                        <!--                                <input align="right" style="width:102px" name="qty" type="text"-->
                        <!--                                       ng-model="pr.whr_condition_1" class="form-control"-->
                        <!--                                       ng-blur="validation_condition($index,pr)" required-->
                        <!--                                       ng-show="pr.selec_1">-->
                        <!--                            <md-input-container class="md-block inputcontainer" ng-show="pr.selec_date">-->
                        <!--                                <label>To Date</label>-->
                        <!--                                <md-datepicker md-hide-icons="calendar" md-max-date="maxDate"-->
                        <!--                                               md-open-on-focus-->
                        <!--                                               ng-model="pr.to_date"></md-datepicker>-->
                        <!--                            </md-input-container>-->
                        <!--                        </td>-->

                    </tr>
                    </tbody>
                    <tfoot>

                    <!--                    <tr>-->
                    <!--                        <td colspan="7">-->
                    <!--                                <ul uib-pagination total-items="Total_Length" ng-model="currentPage"-->
                    <!--                                    max-size="maxSize" ng-change="pageChanged()" class="pagination-sm"-->
                    <!--                                    boundary-links="true" items-per-page="itemsPerPage"></ul>-->
                    <!--                                </td>-->
                    <!--                            <td colspan="1">-->
                    <!--                                Total Count:{{Total_Length}}-->
                    <!--                            </td>-->

                    <!--                    </tr>-->

                    </tfoot>
                </table>
            </div>
        </div>
        <!--        <ul ng-repeat="pr in channel">-->
        <!--                    <li>{{pr.data}} <input type="checkbox"  ng-click="click_column(pr)"-->
        <!--                                   ng-model="pr.value"-->
        <!--                            ></li>-->

        <!--                </ul>-->
        <form name="ebform">
        <div class="col-md-2">
            <md-input-container class="md-block inputcontainer">
                <label>New Template Name</label>
                <input ng-model="new_temp_name"/>
            </md-input-container>
        </div>
        </form>
        <div class="col-md-2">
            <md-button
                    class="md-raised custbutton" class="btn btn-secondary" ng-click="save_details()"
                    ng-disabled="ebform.$invalid">Submit
                <md-tooltip>Submit</md-tooltip>
            </md-button>
        </div>
        <!--        <div class="col-md-2">-->
        <!--            <md-button class="md-fab md-mini md-primary custbutton" ng-click="downloadDetail()">-->
        <!--                <md-icon>cloud_download</md-icon>-->
        <!--                <md-tooltip>Download</md-tooltip>-->
        <!--            </md-button>-->
        <!--        </div>-->
        <!--        <md-button ng-show="shwdownload"-->
        <!--                   href="get_view_tble_1?Group=COMMON&Action={{nmeofreport}}&data={{onlydata}}&data_filter={{data_filter_report}}&data_filter_report={{data_filter}}&classification={{classification}}">-->
        <!--            Download-->
        <!--        </md-button>-->
        <!--outstanding filter-->

    </div>
</div>
{% endverbatim %}
<script>
    var myApp = angular.module('Appemployee', ['ngMaterial', 'ui.bootstrap', 'AppCommon'])
        .config(function($httpProvider) {
            $httpProvider.defaults.xsrfCookieName = 'csrftoken';
            $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
        });
myApp.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "dd-MMM-yyyy");
    };
})
myApp.controller('Ctrlemployee', ['$scope', 'overallreportServ', '$mdDialog', '$rootScope', '$window', '$filter','$http',
    function($scope, overallreportServ, $mdDialog, $rootScope, $window, $filter,$http) {
        var detail = JSON.parse(sessionStorage.getItem('today'));
        $scope.employgid = detail.employee_gid;
        $scope.entity_gid = detail.entity_gid;

        $scope.today = $filter('date')(new Date(),'yyyy-MM-dd _HH:mm ');
        $scope.loading = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.body),
                clickOutsideToClose: false
            });
        };
        $scope.endloading = function() {
            $mdDialog.hide();
        };





$scope.changed_data = function(e){
debugger;
$scope.module_gid = e.module_gid;
$scope.get_data_();
}

$scope.channel = [];
$scope.changed_data_2 = function(e){
$scope.Sub_report_gid = e.reportemp_gid;
var sub_report_column_list = JSON.parse(e.reportemp_column);
var reportemp_column = JSON.parse(e.reportemp_filter);
$scope.reportemp_column = reportemp_column['REPORT_FILTER'];
$scope.sub_report_column_list = sub_report_column_list['column_list'];
for (i=0;i<$scope.channel.length;i++){
for(j=0;j<$scope.sub_report_column_list.length;j++){
if($scope.sub_report_column_list[j].data == $scope.channel[i].data){
$scope.channel[i].ischecked = true;
}
}

    for(j=0;j<$scope.reportemp_column.length;j++){
        if($scope.reportemp_column[j].column_name == $scope.channel[i].data){

            $scope.channel[i].selected_operator_cycle = $scope.reportemp_column[j].value;
            $scope.channel[i].whr_condition = $scope.reportemp_column[j].Search_Value[0];
            $scope.change_operator($scope.reportemp_column[j],i)
        }
    }
}


}
        $scope.changed_data_1 = function(e){
        $scope.report_gid = e.reportname_gid;
<!--        $scope.subreport();-->
        $scope.nmeofreport = e.reportname_name;
        $scope.executiveList = "";
        var data={"REPORT_FILTER":[]
              }
                var data_int = {
                "Group": "COLUMN_FILTER",
                "Action":e.reportname_name,
                "data":data,
                "data_filter":{"column_filter":"ALL"},
                "data_filter_report" :{"column_list":[]},
                "classification":{"Entity_Gid":$scope.entity_gid,
                "Create_By": $scope.employgid}
                }
            var getemployee = overallreportServ.getemployee(data_int)
            getemployee.then(function(result) {
                $scope.executiveList = result.data['data'];
                for(i=0;i<$scope.executiveList.length;i++){
                    $scope.channel.push({'data':$scope.executiveList[i]});
                }
            }, function(err) {
                alert('No data!.');
            })
        }

$scope.change_operator = function(e,i){
debugger;
if(e == null){
$scope.channel[i].selec = false;
$scope.channel[i].selec_1 = false;
$scope.channel[i].selec_date = false;
return false;
}
if(e.value == 'DATE_BETWEEN'){
$scope.channel[i].selec_date = true
return false;
}
if(e.value == 'RANGE_BETWEEN'){
$scope.channel[i].selec = true
$scope.channel[i].selec_1 = true
return false;
}
if(e.value !='' ){
$scope.channel[i].selec = true
return false;
}

}


<!--var f = e.prdetails_gid;-->
<!--let index = $scope.listproductnamepo.findIndex( record => record.isChecked === false );-->
<!--for (i = 0; i < $scope.listproductnamepo.length; i++) {-->


<!--if(index == i){-->
<!--$scope.listproductnamepo[i].isChecked = true;-->
<!--}-->

$scope.shwdownload = false;
var maindet =[];
var column_store_data  =[];
      $scope.downloadDetail = function(){
      debugger;
         for(i=0;i<$scope.channel.length;i++){
         var ff = $scope.channel[i].selected_operator_cycle;
         if (($scope.channel[i].ischecked) && (ff != null)){
         if ($scope.channel[i].selected_operator_cycle['value'] !="DATE_BETWEEN"){
var data = {"column_name":$scope.channel[i].data,"Search_Value":[$scope.channel[i].whr_condition],"Operator":$scope.channel[i].selected_operator_cycle['value']}
}
if ($scope.channel[i].selected_operator_cycle['value'] !="RANGE_BETWEEN"){
var data = {"column_name":$scope.channel[i].data,"Search_Value":[$scope.channel[i].whr_condition],"Operator":$scope.channel[i].selected_operator_cycle['value']}
}
         if($scope.channel[i].selected_operator_cycle['value'] =="DATE_BETWEEN"){
var data = {"column_name":$scope.channel[i].data,"Search_Value":[formatStringDate($scope.channel[i].from_date, 'yyyy-mm-dd'),formatStringDate($scope.channel[i].to_date, 'yyyy-mm-dd')],"Operator":$scope.channel[i].selected_operator_cycle['value']}
}
        if($scope.channel[i].selected_operator_cycle['value'] =="RANGE_BETWEEN"){
var data = {"column_name":$scope.channel[i].data,"Search_Value":[$scope.channel[i].whr_condition,$scope.channel[i].whr_condition_1],"Operator":$scope.channel[i].selected_operator_cycle['value']}
}


           maindet.push(data);
           }
            $scope.onlydata = {"REPORT_FILTER":maindet};
           if ($scope.channel[i].ischecked){
           column_store_data.push($scope.channel[i].data.toString());
           }
           $scope.data_filter = {"column_list":column_store_data};
           $scope.data_filter_report = {"column_filter":"FILTER",
           "report_id":$scope.report_gid.toString() ,
           "Subrep_id":$scope.subreport_id,
           "Subrep_name":$scope.new_subreport_name};
         }

            var r = confirm("Are You Sure Want To Download ?");
            if (r == true) {
                $scope.shwdownload = true;
            }
            else{
               $scope.shwdownload = false;
            }
        }

$scope.executiveLi =[];

$scope.subreport = function(){
debugger;
var data={"REPORT_FILTER":[{
        "column_name":"reportemp_reportgid",
        "Search_Value":[$scope.report_gid],
        "Operator":"EQUAL_TO"}]}

                var data_int = {
                "Group": "NO_COLUMN",
                "Action":"Subreport_Get",
                "data":data,
                "data_filter_report" :{"column_list":""},
                "data_filter":{"column_filter":""},
                "classification":{"Entity_Gid":$scope.entity_gid,
                "Create_By": $scope.employgid}
                }
            var getemployee = overallreportServ.getemployee(data_int)
            getemployee.then(function(result) {
            debugger;
                $scope.sub_report_ary = result.data;
            }, function(err) {
                alert('No data!.');
            })
}
$scope.get_data_subreport = gotoGetsub;
            function gotoGetsub(query) {
        var result = $filter('filter')($scope.sub_report_ary, {
            'reportemp_name': query
        });
        return result;
    }

$scope.get_data_ = function(){
debugger;
                var data_int = {
                "Group": "NO_COLUMN",
                "Action":"REPORT_NAME_GET",
                "data":{"REPORT_FILTER":[]},
                "data_filter_report" :{"column_list":""},
                "data_filter":{"column_filter":"FILTER","rep_module_id":$scope.module_gid},
                "classification":{"Entity_Gid":$scope.entity_gid,
                "Create_By": $scope.employgid}
                }
            var getemployee = overallreportServ.getemployee(data_int)
            getemployee.then(function(result) {
            debugger;
                $scope.executiveLi = result.data;
            }, function(err) {
                alert('No data!.');
            })
        }

$scope.get_data_report = gotoGet;
            function gotoGet(query) {
        var result = $filter('filter')($scope.executiveLi, {
            'reportname_name': query
        });
        return result;
    }
$scope.click_column = function(e){

$scope.classification ={"Entity_Gid":$scope.entity_gid,
                "Create_By": $scope.employgid};

}
var onlydata= {};

$scope.validation_condition = function(index,pr){
<!--let data = {}-->

<!--data[pr.data]= pr.whr_condition-->
<!--angular.extend(onlydata, data);-->
<!--&lt;!&ndash;onlydata.push(data);&ndash;&gt;-->
<!--if (onlydata.length ==0){-->
<!--$scope.onlydata = {}-->
<!--}-->
<!--else{-->
<!--$scope.onlydata = onlydata-->
<!--}-->
}


     $scope.get_data_eb = function() {
          var data = {params:{"type":"","reason_json":{
                                    "Table_name":"rep_mst_tmodule",
                                    "Column_1":"module_gid,module_code,module_name",
                                    "Column_2":"",
                                    "Where_Common":"module",
                                    "Where_Primary":"",
                                    "Primary_Value":"",
                                    "Order_by":"gid"
                                    },}}
          return $http.post(Appname + '/Getreason_data/' , data).then(function(data) {

            var final_values=JSON.parse(data.data);
            console.log(final_values);
            return final_values;
          });
          }
           $scope.cycle_array = [{
        value: 'EQUAL_TO',
        data: 'EQUAL_TO'
    },{
        value: 'GREATER_THAN_OR_EQUAL_TO',
        data: 'GREATER_THAN_OR_EQUAL_TO'
    },{
        value: 'LESS_THAN_OR_EQUAL_TO',
        data: 'LESS_THAN_OR_EQUAL_TO'
    },{
        value: 'RANGE_BETWEEN',
        data: 'RANGE_BETWEEN'
    },{
        value: 'IN',
        data: 'IN'
    },{
        value: 'DATE_BETWEEN',
        data: 'DATE_BETWEEN'
    }]


var chckd = [];
var parmchckd = [];
         $scope.save_details = function(){

        for(i=0;i<$scope.channel.length;i++){
          if($scope.channel[i].ischecked){
            chckd.push($scope.channel[i].data);
          }
          if($scope.channel[i].paramchecked){
            parmchckd.push({"value":$scope.channel[i].data});
          }
        }




             var data_int = {
                "Group": "COMMON",
                "Action":"REP_TEMP_IN",
                "data":{"REPORT_FILTER":parmchckd},
                "data_filter_report" :{"column_list":chckd},
                "data_filter":{"module_id":$scope.module_gid,"report_id":$scope.report_gid,"rep_temp_name":$scope.new_temp_name},
                "classification":{"Entity_Gid":$scope.entity_gid,
                "Create_By": $scope.employgid}
                }

            var collection_save = overallreportServ.set_data(data_int)
            collection_save.then(function(result) {
            debugger;
                    var sechedule_ref = result.data[0];
                    if (sechedule_ref == 'SUCCESS') {
                        alert("Saved Successfully")
                        $window.location.href = "newovralreport";
                    } else {
                        alert(sechedule_ref);
                    }
                },
                function() {
                    alert("Data Not Inserted!.");
                });
        }




<!--           $scope.get_data_cycle = Change_Cate_cycle;-->
<!--            function Change_Cate_cycle(query) {-->
<!--               var result = $filter('filter')($scope.cycle_array, {-->
<!--               'value': query-->
<!--                 });-->
<!--               return result;-->
<!--       }-->



    }

]);
myApp.service("overallreportServ", function($http) {
    this.getemployee = function(jsonData) {
        var response = $http.post(Appname + "/get_view_tble/",
            jsonData
        );
        return response;
    }
    this.set_data = function(jsonData) {
        var response = $http.post(Appname + "/set_reportdata/",
            jsonData
        );
        return response;
    }

     this.getdata = function(jsonData) {
        var response = $http.post(Appname + "/prodget/",
            jsonData
        );
        return response;
    }

});


</script>
{% endblock %}
