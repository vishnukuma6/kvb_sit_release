{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %} Premises Creation {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}
<div class="maincontent">
    <div ng-app="App_maker_summary" ng-controller="Ctrl_amc_maker" class="container container1">
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>Premises Creation </h4>
            </div>
        </div>
        <form name="premises_form" novalidate>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>Premises ID</label>
                            <input ng-model="pre_code" ng-disabled="execute_premises!='0'"
                                   maxlength="60" required/>
                        </md-input-container>
                    </div>
                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>Premises Name</label>
                            <input ng-model="pre_name"
                                   maxlength="60" required/>
                        </md-input-container>
                    </div>

                    <div class="col-md-3">
                        <md-input-container class="md-block inputcontainer">
                            <label>Total Rentable Area(sq ft)</label>
                            <input ng-model="pre_area" valid-number only-numbers
                                   maxlength="60"/>
                        </md-input-container>
                    </div>

                    <div class="col-md-3">
                        <md-autocomplete md-clear-button="true"
                                         md-floating-label="Controlling Office"
                                         md-item-text="item1.branch_name"
                                         md-items="item1 in controll_office(search_controll_office)"
                                         md-menu-class="md-virtual-repeat-container"
                                         md-min-length=0
                                         md-no-cache="true"
                                         md-search-text="search_controll_office"
                                         md-selected-item="pre_controll_office"
                                         md-selected-item-change="Control_Office_Change(item1.branch_gid)">
                            <md-item-template>
                                <span md-highlight-text="search_controll_office"> {{item1.branch_name}} - {{item1.branch_code}} </span>
                            </md-item-template>
                            <md-not-found>
                                No Branch matching "{{search_controll_office}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div ng-include="'empadrs'"></div>
                </div>
            </div>
            <br/>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-4"></div>
                    <div class="col-md-2" ng-hide="execute_premises!='0' || Page_Name=='Premises_Approval_Summary'">
                        <md-button class="md-raised custbutton" value="submit"
                                   ng-click="save_premises('NEW')" ng-disabled="premises_form.$invalid">
                            Save
                        </md-button>
                    </div>
                    <div class="col-md-1" ng-hide="execute_premises!='0'">
                        <md-button class="md-raised md-warn" value="close" ng-click="close_page()"
                                   aria-label="Close">Back
                        </md-button>
                    </div>
                    <div class="col-md-2">
                        <a ng-click="add_document()">
                            <md-button type="submit" class="md-raised md-primary">
                                <!--                                <md-icon>add</md-icon>-->Add Document
                                <md-tooltip>Document</md-tooltip>
                            </md-button>
                        </a>
                    </div>
                    <div class="col-md-2" ng-hide="execute_premises=='0' || Page_Name=='Premises_Approval_Summary'">
                        <a ng-click="session_set('UNIT',0)">
                            <md-button type="submit" class="md-raised md-primary">
                                <!--                                <md-icon>add</md-icon>-->Add Occupancy Details
                                <md-tooltip>Add Occupancy Details</md-tooltip>
                            </md-button>
                        </a>
                    </div>
                    <div class="col-md-2" ng-hide="execute_premises=='0' || Page_Name=='Premises_Approval_Summary'">

                        <a ng-click="session_set('PROPERTY',0)">
                            <md-button type="submit" class="md-raised md-primary">
                                <!--                                <md-icon>add</md-icon>-->
                                Add Lease Details
                                <md-tooltip>Add Lease Details</md-tooltip>
                            </md-button>
                        </a>
                    </div>

                </div>
            </div>
        </form>
        <div class="row" ng-hide="execute_premises=='0'">
            <div class="col-md-12">
                <form name="bill" novalidate>
                    <div ng-cloak="" class="tabsdemoDynamicHeight">
                        <md-content>
                            <md-tabs md-dynamic-height="" md-border-bottom="">
                                <md-tab label="Occupancy Details">
                                    <md-content class="md-padding">
                                        <div class="row table-responsive">
                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                <div class="row table-responsive">
                                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                                        <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                                               md-progress="deferred">
                                                            <thead class="header">
                                                            <tr>
                                                                <th>S.No</th>
                                                                <th>Occupancy ID</th>
                                                                <th>Occupancy Usage</th>
                                                                <th>Ownership</th>
                                                                <th>Floor/s located</th>
                                                                <th>Action</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            <tr align="center"
                                                                ng-repeat="unit in premises_unit_details.slice(((unit_currentPage-1)*unit_itemsPerPage),((unit_currentPage)*unit_itemsPerPage)) | filter:search:strict">
                                                                <td>
                                                                    <center>
                                                                        {{((unit_currentPage-1)*unit_itemsPerPage)+$index+1}}
                                                                    </center>
                                                                </td>
                                                                <td>{{unit.unit_no}}</td>
                                                                <td>{{unit.occupancy_usage}}</td>
                                                                <td>{{unit.occupancy_ownership}}</td>
                                                                <td>{{unit.unit_floor}}</td>
                                                                <td class="text-center">
                                                                    <a href=""
                                                                       title="View Data"
                                                                       ng-click="session_set('UNIT',unit.unit_gid)"
                                                                       align="center">
                                                                        <i class="material-icons">edit</i>
                                                                    </a>
                                                                </td>
                                                            </tr>
                                                            <tr ng-show="premises_unit_details.length == 0">
                                                                <td class="warning" colspan="11">
                                                                    No Records Found.
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                            <tfoot>
                                                            <tr align="center">
                                                                <td colspan="4">
                                                                    <ul uib-pagination
                                                                        total-items="premises_unit_details.length"
                                                                        ng-model="unit_currentPage"
                                                                        max-size="unit_maxSize"
                                                                        class="pagination-sm"
                                                                        boundary-links="true"
                                                                        items-per-page="unit_itemsPerPage"></ul>
                                                                </td>
                                                                <td colspan="2">
                                                                    Total Records:{{premises_unit_details.length}}
                                                                </td>
                                                            </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </md-content>
                                </md-tab>
                                <md-tab label=" Lease Details">
                                    <md-content class="md-padding">
                                        <div class="row table-responsive">
                                            <div class="col-md-12 col-lg-12 col-sm-12">
                                                <div class="row table-responsive">
                                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                                        <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                                               md-progress="deferred">
                                                            <thead class="header">
                                                            <tr>
                                                                <th>S.No</th>
                                                                <th>Landlord Property ID</th>
                                                                <th>Landlord Property Details</th>
                                                                <th>Total Sqft</th>
                                                                <th>Primary Contact</th>
                                                                <th>Action</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            <tr align="center"
                                                                ng-repeat="property in premises_property_details.slice(((property_currentPage-1)*property_itemsPerPage),((property_currentPage)*property_itemsPerPage)) | filter:search:strict">
                                                                <td>
                                                                    <center>
                                                                        {{((property_currentPage-1)*property_itemsPerPage)+$index+1}}
                                                                    </center>
                                                                </td>
                                                                <td>{{property.property_no}}</td>
                                                                <td>{{property.property_name}}</td>
                                                                <td>{{property.property_totsqrft}}</td>
                                                                <td>{{property.property_primarycontact}}</td>
                                                                <td class="text-center">
                                                                    <a href=""
                                                                       title="View Data"
                                                                       ng-click="session_set('PROPERTY',property.property_gid,property.property_name)"
                                                                       align="center">
                                                                        <i class="material-icons">edit</i>
                                                                    </a>
                                                                </td>
                                                            </tr>
                                                            <tr ng-show="premises_property_details.length == 0">
                                                                <td class="warning" colspan="11">
                                                                    No Records Found.
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                            <tfoot>
                                                            <tr align="center">
                                                                <td colspan="4">
                                                                    <ul uib-pagination
                                                                        total-items="premises_property_details.length"
                                                                        ng-model="property_currentPage"
                                                                        max-size="property_maxSize"
                                                                        class="pagination-sm"
                                                                        boundary-links="true"
                                                                        items-per-page="property_itemsPerPage"></ul>
                                                                </td>
                                                                <td colspan="2">
                                                                    Total Records:{{premises_property_details.length}}
                                                                </td>
                                                            </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </md-content>
                                </md-tab>
                            </md-tabs>
                        </md-content>
                    </div>
                </form>
            </div>
        </div>
        <div class="row" ng-hide="execute_premises=='0'">
            <div class="col-md-12 text-center">
                <md-button ng-show="Page_Name != 'Premises_Approval_Summary'"
                           class="md-raised custbutton" value="submit"
                           ng-disabled=""
                           ng-click="save_premises('MOVE_TO_APPROVAL')">
                    Move To Approval
                </md-button>
                <md-button ng-show="Page_Name !='Premises_Approval_Summary'"
                           class="md-raised custbutton" value="Update"
                           ng-click="save_premises('UPDATE')"
                           ng-disabled="">
                    Update
                </md-button>
                <md-button ng-show="Page_Name == 'Premises_Approval_Summary'" class="md-raised custbutton"
                           value="submit"
                           ng-disabled=""
                           ng-click="save_premises('APPROVE')">
                    Approve
                </md-button>
                <md-button class="md-raised md-warn" value="close" ng-click="close_page()"
                           aria-label="Close">Cancel
                </md-button>
            </div>
        </div>

        <div class="modal fade" id="doc_popup" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="exampleModalLabels3">
                            ADD Document
                            <button type="button" class="close" data-dismiss="modal"
                                    ng-click=""
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="body">
                        <br/>
                        <div class="row" ng-hide="selected_dropdown_gid=='0'">
                            <form name="document_form" novalidate>
                                <div class="col-md-12">
                                    <div class="col-md-3">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>Document Type</label>
                                            <md-select md-container-class="popup_select"
                                                       ng-required="true"
                                                       ng-model="all_data.document_type">
                                                <md-option ng-repeat="d in document_data"
                                                           ng-value="d.dropdowndetails_gid">
                                                    {{d.dropdowndetails_name}}
                                                </md-option>
                                            </md-select>
                                        </md-input-container>
                                    </div>
                                    <div class="col-md-3">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>Document Ref</label>
                                            <md-select md-container-class="popup_select"
                                                       ng-required="true"
                                                       ng-model="all_data.document_ref">
                                                <md-option ng-repeat="d in document_ref"
                                                           ng-value="d.dropdowndetails_gid">
                                                    {{d.dropdowndetails_name}}
                                                </md-option>
                                            </md-select>
                                        </md-input-container>
                                    </div>
                                    <div class="col-md-3">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>OCCUPANCY/LANDLORD LEASE ID</label>
                                            <input ng-model="all_data.lease_id" required valid-number only-numbers
                                                   maxlength="15"/>
                                        </md-input-container>
                                    </div>
                                    <div class="col-md-3">
                                        <md-input-container class="md-block inputcontainer">
                                            <label>Remarks</label>
                                            <input ng-model="all_data.remarks" required
                                                   maxlength="1024"/>
                                        </md-input-container>
                                    </div>
                                    <div class="col-md-2" style="margin-top: 35px;"
                                         ng-hide="update=='not_edit' || update=='edit'">
                                        <input class="ng-isolate-scope" file-model="files"
                                               fileinput="file" id="file" multiple type="file"
                                               onchange="angular.element(this).scope().imageUpload(event)"/>
                                    </div>
                                    <div class="col-md-2" style="margin-top: 35px;" ng-show="image_visible=='true'">
                                        <button type="button" class="btn btn-info" ng-hide="update=='not_edit'"
                                                ng-click="view_images_popup()">View Images
                                        </button>
                                    </div>
                                </div>
                                <div class="row" ng-hide="Page_Name=='Premises_Approval_Summary'">
                                    <div class="col-md-offset-5">
                                        <div class="col-md-4">
                                            <md-button class="md-raised custbutton" value="submit"
                                                       ng-disabled="document_form.$invalid"
                                                       ng-click="save_document('DOCUMENT')">
                                                Save
                                            </md-button>

                                            <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                                       aria-label="Close">Cancel
                                            </md-button>
                                        </div>

                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-12">
                            <div class="row table-responsive">
                                <div class="col-md-12 col-lg-12 col-sm-12">
                                    <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                           md-progress="deferred">
                                        <thead class="header">
                                        <tr>
                                            <th>S NO</th>
                                            <th>Document Type</th>
                                            <th>Document Ref</th>
                                            <th>Document Landlord Lease ID</th>
                                            <th>Remarks</th>
                                            <th>View Document</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr align="center"
                                            ng-repeat="document in document_details.slice(((document_currentPage-1)*document_itemsPerPage),((document_currentPage)*document_itemsPerPage)) | filter:search:strict">
                                            <td>
                                                <center>
                                                    {{((document_currentPage-1)*document_itemsPerPage)+$index+1}}
                                                </center>
                                            </td>
                                            <td>{{document.document_type_name}}</td>
                                            <td>{{document.document_ref_name}}</td>
                                            <td>{{document.document_ref_tablegid}}</td>
                                            <td>{{document.document_remarks}}</td>
                                            <td align="center">
                                                <a href="" ng-click="view_attached_file(document)"> VIEW DOCUMENT </a>
                                            </td>

                                        </tr>
                                        <tr ng-show="document_details.length ==  0">
                                            <td class="warning" colspan="12">
                                                No Records Found.
                                            </td>
                                        </tr>
                                        </tbody>
                                        <tfoot>
                                        <tr align="center">
                                            <td colspan="5">
                                                <ul uib-pagination total-items="document_details.length"
                                                    ng-model="document_currentPage"
                                                    max-size="document_maxSize"
                                                    class="pagination-sm"
                                                    boundary-links="true"
                                                    ng-change="pageChanged()"
                                                    items-per-page="document_itemsPerPage"></ul>
                                            </td>
                                            <td colspan="2">
                                                Total Count:{{document_details.length}}
                                            </td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!--                            <div class="col-md-offset-6">-->
                            <!--                                <md-button class="md-raised md-warn" value="close" data-dismiss="modal"-->
                            <!--                                           aria-label="Close">Cancel-->
                            <!--                                </md-button>-->
                            <!--                            </div>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="view_images" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="exampleModalLabels2">
                            ALL IMAGES
                            <button type="button" class="close" data-dismiss="modal"
                                    ng-click="close_pr_popup()"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="center" ng-show="file_path.length=='0'">
                                    <h3>No Attached File</h3>
                                </div>
                                <div class="col-md-offset-10" ng-show="file_path.length!='0'">

                                    <span class="editlink" ng-click="remove_all_files()">
                               <span class="material-icons removelink">delete</span>
                                <md-tooltip>Remove All</md-tooltip>
                                </span>
                                    <span>Remove All</span>
                                </div>
                                <div ng-repeat="files in file_path">
                                    <div class="col-md-10">
                                        <img src="{{files}}" alt="{{files}}"
                                             class="myimage img-responsive thumbnail">
                                        <hr/>
                                    </div>
                                    <div class="col-md-2" style="margin-top:200px;">
                                        <span class="editlink" ng-click="delete_one_file($index)">
                                        <span class="material-icons removelink">delete</span>
                                        </span>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-offset-6">
                                <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                           aria-label="Close">Cancel
                                </md-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="view_attached_file" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:70%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="exampleModalLabelss">
                            Attached File
                            <button type="button" class="close" data-dismiss="modal"
                                    ng-click="close_pr_popup()"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="body">
                        <div class="row table-responsive">
                            <div class="col-md-12 col-lg-12 col-sm-12">
                                <div class="row table-responsive">
                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                        <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                               md-progress="deferred">
                                            <thead class="header">
                                            <tr>
                                                <th>S.No</th>
                                                <th>Fine Name</th>
                                                <th>View File</th>
                                                <th>Download File</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr align="center"
                                                ng-repeat="file in ecf_all_files.slice(((currentPages-1)*itemsPerPages),((currentPages)*itemsPerPages)) | filter:search:strict">
                                                <td>{{((currentPages-1)*itemsPerPages)+$index+1}}
                                                </td>
                                                <td align="left">{{file.file_name}}</td>
                                                <td><span class="editlink material-icons"
                                                          ng-click="view_file(file)">insert_photo
                                                        </span>
                                                </td>
                                                <td>
                                                    <md-button class="md-icon-button md-primary" aria-label="Settings"
                                                               href="common_s3_file_download?filename={{file.file_name}}">
                                                        <md-icon>get_app</md-icon>
                                                        <md-tooltip>Download File</md-tooltip>
                                                    </md-button>
                                                </td>
                                            </tr>
                                            <tr ng-show="ecf_all_files.length == 0">
                                                <td class="warning" colspan="11">
                                                    No Records Found.
                                                </td>
                                            </tr>
                                            </tbody>
                                            <tfoot>
                                            <tr align="center">
                                                <td colspan="3">
                                                    <ul uib-pagination
                                                        total-items="ecf_all_files.length"
                                                        ng-model="currentPages"
                                                        max-size="maxSizes"
                                                        class="pagination-sm"
                                                        boundary-links="true"
                                                        items-per-page="itemsPerPages"></ul>
                                                </td>
                                                <td colspan="2">
                                                    Total Count:{{ecf_all_files.length}}
                                                </td>
                                            </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-offset-6">
                                <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                           aria-label="Close">Cancel
                                </md-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="show_file" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="view_files">
                            {{url_data[0].file_name}}
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <br/>
                    <div class="body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-12" align="center">
                                    <img src="{{url_datas[0].file_path}}"
                                         alt="{{url_datas[0].file_name}}"
                                         class="img-thumbnail"
                                         align="center"
                                         ng-show="extension!='pdf'">
                                    <hr/>
                                </div>
                                <iframe src="{{pdf_file_url_path}}" frameborder="0"
                                        height="600px" width="97%" ng-show="extension=='pdf'"></iframe>

                            </div>
                            <div class="row">
                                <div class="col-md-offset-6">
                                    <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                               aria-label="Close">Cancel
                                    </md-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>
{% endverbatim %}
<script>
var myApp = angular.module('App_maker_summary', ['ngMaterial','ui.bootstrap','ngMessages','AppCommon']).config(function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});

myApp.run(function($mdDateLocale, $filter) {
    $mdDateLocale.formatDate = function(date) {
        return $filter('date')(date, "dd-MMM-yyyy");
    };
})

myApp.controller('Ctrl_amc_maker', ['$scope','premises_service','$mdDialog','$window','$filter','$http','$q','$sce',
function($scope,premises_service,$mdDialog,$window,$filter,$http,$q,$sce) {
    $scope.currentPage=1;
    $scope.maxSize=3;
    $scope.itemsPerPage=10;
    
    $scope.property_currentPage=1;
    $scope.property_maxSize=3;
    $scope.property_itemsPerPage=10;
    
    $scope.document_currentPage=1;
    $scope.document_maxSize=3;
    $scope.document_itemsPerPage=10;

    $scope.unit_currentPage=1;
    $scope.unit_maxSize=3;
    $scope.unit_itemsPerPage=10;

    $scope.maintable = [];
    $scope.premises_unit_details=[];
    $scope.premises_property_details=[];
    $scope.Branch_Premises_Gid=0;
    $scope.execute_premises=0;

    $scope.currentPages = 1;
        $scope.maxSizes = 3;
        $scope.itemsPerPages = 10;

    $scope.loading = function() {
        $mdDialog.show({
            templateUrl: 'loaderSpinner',
            parent: angular.element(document.body),
            clickOutsideToClose: false
        });
    };

    $scope.loading_document = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.getElementById('doc_popup')),
                clickOutsideToClose: false
            });
    };

    $scope.loading_view_attached_file = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.getElementById('view_attached_file')),
                clickOutsideToClose: false
            });
    };


    $scope.loading_show_file = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.getElementById('show_file')),
                clickOutsideToClose: false
            });
   };


    $scope.endloading = function() {
        $mdDialog.hide();
    };
    $scope.get_Premises_Data = function(){
        var datas = {"action":"GET","type":"BRANCH_EXPENSE_GID",
        "filter": {"Branch_Premises_Gid":"","Branch_Premises_Page":""}}

        var setcolumndata = premises_service.get_session_expense(datas);
            setcolumndata.then(function(result) {
            $scope.Branch_Premises_Gid=result.data.Branch_Premises_Gid;
            $scope.Page_Name=result.data.Branch_Premises_Page;
            console.log(result.data);
            if($scope.Branch_Premises_Gid!=0){
                $scope.execute_premises=1;
                $scope.get_premises_header();
                $scope.get_property_details();
                $scope.get_unit_details();
            }
        },
       function(err) {
            alert("No Premises Gid");
       }).finally($scope.endloading);
    }
    $scope.get_Premises_Data();

    $scope.get_premises_header=function(){
            $scope.loading();
             var datas={"group":"PREMISES","action":"GET","type":"PREMISES_DETAIL",
                    "filter":{"premisesgid":$scope.Branch_Premises_Gid}};
            var premises_data= premises_service.premises_process_get(datas);
            premises_data.then(function(result) {

                var res=result.data[0];
                $scope.premises_header=res;
                $scope.pre_code=res.premises_code;

                $scope.search_controll_office=res.branch_name;
                $scope.pre_controll_office= res.branch_name;
                $scope.pre_area=res.premises_totalarea;
                $scope.pre_name=res.premises_name;

                $scope.pre_controll_office_gid=res.premises_controloffice;

                $scope.add.addline=res.address_1;
                $scope.add.addline2=res.address_2;
                $scope.add.addline3=res.address_3;

                $scope.add.addselectedstate = res.address_state_gid;
                $scope.state_clk($scope.add.addselectedstate, 'address');
                $scope.add.addselecteddistrict = res.address_district_gid;
                $scope.district_clk($scope.add.addselecteddistrict, 'address');
                $scope.add.addselectedcity = res.address_city_gid;
                $scope.add.pincode1 = res.address_pincode;

                console.log($scope.premises_header);
            }, function(err) {
              alert('No Data');
            }).finally($scope.endloading);
     }

    $scope.get_property_details=function(){
             var datas={"group":"PREMISES","action":"GET","type":"PREMISES_PROPERTY",
                    "filter":{"premisesgid":$scope.Branch_Premises_Gid}};
             $scope.loading();
            var premises_property= premises_service.premises_process_get(datas);
            premises_property.then(function(result) {
                var res=result.data;
                $scope.premises_property_details=res;
                console.log($scope.premises_property_details);
            }, function(err) {
              alert('No Data');
            }).finally($scope.endloading);
     }

     $scope.get_unit_details=function(){
             var datas={"group":"PREMISES","action":"GET","type":"PREMISES_UNIT",
                    "filter":{"premisesgid":$scope.Branch_Premises_Gid}};
<!--             $scope.loading();-->
            var premises_property= premises_service.premises_process_get(datas);
            premises_property.then(function(result) {
                var res=result.data;
                $scope.premises_unit_details=res;
                console.log($scope.premises_unit_details);
            }, function(err) {
              alert('No Data');
            }).finally($scope.endloading);
     }

    $scope.add = [];
    $scope.pinchange = function(pincode, type) {
        var pincd = premises_service.getpincodeall(pincode)
        pincd.then(function(result) {
                if (type == 'address') {
                    var apincde = [];
                    apincde = JSON.parse(result.data);
                    $scope.add.addselectedstate = apincde[0].city_state_gid;
                    $scope.state_clk($scope.add.addselectedstate, 'address');
                    $scope.add.addselecteddistrict = apincde[0].pincode_district_gid;
                    $scope.district_clk($scope.add.addselecteddistrict, 'address');
                    $scope.add.addselectedcity = apincde[0].pincode_City_gid;
                    $scope.add.pincode1 = apincde[0].pincode_no;

                }
            }),
            function() {
                alert('No data!.');
            };
    };
    $scope.state_clk = function(state_gid, type) {
        debugger;
        var distddl = premises_service.getdistddl(state_gid)
        distddl.then(function(result) {
                if (type == 'address') {
                    $scope.adistrictddl = [];
                    $scope.adistrictddl = JSON.parse(result.data);
                } else {
                    $scope.distritddl = [];
                    $scope.distritddl = JSON.parse(result.data);
                }
            }),
            function() {
                alert('No data!.');
            };
    };
    $scope.district_clk = function(district_gid, type) {
        var ctyddl = premises_service.getcityddl(district_gid)
        ctyddl.then(function(result) {
                if (type == 'address') {
                    $scope.acity1 = [];
                    $scope.acity1 = JSON.parse(result.data);
                } else {
                    $scope.city1 = [];
                    $scope.city1 = JSON.parse(result.data);
                }
            }),
            function() {
                alert('No data!.');
            };
    };
    $scope.city_clk = function(city_gid, type) {
        var pincd = premises_service.getpincode(city_gid)
        pincd.then(function(result) {
                if (type == 'address') {
                    var apincde = [];
                    apincde = JSON.parse(result.data);
                    $scope.add.pincode1 = apincde[0].pincode_no;
                } else {
                    var pincde = [];
                    pincde = JSON.parse(result.data);
                    $scope.pcode = pincde[0].pincode_no;
                }
            }),
            function() {
                alert('No data!.');
            };
    };

    var sttddl = premises_service.getstateddl()
    sttddl.then(function(result) {
        $scope.stateddl = [];
        $scope.stateddl = JSON.parse(result.data);
        $scope.locstate = JSON.parse(result.data);
      }),
    function() {
        alert('no data');
    };


    var branchdata = premises_service.getbranch();
     branchdata.then(function(result) {
            $scope.branch_data_all = result.data.DATA;
      }, function(err) {
      alert(res);
    });

    $scope.controll_office = gotocity;
        function gotocity(query) {
            var result = $filter('filter')($scope.branch_data_all, {
                'branch_name': query
            });
            return result;
    }

    $scope.Control_Office_Change=function(data){
        debugger;
        if(data!=undefined){
        $scope.pre_controll_office_gid=data;
        }
    }

    $scope.save_premises=function(type){
        debugger;
        if(type=="NEW"){
            var datas={"group":"PREMISES","action":"INSERT","type":"PREMISES",
                "filter":{"premises_code":$scope.pre_code,
                "premises_name":$scope.pre_name,
                "totalarea":$scope.pre_area,
                "controloffice":$scope.pre_controll_office_gid,
                "premises_address":[{
                        "address1":$scope.add.addline,
                        "address2":$scope.add.addline2,
                        "address3":$scope.add.addline3,
                        "pincode":$scope.add.pincode1,
                        "district_gid":$scope.add.addselecteddistrict,
                        "city_gid":$scope.add.addselectedcity,
                        "state_gid":$scope.add.addselectedstate}]}};
        }
        else if(type=="MOVE_TO_APPROVAL"){
            var datas={"group":"PREMISES","action":"UPDATE","type":"MOVE_TO_APPROVE",
                "filter":{"premisesgid":$scope.Branch_Premises_Gid}};

        }
        else if(type=="APPROVE"){
            var datas={"group":"PREMISES","action":"UPDATE","type":"APPROVE",
                "filter":{"premisesgid":$scope.Branch_Premises_Gid}};
        }
        else if(type=="UPDATE"){
             var datas={"group":"PREMISES","action":"INSERT","type":"PREMISES",
                "filter":{"premises_gid":$scope.Branch_Premises_Gid,
                "premises_name":$scope.pre_name,
                "totalarea":$scope.pre_area,
                "controloffice":$scope.pre_controll_office_gid,
                "premises_address":[{
                        "address1":$scope.add.addline,
                        "address2":$scope.add.addline2,
                        "address3":$scope.add.addline3,
                        "pincode":$scope.add.pincode1,
                        "district_gid":$scope.add.addselecteddistrict,
                        "city_gid":$scope.add.addselectedcity,
                        "state_gid":$scope.add.addselectedstate}]}};

        }
        $scope.loading();
        var popup_data = premises_service.premises_process_set(datas);
        popup_data.then(function(result) {
            var res=result.data.MESSAGE;
            debugger;
             if (res=== "SUCCESS") {
                 alert("SUCCESS");
                 if($scope.Page_Name=="Premises_Summary"){
                     $window.location.href = "BranchExp/Br_Premises_Summary";
                 }
                else if($scope.Page_Name=="Premises_Approval_Summary"){
                    $window.location.href = "BranchExp/Br_Premises_Approval_Summary";
                }
            } else {
          alert(JSON.stringify(result.data));
          }
        }, function(err) {
          alert('Data Not Inserted');
        }).finally($scope.endloading);
    }

    $scope.session_set = function(page_type,property_gid,property_name) {
            debugger;
            if(property_gid!=undefined){
                if(page_type=="PROPERTY"){
                    var datas={"action":"SET","type":"BRANCH_EXPENSE_GID",
                                "filter":{"Premises_Property_Gid":property_gid,
                                "Premises_Property_Name":property_name
                                }};
                }
                else if(page_type=="UNIT"){
                    var datas={"action":"SET","type":"BRANCH_EXPENSE_GID",
                                "filter":{"Premises_Unit_Gid":property_gid}};
                }
                var asset = premises_service.set_session_expense(datas);
                    asset.then(function(result) {
                       if(result.data="SUCCESS"){
                            if(page_type=="PROPERTY"){
                                $window.location.href = "BranchExp/Br_Premises_Property_Details/ ";
                            }
                            else if(page_type=="UNIT"){
                                $window.location.href = "BranchExp/Br_Premises_Unit_Details/ ";
                            }
                       }
                    }).finally($scope.endloading);
            }
            else{
                alert("Property Missing!");
            }
    }
    $scope.close_page=function(){
        debugger;
        if($scope.Page_Name=="Premises_Summary"){
            $window.location.href = "BranchExp/Br_Premises_Summary";
        }
        else if($scope.Page_Name=="Premises_Approval_Summary"){

            $window.location.href = "BranchExp/Br_Premises_Approval_Summary";
        }

    }

    $scope.add_document=function(){
        var datas={"group":"PREMISES","action":"GET","type":"PREMISES_DOCUMENT",
                    "filter":{"premises_gid": $scope.Branch_Premises_Gid}};
        $scope.loading_document();
        var get_doc_data = premises_service.premises_process_get(datas);
        get_doc_data.then(function(result) {
            var res=result.data;
            $scope.document_details=res;
            console.log($scope.document_details);
        }, function(err) {
          alert('No Data');
        }).finally($scope.endloading);

        modalshow('doc_popup');

    }


        $scope.Doc_ref = [{
        id: 'OCCUPANCY',
        data: 'OCCUPANCY'
    }, {
        id: 'LANDLORD LEASE',
        data: 'LANDLORD LEASE'
    }];

    var doc_type = {
        "group":"PREMISES",
        "action":"GET",
        "type":"PREMISES_COMMON_DROPDOWN",
        "filter":{
            "dropdown_name": "Document Type"
        }
   }
   var get_doc_type = premises_service.premises_process_get(doc_type)
    get_doc_type.then(function(result) {
        $scope.document_data = result.data;
        console.log($scope.document_data);
    }),
    function() {
        alert('No Document Type Data');
    };


    var doc_ref = {
        "group":"PREMISES",
        "action":"GET",
        "type":"PREMISES_COMMON_DROPDOWN",
        "filter":{
            "dropdown_name": "Document Ref"
        }
   }
   var get_doc_type = premises_service.premises_process_get(doc_ref)
    get_doc_type.then(function(result) {
        $scope.document_ref = result.data;
        console.log($scope.document_ref);
    }),
    function() {
        alert('No Document Ref Data');
    };

    $scope.file_path="";
    $scope.file_count=0;
    $scope.file_stored_data=[];
    $scope.duplicate_images=1;
    $scope.number_of_message=1;

    $scope.loaddata = function(file_img,img, callback) {
            var deferred = $q.defer();
            var promise = deferred.promise;
            promise.then(function() {
                var file_img_length = document.getElementById('file').files.length;
                if(file_img_length!=0){
                    for(l=0;l<file_img_length;l++){
                        var file_img = document.getElementById('file').files[l];
                        var file_name=file_img.name;
                        $scope.new_file_name=file_img.name;
                        var imgs = new FormData();
                        imgs.append('file', file_img);
                        imgs.append('name', file_name);
                        $scope.duplicate_images=1;
                        for(var p=0;p<$scope.deleted_files.length;p++){
                            $scope.temp_file_names=$scope.deleted_files[p].file_names;
                            if($scope.new_file_name==$scope.temp_file_names){
                                $scope.duplicate_images=0;
                                $scope.file_count=$scope.file_count+1;
                            }
                        }
                        if(file_img!=undefined&&$scope.duplicate_images==1){
                          $scope.loading_document();
                             var upload = premises_service.save_files(imgs);
                             upload.then(function(result) {
                                $scope.all_datas= result.data;
                                if($scope.all_datas.status=="SUCCESS"){
                                $scope.file_count=$scope.file_count+1;
                                $scope.file_status=1;
                                $scope.file_stored_data.push($scope.all_datas);
                                }
                                else{
                                    $scope.file_status=2;
                                }
                                callback();
                            }).finally($scope.endloading);
                        }
                        else{
                            $scope.file_status=0;
                            callback();
                        }
                    }
                }
                 else{
                    alert("Please Attache File...");
                    $scope.file_status=0;
                    $scope.endloading();
                    callback();
                 }
            }).then(function() {
                // callback();
            });
            deferred.resolve();

    };
    $scope.file_status=0;

    $scope.save_document=function(type){
        debugger;
        if(type=="DOCUMENT"){
            if($scope.Branch_Premises_Gid!=0){

                var file_img = document.getElementById('file').files[0];
                $scope.list_of_files= document.getElementById('file').files.length;
                var img = new FormData();
                var UPLOAD_FILE="";

                if(file_img!=undefined){
                    $scope.file_status=0;
                    var file_name=file_img.name;

                    var filename = file_img.name;
                    var index = filename.lastIndexOf(".");
                    $scope.strsubstring = filename.substring(index, filename.length);

                    img.append('file', file_img);
                    img.append('name', filename);
                }

                $scope.loaddata(file_img,img, function() {
                    if($scope.file_status==1&&$scope.file_count==$scope.list_of_files){

                        var datas={"group":"PREMISES","action":"ANY","type":"PREMISES_DOCUMENT",
                        "filter":{"document_premisesgid":$scope.Branch_Premises_Gid,"document_type": $scope.all_data.document_type,
                        "document_ref_gid": $scope.all_data.document_ref,
                        "document_ref_tablegid":$scope.all_data.lease_id,
                        "document_filegid":1,"document_remarks":$scope.all_data.remarks,
                        "file_data":$scope.file_stored_data}};

                        $scope.loading_document();
                        var popup_data = premises_service.premises_process_set(datas);
                        popup_data.then(function(result) {
                            var res=result.data.MESSAGE;
                             if (res=== "SUCCESS") {
                                $scope.all_data={};
                                 alert("SUCCESS");
                                 if(type=="DOCUMENT"){
                                    $scope.add_document();
                                 }
                            } else {
                          alert(JSON.stringify(resutl.data));
                          }
                        }, function(err) {
                          alert('Data Not Inserted');
                        }).finally($scope.endloading);


                    }
                    else if($scope.file_status==2){
                            alert("File Upload Failed");
                    }
                    else if($scope.file_status==0 && $scope.file_path.length==0 && $scope.number_of_message==1){
                            alert("Please Attach File");
                            $scope.deleted_files=[];
                            $scope.number_of_message=$scope.number_of_message+1;
                            $scope.endloading();
                    }
                });



            }
        }
    }


    $scope.stepsModel=[];
    $scope.image_visible="false";

    $scope.imageUpload = function(event){
    debugger;
    $scope.stepsModel=[];
    $scope.filenames = [];
    $scope.image_visible ="true";
         var files = event.target.files; //FileList object
         for (var i = 0; i < files.length; i++) {
             var file = files[i];
                 var reader = new FileReader();
                 reader.onload = $scope.imageIsLoaded;
                 reader.readAsDataURL(file);
                 $scope.filenames.push(file.name);
         }
    }

    $scope.imageIsLoaded = function(e){
        $scope.$apply(function() {
            $scope.stepsModel.push(e.target.result);
            modalshow('view_payment_details');
        });
    }

    $scope.view_images_popup=function(){

        debugger;
        $scope.file_path = $scope.stepsModel;
        modalshow('view_images');
    }

    $scope.deleted_files=[];
    $scope.delete_one_file=function(index){
        debugger;
        $scope.file_imglength = document.getElementById('file').files.length;
        for(i=0;i<$scope.file_imglength;i++){
            if(i==index){
                $scope.file_path.splice(i, 1);
                var file_img = document.getElementById('file').files[i];
                var file_name=file_img.name;
                $scope.deleted_files.push({"file_names":file_name});
            }
        }
        if($scope.file_path.length==0){
            $scope.remove_all_files();
        }
    }

    $scope.remove_all_files=function(){
        $scope.file_path=[];
        $scope.deleted_files=[];
        elmn = angular.element( document.getElementById( 'file' ).files);
        elmn.remove();
        angular.element("input[type='file']").val(null);
        $scope.image_visible="false";
    }

    $scope.view_attached_file=function(document){
        debugger;

        var datas={params:{"action":"GET","type":"FILE_DETAIL",
            "filter":{"file_reftablegid":document.document_gid,"ref_name":"DOCUMENT_UPLOAD"}}};
        $scope.loading_view_attached_file();
         var ecf_file_data = premises_service.get_approval_summary(datas);
         ecf_file_data.then(function(result) {

                $scope.ecf_all_files = result.data;
                 modalshow('view_attached_file');

         },
         function(err) {
            alert('No data!.');
         }).finally($scope.endloading);

        }

        $scope.view_file=function(file_list){
        debugger;
        debugger;
        var datas={"file_data":[file_list]};
         $scope.loading_view_attached_file();
         var generated_urls = premises_service.get_generated_url_data(datas);
         generated_urls.then(function(result) {
                $scope.url_datas = result.data;
                $scope.file_url_path=$scope.url_datas[0].file_path;
                var final_file_name=$scope.url_datas[0].file_name;
                $scope.extension=final_file_name.substr(final_file_name.lastIndexOf('.')+1);
                if($scope.extension=="pdf"){
                    complete_url ='http://docs.google.com/gview?url=' + encodeURIComponent($scope.file_url_path) + '&embedded=true';
                    $scope.pdf_file_url_path = $sce.trustAsResourceUrl(complete_url);
                }
                 modalshow('show_file');
         },
         function(err) {
            alert('No data!.');
         }).finally($scope.endloading);
     }

     $scope.trustAsHtml = function(html) {
      return $sce.trustAsHtml(html);
    }


}]);
myApp.service("premises_service", function ($http) {


this.getpincodeall = function(pincode) {
        var response = $http.get(Appname + "/allpinget/", {
            params: {
                "pincode": pincode
            }
        });
        return response;
    }

    this.getdistddl = function(state_gid) {
        var response = $http.get(Appname + "/districtddl/", {
            params: {
                "state_gid": state_gid
            }
        });
        return response;
    }

    this.getcityddl = function(district_gid) {
        var response = $http.get(Appname + "/cityddl/", {
            params: {
                "district_gid": district_gid
            }
        });
        return response;
    }

    this.getpincode = function(city_gid) {
        var response = $http.get(Appname + "/pincode/", {
            params: {
                "city_gid": city_gid
            }
        });
        return response;
    }

    this.getstateddl = function(d) {
        var response = $http.get(Appname + "/stateddl/");
        return response;
    }

    this.premises_process_set=function (data) {
        var response=$http.post(Appname+"/Set_premises/",data);
        return response;
    }

    this.get_session_expense = function (data) {
        var response=$http.post(Appname+"/Session_Get_Expnese_Data/",data);
        return response;
    }

    this.premises_process_get=function (data) {
        var response=$http.post(Appname+"/Get_premises/",data);
        return response;
    }
    this.set_session_expense = function (data) {
        var response=$http.post(Appname+"/Session_Set_Expense_Data/",data);
        return response;
    }

    this.getbranch = function () {
        var response=$http.post(Appname+"/get_branch_data/");
        return response;
    }

    this.save_files=function(img){
          var response=$http.post(Appname+"/fileUploadS3/",img,
               {
                 transformRequest: angular.identity,
                 headers: {
                    'Content-Type': undefined
                 }
               }
          );
        return response;
    }

    this.get_generated_url_data=function(data){
        var response=$http.post(Appname+"/common_s3_file_url_generate/",data);
        return response;
    }

    this.get_approval_summary=function(data){
        var response=$http.post(Appname+"/get_onward_data/",data);
        return response;
    }


 });












































</script>
<style>
    .app-modal-window .modal-dialog {
    width: 1000px;
}

.md-virtual-repeat-container.md-autocomplete-suggestions-container {
     width:500px !important;
}


.C{
 background-color: #B3FFC1 !important;
}

.D{
 background-color: #FFBDF3 !important;
}







































</style>
{% endblock %}