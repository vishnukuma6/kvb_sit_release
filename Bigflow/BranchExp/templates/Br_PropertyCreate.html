{% extends 'Shared/mainLayout.html' %}
{% load static from staticfiles %}
{% block title %}Branch Property Create {% endblock %}
{% block content %}
{% csrf_token %}
{% verbatim %}

<div class="maincontent">
    <div ng-app="makersummary" ng-controller="ctrlsummary" class="container container1">
        <div class="row">
            <div class="row-header col-lg-12 col-sm-12">
                <h4>Branch Property Create</h4>
            </div>
        </div>
        <form role="form" name="pro_create" ng-disabled="update=='not_edit'">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-input-container class="md-block inputcontainer">
                            <label>Property Code</label>
                            <input ng-model="pro_code"
                                   ng-change="ACselectchange()" ng-disabled="true"
                                   maxlength="60"/>
                        </md-input-container>
                    </div>
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-input-container class="md-block inputcontainer">
                            <label>Property Name</label>
                            <input ng-model="pro_name"
                                   ng-change="ACselectchange(selectedtype)" ng-required="true"
                                   maxlength="60"/>
                        </md-input-container>
                    </div>
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-autocomplete
                                md-clear-button="true"
                                md-floating-label="Choose Property Type"
                                md-input-maxlength=126
                                md-item-text="itemc.metadata_value"
                                md-items="itemc in get_property(searchemp)"
                                md-selected-item-change="PropertyChanged(itemc.metadata_value)"
                                md-min-length=0
                                md-search-text="search_propery_type"
                                ng-model="itemc.metadata_value"
                                md-no-cache="true"
                                size="5"
                                ng-required="true"
                                md-selected-item="itemc.metadata_value">
                            <md-item-template>
                                <span md-highlight-text="searchTex"> {{itemc.metadata_value}}</span>
                            </md-item-template>
                            <md-not-found>
                                No Employee Name matching "{{Search Property}}" were
                                found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-input-container class="md-block inputcontainer">
                            <label>Landmark </label>
                            <input ng-model="pro_landmark"
                                   ng-change="ACselectchange(selectedtype,supplier_gid,invoicenum,invoiceamt,invdate,crno)"
                                   maxlength="255"/>
                        </md-input-container>
                    </div>
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-autocomplete md-clear-button="true"
                                         md-floating-label="Incharge"
                                         md-item-text="item.employee_name"
                                         md-items="item in getemployee_srch(search_incharge)"
                                         md-menu-class="md-virtual-repeat-container"
                                         md-min-length=0
                                         md-no-cache="true"
                                         ng-required="true"
                                         md-search-text="search_incharge"
                                         md-selected-item="selected_incharge"
                                         md-selected-item-change="Incharge_Change(item)">
                            <md-item-template>
                                <span md-highlight-text="search_incharge"> {{item.employee_name}} - {{item.employee_code}} </span>
                            </md-item-template>
                            <md-not-found>
                                No Employee matching "{{search_incharge}}" were found.
                            </md-not-found>
                        </md-autocomplete>

                    </div>
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-autocomplete md-clear-button="true"
                                         md-floating-label="Alternative Incharge"
                                         md-item-text="item.employee_name"
                                         md-items="item in getemployee_srch(search_alter_incharge)"
                                         md-menu-class="md-virtual-repeat-container"
                                         md-min-length=0
                                         md-no-cache="true"
                                         ng-required="true"
                                         md-search-text="search_alter_incharge"
                                         md-selected-item="selected_alter_incharge"
                                         md-selected-item-change="Property_Alter_Incharge_Change(item)">
                            <md-item-template>
                                <span md-highlight-text="search_alter_incharge"> {{item.employee_name}} - {{item.employee_code}} </span>
                            </md-item-template>
                            <md-not-found>
                                No Employee matching "{{search_alter_incharge}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 col-lg-12 col-sm-12">
                    <div class="col-md-4">
                        <md-autocomplete md-clear-button="true"
                                         md-floating-label="Property Usage"
                                         md-item-text="item.usage_name"
                                         md-items="item in get_property_usage(search_usage_name)"
                                         md-menu-class="md-virtual-repeat-container"
                                         md-min-length=0
                                         md-no-cache="true"
                                         ng-required="true"
                                         md-search-text="search_usage_name"
                                         md-selected-item="selected_usage_name"
                                         md-selected-item-change="Property_Usage_Change(item)">
                            <md-item-template>
                                <span md-highlight-text="search_usage_name"> {{item.usage_name}}</span>
                            </md-item-template>
                            <md-not-found>
                                No Branch matching "{{search_usage_name}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>

                    <div class="col-md-4">
                        <md-autocomplete md-clear-button="true"
                                         md-floating-label="Branch"
                                         md-item-text="item.branch_detail"
                                         md-items="item in soourcedata(search_branch)"
                                         md-menu-class="md-virtual-repeat-container"
                                         md-min-length=0
                                         md-no-cache="true"
                                         ng-required="true"
                                         md-search-text="search_branch"
                                         md-selected-item="selected_branch"
                                         md-selected-item-change="Branch_Change(item)">
                            <md-item-template>
                                <span md-highlight-text="search_branch"> {{item.branch_detail}}</span>
                            </md-item-template>
                            <md-not-found>
                                No Branch matching "{{search_branch}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>

                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-autocomplete md-clear-button="true"
                                         md-floating-label="Control Office"
                                         md-item-text="item.branch_detail"
                                         md-items="item in soourcedata(search_control_office)"
                                         md-menu-class="md-virtual-repeat-container"
                                         md-min-length=0
                                         md-no-cache="true"
                                         ng-required="true"
                                         md-search-text="search_control_office"
                                         md-selected-item="selected_control_office"
                                         md-selected-item-change="Control_Office_Change(item)">
                            <md-item-template>
                                <span md-highlight-text="search_control_office"> {{item.branch_detail}}</span>
                            </md-item-template>
                            <md-not-found>
                                No Employee matching "{{search_control_office}}" were found.
                            </md-not-found>
                        </md-autocomplete>
                    </div>
                </div>
            </div>
            <br/>
            <div class="row">
                <div class="col-md-12 col-lg-12 col-sm-12">
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-input-container class="md-block inputcontainer">
                            <label>Remarks</label>
                            <input ng-model="pro_remarks" no-special-char
                                   ng-change="ACselectchange(invoiceamt,invdate,crno)"
                                   maxlength="80" required/>
                        </md-input-container>
                    </div>
                    <div class="col-md-4 col-lg-4 col-sm-4">
                        <md-input-container class="md-block inputcontainer">
                            <label>Location</label>
                            <md-select ng-model="supplier_gid"
                                       ng-change="ACselectchange(selectedtype,supplier_gid,invoicenum,invoiceamt,invdate,crno)"
                                       ng-disabled="disable" md-on-close="clearSearchTerm()"
                                       data-md-container-class="selectdemoSelectHeader">
                                <md-select-header class="demo-select-header">
                                    <input ng-model="searchTerm" type="search"
                                           placeholder="Search for a Location.."
                                           class="demo-header-searchbox md-text">
                                </md-select-header>
                                <md-optgroup label="Supplier Name">
                                    <md-option ng-value="posupplier.supplier_gid"
                                               ng-click="supplier_click(posupplier.supplier_gid)"
                                               ng-selected="supplier_gid == posupplier.supplier_gid" ng-repeat="posupplier in invoicesupplier_list |
                                                     filter:searchTerm">{{posupplier.supplier_name}}
                                    </md-option>
                                </md-optgroup>
                            </md-select>
                        </md-input-container>
                    </div>
                    <div class="col-md-2" style="margin-top: 35px;" ng-hide="update=='not_edit' || update=='edit'">
                        <input class="ng-isolate-scope" file-model="files"
                               fileinput="file" id="file" multiple type="file"
                               onchange="angular.element(this).scope().imageUpload(event)"/>
                    </div>
                    <div class="col-md-2" style="margin-top: 35px;" ng-show="image_visible=='true'">
                        <button type="button" class="btn btn-info" ng-hide="update=='not_edit'"
                                ng-click="view_images_popup()">View Images
                        </button>
                    </div>
                </div>
            </div>
            <br/>
            <div class="row">
                <div ng-include="'empadrs'"></div>
            </div>
            <div class="col-md-12" ng-hide="update=='not_edit'">
                <br>
                <div class="col-md-2"></div>
                <div class="col-md-2"></div>
                <div class="col-md-2" style="bottom:0px;color:green" ng-if="edit_disabled">
                    <h3><span class="editlink material-icons" style="color:#D64CB4;"
                              ng-click="view_attached_file()">
                                arrow_upward
                        </span>
                    </h3>View Attached File
                </div>
                <div class="col-md-2" ng-if='edit_disabled'>
                    <md-button class="md-raised custbutton" value="Edit"
                               ng-click="br_property_edit()" ng-disabled="">
                        Update
                    </md-button>
                </div>
                <div class="col-md-2" ng-if="!edit_disabled">
                    <md-button class="md-raised custbutton" value="submit"
                               ng-click="br_property_save()"
                               ng-if="!edit_disabled"
                               ng-disabled="pro_create.$invalid">
                        Save
                    </md-button>
                </div>
                <div class="col-md-2">
                    <md-button class="md-raised" value="close" data-dismiss="modal"
                               ng-click="maker_summary_page()"
                               aria-label="Close">Cancel
                    </md-button>
                </div>

<!--                 <div class="col-md-2">-->
<!--                    <md-button class="md-raised custbutton" value="submit"-->
<!--                               ng-click="thread_test_call()">-->
<!--                        Thread Test(Don't Use)-->
<!--                    </md-button>-->
<!--                </div>-->


            </div>
        </form>
        <div class="row" ng-show="update=='not_edit'">
            <br/>
            <div class="col-md-12">
                <div class="col-md-3"></div>
                <div class="col-md-2" style="bottom:0px;color:green">
                    <h3><span class="editlink material-icons" style="color:#D64CB4;"
                              ng-click="view_attached_file()">
                                arrow_upward
                        </span>
                    </h3>View Attached File
                </div>
                <div class="col-md-3">
                    <md-button class="md-raised" value="close" data-dismiss="modal"
                               ng-click="maker_summary_page()"
                               aria-label="Close">Cancel
                    </md-button>
                </div>
            </div>
        </div>
        <div class="modal fade" id="view_images" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="exampleModalLabels2">
                            ALL IMAGES
                            <button type="button" class="close" data-dismiss="modal"
                                    ng-click="close_pr_popup()"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="center" ng-show="file_path.length=='0'">
                                    <h3>No Attached File</h3>
                                </div>
                                <div class="col-md-offset-10" ng-show="file_path.length!='0'">

                                    <span class="editlink" ng-click="remove_all_files()">
                               <span class="material-icons removelink">delete</span>
                                <md-tooltip>Remove All</md-tooltip>
                                </span>
                                    <span>Remove All</span>
                                </div>
                                <div ng-repeat="files in file_path">
                                    <div class="col-md-10">
                                        <h5 style="color:blue">{{files.file_name}}</h5>
                                        <img src="{{files.file}}" alt="{{files}}"
                                             class="myimage img-responsive thumbnail">
                                        <hr/>
                                    </div>
                                    <div class="col-md-2" style="margin-top:200px;">
                                        <span class="editlink" ng-click="delete_one_file($index,files.file_name)">
                                        <span class="material-icons removelink">delete</span>
                                        </span>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-offset-6">
                                <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                           aria-label="Close">Cancel
                                </md-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="view_attached_file" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:70%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="exampleModalLabelss">
                            Attached File
                            <button type="button" class="close" data-dismiss="modal"
                                    ng-click="close_pr_popup()"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <div class="body">
                        <div class="row table-responsive">
                            <div class="col-md-12 col-lg-12 col-sm-12">
                                <div class="row table-responsive">
                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                        <table class="table table-striped table-bordered table-condensed table-hover md-primary"
                                               md-progress="deferred">
                                            <thead class="header">
                                            <tr>
                                                <th>S.No</th>
                                                <th>Fine Name</th>
                                                <th>View File</th>
                                                <th>Download File</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr align="center"
                                                ng-repeat="file in ecf_all_files.slice(((currentPages-1)*itemsPerPages),((currentPages)*itemsPerPages)) | filter:search:strict">
                                                <td>{{((currentPages-1)*itemsPerPages)+$index+1}}
                                                </td>
                                                <td align="left">{{file.file_name}}</td>
                                                <td><span class="editlink material-icons"
                                                          ng-click="view_file(file)">insert_photo
                                                        </span>
                                                </td>
                                                <td>
                                                    <md-button class="md-icon-button md-primary" aria-label="Settings"
                                                               href="common_s3_file_download?filename={{file.file_name}}">
                                                        <md-icon>get_app</md-icon>
                                                        <md-tooltip>Download File</md-tooltip>
                                                    </md-button>
                                                </td>
                                            </tr>
                                            </tbody>
                                            <tfoot>
                                            <tr align="center">
                                                <td colspan="3">
                                                    <ul uib-pagination
                                                        total-items="ecf_all_files.length"
                                                        ng-model="currentPages"
                                                        max-size="maxSizes"
                                                        class="pagination-sm"
                                                        boundary-links="true"
                                                        items-per-page="itemsPerPages"></ul>
                                                </td>
                                                <td colspan="2">
                                                    Total Count:{{ecf_all_files.length}}
                                                </td>
                                            </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-offset-6">
                                <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                           aria-label="Close">Cancel
                                </md-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="show_file" tabindex="-1" role="dialog" data-backdrop="static"
             data-keyboard="false"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header popup-header">
                        <h5 class="modal-title" id="view_files">
                            {{url_data[0].file_name}}
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </h5>
                    </div>
                    <br/>
                    <div class="body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-12" align="center">
                                    <img src="{{url_datas[0].file_path}}"
                                         alt="{{url_datas[0].file_name}}"
                                         class="img-thumbnail"
                                         align="center"
                                         ng-show="extension!='pdf'">
                                    <hr/>
                                </div>
                                <iframe src="{{pdf_file_url_path}}" frameborder="0"
                                        height="600px" width="97%" ng-show="extension=='pdf'"></iframe>

                            </div>
                            <div class="row">
                                <div class="col-md-offset-6">
                                    <md-button class="md-raised md-warn" value="close" data-dismiss="modal"
                                               aria-label="Close">Cancel
                                    </md-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{% endverbatim %}
<style>

.btn-default.btn-on.active{background-color: #5BB75B;color: white;}
.btn-default.btn-off.active{background-color: #DA4F49;color: white;}

.btn-default.btn-on-1.active{background-color: #006FFC;color: white;}
.btn-default.btn-off-1.active{background-color: #DA4F49;color: white;}

.btn-default.btn-on-2.active{background-color: #00D590;color: white;}
.btn-default.btn-off-2.active{background-color: #A7A7A7;color: white;}

.btn-default.btn-on-3.active{color: #5BB75B;font-weight:bolder;}
.btn-default.btn-off-3.active{color: #DA4F49;font-weight:bolder;}

.btn-default.btn-on-4.active{background-color: #006FFC;color: #5BB75B;}
.btn-default.btn-off-4.active{background-color: #DA4F49;color: #DA4F49;}



 .md-select-menu-container.md-active {
    z-index: 1060;
    }








</style>

<script>
    var app=angular.module('makersummary',['ngMaterial','ui.bootstrap','AppCommon','rzTable']).config(function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';

});
app.controller('myCtrl', ['$scope', function($scope) {}]);
app.controller('ctrlsummary', ['$scope', '$filter','$mdDateLocale','$rootScope','testService', '$window', '$mdDialog', '$element','$http','$timeout','$q','$sce',
    function($scope, $filter, $mdDateLocale, $rootScope,testService, $window, $mdDialog, $element,$http,$timeout,$q,$sce) {

        $scope.loading = function() {
                $mdDialog.show({
                    templateUrl: 'loaderSpinner',
                    parent: angular.element(document.body),
                    clickOutsideToClose: false
                });
        };

        $scope.loading_view_attached_file = function() {
            $mdDialog.show({
                templateUrl: 'loaderSpinner',
                parent: angular.element(document.getElementById('view_attached_file')),
                clickOutsideToClose: false
            });
        };

        $scope.endloading = function() {
            $mdDialog.hide();
        };

        $scope.currentPages = 1;
        $scope.maxSizes = 3;
        $scope.itemsPerPages = 10;


         load_address();
         load_property_details();
<!--         load_property_dropdown();-->

        window.mdSelectOnKeyDownOverride = function (event) {
            event.stopPropagation();
        };

<!--    loading address field like state,district,city,pincode-->
      function load_address() {

       var sttddl = testService.getstateddl()
       sttddl.then(function(result) {
            $scope.stateddl = [];
            $scope.stateddl = JSON.parse(result.data);
            $scope.locstate = JSON.parse(result.data);
             for (var i = 0; i < 1; i++) {
                dta = {
                    "state_gid":0,
                    "state_name": "Add New State",
                }
                $scope.stateddl.push(dta);
            }
          }),
            function() {
                alert('no data');
            };
       };


        $scope.state_clk = function(state_gid, type) {


            var distddl = testService.getdistddl(state_gid)

            distddl.then(function(result) {
                    if (type == 'address') {
                        $scope.adistrictddl = [];
                        $scope.adistrictddl = JSON.parse(result.data);
                    } else {
                        $scope.distritddl = [];
                        $scope.distritddl = JSON.parse(result.data);
                        $scope.distritddl1 = JSON.parse(result.data);
                             for (var i = 0; i < 1; i++) {
                             dta = {
                            "district_gid":0,
                            "district_name": "Add New District",
                                  }
                               $scope.distritddl1.push(dta);
                    }
                    }
                }),
                function() {
                    alert('no data');
                };
        };

        $scope.district_clk = function(district_gid, type) {
            var ctyddl = testService.getcityddl(district_gid)
            ctyddl.then(function(result) {
                    if (type == 'address') {
                        $scope.acity1 = [];
                        $scope.acity1 = JSON.parse(result.data);
                    } else {
                        $scope.city1 = [];
                        $scope.city2=[];
                        $scope.city1 = JSON.parse(result.data);
                         $scope.city2 = JSON.parse(result.data);
                         for (var i = 0; i < 1; i++) {
                          dta = {
                            "city_gid":0,
                            "City_Name":"Add New City",
                           }
                           $scope.city2.push(dta);
                }
                    }
                }),
                function() {
                    alert('no data');
                };
        };


        $scope.city_clk = function(city_gid, type) {
            var pincd = testService.getpincode(city_gid)
            pincd.then(function(result) {
                    if (type == 'address') {

                        var apincde = [];
                        apincde = JSON.parse(result.data);
                        $scope.add.pincode1 = apincde[0].pincode_no;
                    } else {
                        var pincde = [];
                        pincde = JSON.parse(result.data);
                        $scope.pcode = pincde[0].pincode_no;
                    }
            }),
                function() {
                    alert('no data');
                };
        };



<!--property addredd details-->
        function load_property_details(){

          this.getstateddl = function(d) {
            var response = $http.get(Appname + "/stateddl/");
            return response;
           }
        }
        $scope.file_path="";
        $scope.file_count=0;
        $scope.file_stored_data=[];
        $scope.duplicate_images=1;
        $scope.number_of_message=1;

        $scope.loaddata = function(file_img,img, callback) {
                var deferred = $q.defer();
                var promise = deferred.promise;
                promise.then(function() {
                    var file_img_length = document.getElementById('file').files.length;
                    if(file_img_length!=0){
                        for(l=0;l<file_img_length;l++){
                            var file_img = document.getElementById('file').files[l];
                            var file_name=file_img.name;
                            $scope.new_file_name=file_img.name;
                            var imgs = new FormData();
                            imgs.append('file', file_img);
                            imgs.append('name', file_name);
                            $scope.duplicate_images=1;
                            for(var p=0;p<$scope.deleted_files.length;p++){
                                $scope.temp_file_names=$scope.deleted_files[p].file_names;
                                if($scope.new_file_name==$scope.temp_file_names){
                                    $scope.duplicate_images=0;
                                    $scope.file_count=$scope.file_count+1;
                                }
                            }
                            if(file_img!=undefined&&$scope.duplicate_images==1){
                              $scope.loading();
                                 var upload = testService.save_files(imgs);
                                 upload.then(function(result) {
                                    $scope.all_datas= result.data;
                                    if($scope.all_datas.status=="SUCCESS"){
                                    $scope.file_count=$scope.file_count+1;
                                    $scope.file_status=1;
                                    $scope.file_stored_data.push($scope.all_datas);
                                    }
                                    else{
                                        $scope.file_status=2;
                                    }
                                    callback();
                                }).finally($scope.endloading);
                            }
                            else{
                                $scope.file_status=0;
                                callback();
                            }
                        }
                    }
                     else{
<!--                        alert("Please Attache File...");-->
                        $scope.file_status=1;
                        $scope.endloading();
                        callback();
                     }
                }).then(function() {
                    // callback();
                });
                deferred.resolve();

        };
        $scope.file_status=0;

        $scope.br_property_save=function(){
        $scope.file_count=0;
        debugger;
            var data={"params":{"filters": {
                                "property_name":$scope.pro_name,
                                "property_type":$scope.pro_types,
                                "property_locationgid":$scope.add.addselectedcity,
                                "property_landmark":$scope.pro_landmark,
                                "property_inchargegid":$scope.pro_incharge,
                                "property_alternativeinchargegid":$scope.pro_alt_incharge,
                                "property_usage":$scope.property_usage_name,
                                "property_controloffice":$scope.pro_ctrl_office,
                                "property_controlby":0,
                                "property_branch":$scope.pro_branch,
                                "property_status":"PENDING",
                                "property_remarks":$scope.pro_remarks,
                                "ADDRESS":[{
                                "Address1":$scope.add.addline,
                                "Address2":$scope.add.addline2,
                                "Address3":$scope.add.addline3,
                                "Pincode":$scope.add.pincode1,
                                "District_Gid":$scope.add.addselecteddistrict,
                                "City_Gid":$scope.add.addselectedcity,
                                "State_Gid":$scope.add.addselectedstate}]
                                }
                         }};



            $scope.save_data={
                         "Type":"INSERT",
                         "Sub_Type":"property",
                         "data":data
             };

            var file_img = document.getElementById('file').files[0];
            $scope.list_of_files= document.getElementById('file').files.length;
            var img = new FormData();
            var UPLOAD_FILE="";

            if(file_img!=undefined){
                $scope.file_status=0;
                var file_name=file_img.name;

                var filename = file_img.name;
                var index = filename.lastIndexOf(".");
                $scope.strsubstring = filename.substring(index, filename.length);

                img.append('file', file_img);
                img.append('name', filename);
            }

            $scope.loaddata(file_img,img, function() {
                if($scope.file_status==1&&$scope.file_count==$scope.list_of_files){
                    $scope.loading();
                    $scope.save_data["data"]["params"]["filters"]["file_data"]=$scope.file_stored_data;
                    var property_save = testService.save_property_detail($scope.save_data);
                         property_save.then(function(result) {
                         debugger;
                              if (result.data[0] === "success") {
                                    alert("Property Created Successfully, Property Code Is:"+result.data[1]);
                                    $window.location.href = "BranchExp/Br_MakerSummary/";

                                    } else {
                                  alert("Data Not Inserted");
                                  }

                              if(result.data.MESSAGE=="ERROR_OCCURED"){
                                    alert(JSON.stringify(result.data.DATA));
                              }
                               },
                            function(err) {
                                 alert(JSON.stringify(result.data));
                            }).finally($scope.endloading);
                }
                else if($scope.file_status==2){
                        alert("File Upload Failed");
                }
                else if($scope.file_status==0 && $scope.file_path.length==0 && $scope.number_of_message==1){
                        alert("Please Attach File");
                        $scope.deleted_files=[];
                        $scope.number_of_message=$scope.number_of_message+1;
                        $scope.endloading();
                }
            });
        };
<!--        end insert details-->

<!--            update details-->

         $scope.br_property_edit=function(){
            var data={"params":{"filters":
                            {
                                "property_name":$scope.pro_name,
                                "property_gid":$scope.pro_gid,
                                "property_type":$scope.pro_types,
                                "property_locationgid":$scope.add.addselectedcity,
                                "property_landmark":$scope.pro_landmark,
                                "property_inchargegid":$scope.pro_incharge,
                                "property_alternativeinchargegid":$scope.pro_alt_incharge,
                                "property_branch":$scope.pro_branch,
                                "property_controloffice":$scope.pro_ctrl_office,
                                "property_usage":$scope.property_usage_name,
                                "property_branch":$scope.pro_branch,
                                "property_controlby":$scope.pro_ctrl_offcier,
                                "property_remarks":$scope.pro_remarks,
                                "ADDRESS":[{
                                "Address1":$scope.add.addline,
                                "Address2":$scope.add.addline2,
                                "Address3":$scope.add.addline3,
                                "Pincode":$scope.add.pincode1,
                                "District_Gid":$scope.add.addselecteddistrict,
                                "City_Gid":$scope.add.addselectedcity,
                                "State_Gid":$scope.add.addselectedstate}]

                            }
                            }
                     };

            var data_int={
                         "Type":"update",
                         "Sub_Type":"property",
                         "data":data
             };

            var property_save = testService.save_property_detail(data_int);
                    property_save.then(function(result) {
                        if (result.data === "SUCCESS") {
                            alert("Updated Succesfully");
                            $window.location.href = "BranchExp/Br_MakerSummary/";
                        }
                        else {
                                alert("Data Not Inserted");
                        }
                     }, function(err) {
                         alert('Data Not Inserted');
                     });
           };


<!--            end update deatils-->

<!--                close to maker summary page link-->
                     $scope.maker_summary_page = function() {
                     $window.location.href = "BranchExp/Br_MakerSummary/";

                     };




<!--            update deatils-->
     var pro=[];
        if (sessionStorage.getItem('pro_update') != null) {
        var pro_update = JSON.parse(sessionStorage.getItem('pro_update'));
        pro_gid = pro_update.pro_gid;
        debugger;
        console.log(pro_update);
        $scope.update = pro_update.view;

        <!--sessionStorage.clear()-->

             var data={"params":
                        {
                          "filters":{"property_gid":pro_gid },
                          "classification":{ }
                        }
            };
             var data_init={
                         "Type":"PROPERTY",
                         "Sub_Type":"SUMMARY",
                         "data":data
             }
        $scope.loading();
        var pro_det = testService.pro_get_det(data_init)
            pro_det.then(function(result) {
            $scope.edit_disabled=true;
            $scope.pro = result.data.DATA;
            console.log($scope.pro);

            $scope.pro_gid = $scope.pro[0].property_gid;
            $scope.pro_code = $scope.pro[0].property_code;
            $scope.pro_name=$scope.pro[0].property_name;
            $scope.search_propery_type=$scope.pro[0].property_type;
            $scope.search_incharge=$scope.pro[0].inchargename;
            $scope.search_alter_incharge=$scope.pro[0].alternativeincharge;
            $scope.search_usage_name=$scope.pro[0].property_usage;
            $scope.search_control_office=$scope.pro[0].controloffice_name;
            $scope.search_branch=$scope.pro[0].branch_name;
            $scope.pro_remarks=$scope.pro[0].property_remarks;
            $scope.pro_ctrl_offcier=$scope.pro[0].Property_controlby;
            $scope.pro_landmark=$scope.pro[0].property_landmark;
            $scope.address_gid=$scope.pro[0].address_gid;


            $scope.add.addline=$scope.pro[0].address_1;
            $scope.add.addline2=$scope.pro[0].address_2;
            $scope.add.addline3=$scope.pro[0].address_3;

            $scope.add.pincode1 = $scope.pro[0].address_pincode;
            $scope.pinchange($scope.add.pincode1,'address');
<!--            $scope.selectedState = $scope.pro[0].address_state_gid;-->
<!--            $scope.state_clk($scope.selectedState);-->
<!--            $scope.selecteddistrict = $scope.pro[0].address_district_gid;-->
<!--            $scope.district_clk($scope.selecteddistrict);-->
<!--            $scope.selectedcity =$scope.pro[0].address_city_gid;-->
<!--            $scope.city_clk($scope.selectedcity);-->

        },
           function(err) {
            alert(JSON.stingify(result.data));
        }).finally($scope.endloading);
    } else {
      $scope.edit_disabled=false;
    $scope.Customer_disable = false;
        $scope.update = '';
    }
    if ($scope.update) {
        $scope.title = 'Edit'
    } else {

        $scope.title = 'Create'
    }

<!--           update end-->



       var datas={"filters":{
                "Table_name": "gal_mst_tmetadata",
                "Column_1": "metadata_gid,metadata_value",
                "Column_2": "",
                "Where_Common": "metadata",
                "Where_Primary": "columnname",
                "Primary_Value": "property_type",
                "Order_by": "value"
                }
       }
       var data_init={
             "data":datas,
             "Type":"PRODUCT",
             "Sub_Type":"",
       }


       var property_type=testService.getproperty_type(data_init);
        property_type.then(function(result){
           $scope.pro_type_data=[];

            $scope.property_types=result.data;
            $scope.pro_val=$scope.property_types;
         },
          function(err) {
             alert('No data!');
        });

        $scope.get_property = Change_emp_name;
            function Change_emp_name(query) {
                var result = $filter('filter')($scope.property_types, {
                'metadata_value':query,
            });
            return result;
        }

        $scope.PropertyChanged=function(property_gid){
            $scope.pro_types=property_gid;
        };

        $scope.getemployee_srch= function(searchText) {

            var datas = {
                params: {
                    "Group": "GET_EMP_DATA",
                    "Limit" : 0 + "," + 30,
                    "Type": "EMPLOYEE",
                    "Sub_Type": "EMPLOYEE_ALL",
                    "json" : {
                        "Params": {
                                "FILTER": {
                                    "Employee_name":searchText,
                                },
                            }
                        }
                    }
                }
            return $http.post(Appname + '/employee_mst_data/' , datas).then(function(data) {
                return data.data.DATA;
              });
        };

        $scope.Incharge_Change =function(emp){
            if(emp!=undefined){
                $scope.pro_incharge=emp.employee_gid;
             }
        }

        $scope.Property_Alter_Incharge_Change =function(emp){
            if(emp!=undefined){
                $scope.pro_alt_incharge=emp.employee_gid;
             }
        }

        $scope.soourcedata = function(query) {

            var datas={params:{"type":"Mode","Sub_Type":"Summary_new",
                               "FILTER":{"Limit_Start":0,"Limit_End":30,"branch_name":"","branch_detail":query,
                                            "branch_code":""},"CLASSIFICATION":{"Entity_Gid":[0]}}};

                         return $http.post(Appname + '/classificationdata_get/' , datas).then(function(data) {

                            var final_values=data.data.DATA;
                            console.log(final_values);
                            return final_values;
                          });
        }



        $scope.Control_Office_Change =function(branch){
            if(branch!=undefined){
                $scope.pro_ctrl_office=branch.branch_gid;
             }
        }

        $scope.Branch_Change =function(branch){
            if(branch!=undefined){
                $scope.pro_branch=branch.branch_gid;
             }
        }


        $scope.add = [];
        $scope.pinchange = function(pincode, type) {
        var pincd = testService.getpincodeall(pincode)
        pincd.then(function(result) {
                if (type == 'address') {
                    var apincde = [];
                    apincde = JSON.parse(result.data);
                    $scope.add.addselectedstate = apincde[0].city_state_gid;
                    $scope.state_clk($scope.add.addselectedstate, 'address');
                    $scope.add.addselecteddistrict = apincde[0].pincode_district_gid;
                    $scope.district_clk($scope.add.addselecteddistrict, 'address');
                    $scope.add.addselectedcity = apincde[0].pincode_City_gid;
                    $scope.add.pincode1 = apincde[0].pincode_no;

                }
            }),
            function() {
                alert('No data!.');
            };
    };
    $scope.state_clk = function(state_gid, type) {
        var distddl = testService.getdistddl(state_gid)
        distddl.then(function(result) {
                if (type == 'address') {
                    $scope.adistrictddl = [];
                    $scope.adistrictddl = JSON.parse(result.data);
                } else {
                    $scope.distritddl = [];
                    $scope.distritddl = JSON.parse(result.data);
                }
            }),
            function() {
                alert('No data!.');
            };
    };
    $scope.district_clk = function(district_gid, type) {
        var ctyddl = testService.getcityddl(district_gid)
        ctyddl.then(function(result) {
                if (type == 'address') {
                    $scope.acity1 = [];
                    $scope.acity1 = JSON.parse(result.data);
                } else {
                    $scope.city1 = [];
                    $scope.city1 = JSON.parse(result.data);
                }
            }),
            function() {
                alert('No data!.');
            };
    };
    $scope.city_clk = function(city_gid, type) {
        var pincd = testService.getpincode(city_gid)
        pincd.then(function(result) {
                if (type == 'address') {
                    var apincde = [];
                    apincde = JSON.parse(result.data);
                    $scope.add.pincode1 = apincde[0].pincode_no;
                } else {
                    var pincde = [];
                    pincde = JSON.parse(result.data);
                    $scope.pcode = pincde[0].pincode_no;
                }
            }),
            function() {
                alert('No data!.');
            };
    };



    $scope.stepsModel=[];
    $scope.image_visible="false";

    $scope.stepsModel=[];
    $scope.image_visible="false";
    $scope.imageUpload = function(event){
        debugger;
        $scope.stepsModel=[];
        $scope.filenames = [];
        $scope.image_visible ="true";
             var files = event.target.files; //FileList object
             for (var i = 0; i < files.length; i++) {
                 var file = files[i];
                     var reader = new FileReader();
                     reader.onload = $scope.imageIsLoaded;
                     reader.readAsDataURL(file);
                     $scope.filenames.push(file.name);
             }
    }
    $scope.sttepsModel_Last=[];
    $scope.imageIsLoaded = function(e){
        $scope.$apply(function() {
            $scope.stepsModel.push(e.target.result);
        });
        $scope.sttepsModel_Last=[];
        for(var k=0;k<$scope.filenames.length;k++){
            $scope.sttepsModel_Last.push({"file":$scope.stepsModel[k],"file_name":$scope.filenames[k]});
        }
    }


    $scope.view_images_popup=function(){
<!--        $scope.file_path = $scope.stepsModel;-->
        $scope.file_path = $scope.sttepsModel_Last;
        modalshow('view_images');
    }

    $scope.deleted_files=[];
        $scope.delete_one_file=function(index,file_name){
            debugger;
            $scope.file_imglength = document.getElementById('file').files.length;
            for(i=0;i<$scope.file_imglength;i++){
                if(i==index){
                    $scope.file_path.splice(i, 1);
<!--                    var file_img = document.getElementById('file').files[i];-->
<!--                    var file_name=file_img.name;-->
                    $scope.deleted_files.push({"file_names":file_name});
                }
            }
            if($scope.file_path.length==0){
                $scope.remove_all_files();
            }
      }
    $scope.remove_all_files=function(){
        $scope.file_path=[];
        $scope.deleted_files=[];
        elmn = angular.element( document.getElementById( 'file' ).files);
        elmn.remove();
        angular.element("input[type='file']").val(null);
        $scope.image_visible="false";
    }

    $scope.propertry_usage_data=[{"usage_name":"Office Building"},{"usage_name":"Guest House"},
                                 {"usage_name":"Quarters Building"},{"usage_name":"ATM On Site"},
                                 {"usage_name":"ATM Off Site"}
                                ];
    $scope.get_property_usage= change_property;
            function change_property(query) {
                var result = $filter('filter')($scope.propertry_usage_data, {
                'usage_name':query,
            });
            return result;
    }

    $scope.Property_Usage_Change =function(property_usage_name){
        if(property_usage_name!=undefined){
            $scope.property_usage_name=property_usage_name.usage_name;
            console.log($scope.property_usage_name);
         }
    }

    $scope.view_attached_file=function(){
     debugger;

        var datas={params:{"action":"GET","type":"FILE_DETAIL",
            "filter":{"file_reftablegid":$scope.pro_gid,"ref_name":"PROPERTY"}}};
         $scope.loading();
         var ecf_file_data = testService.get_approval_summary(datas);
         ecf_file_data.then(function(result) {

                $scope.ecf_all_files = result.data;
                 modalshow('view_attached_file');

         },
         function(err) {
            alert('No data!.');
         }).finally($scope.endloading);

     }

     $scope.view_file=function(file_list){
        debugger;
        var datas={"file_data":[file_list]};
         $scope.loading_view_attached_file();
         var generated_urls = testService.get_generated_url_data(datas);
         generated_urls.then(function(result) {
                $scope.url_datas = result.data;
                $scope.file_url_path=$scope.url_datas[0].file_path;
                var final_file_name=$scope.url_datas[0].file_name;
                $scope.extension=final_file_name.substr(final_file_name.lastIndexOf('.')+1);
                if($scope.extension=="pdf"){
                    complete_url ='http://docs.google.com/gview?url=' + encodeURIComponent($scope.file_url_path) + '&embedded=true';
                    $scope.pdf_file_url_path = $sce.trustAsResourceUrl(complete_url);
                }
                 modalshow('show_file');
         },
         function(err) {
            alert('No data!.');
         }).finally($scope.endloading);
     }

     $scope.trustAsHtml = function(html) {
      return $sce.trustAsHtml(html);
    }

    $scope.thread_test_call=function(){
    debugger;
        var json={'Type': 'INSERT', 'Sub_Type': 'property', 'data': {'params': {'filters': {'property_name': 'Thread Testing', 'property_type': 'OWN', 'property_locationgid': 9314, 'property_landmark': '1', 'property_inchargegid': 1, 'property_alternativeinchargegid': 1, 'property_usage': 'Guest House', 'property_controloffice': 913, 'property_controlby': 0, 'property_branch': 913, 'property_status': 'PENDING', 'property_remarks': '1', 'ADDRESS': [{'Address1': 'ABCD', 'Address2': 'ECF', 'Address3': 'GH', 'Pincode': '606907', 'District_Gid': 26, 'City_Gid': 9314, 'State_Gid': 1}], 'file_data': []}}}}
        var property_save = testService.thread_testing_service(json);
         property_save.then(function(result) {
         debugger;
              if (result.data[0] === "success") {
                    alert("Property Created Successfully, Property Code Is:"+result.data[1]);

                    } else {
                  alert("Data Not Inserted");
                  }

              if(result.data.MESSAGE=="ERROR_OCCURED"){
                    alert(JSON.stringify(result.data.DATA));
              }
               },
            function(err) {
                 alert(JSON.stringify(result.data));
            }).finally($scope.endloading);
    }



}]);

app.service("testService", function ($http) {

     this.getstateddl = function(d) {
            var response = $http.get(Appname + "/stateddl/");
            return response;
     }

     this.getdistddl = function(state_gid) {
        var response = $http.get(Appname + "/districtddl/", {
            params: {
                "state_gid": state_gid
            }
        });
        return response;
     }

     this.getcityddl = function(district_gid) {
        var response = $http.get(Appname + "/cityddl/", {
            params: {
                "district_gid": district_gid
            }
        });
        return response;
     }

     this.getpincode = function(city_gid) {
        var response = $http.get(Appname + "/pincode/", {
            params: {
                "city_gid": city_gid
            }
        });
        return response;
     }

     this.save_property_detail = function(data) {
        var response = $http.post(Appname + "/insertNewBranchDetails/", data);
        return response;
     }
     this.thread_testing_service = function(data) {
        var response = $http.post(Appname + "/thread_testing/", data);
        return response;
     }

     this.getemployee=function(){
        var response=$http.get(Appname+"/empddl/");
        return response;
     }

     this.pro_get_det=function(data_init){
            var response=$http.post(Appname +"/get_pr_details/",data_init);
                return response;

     }

     this.getentitydata = function () {
        var response=$http.post(Appname+"/classificationdata_get/",{params:{"type":"Mode","Sub_Type":"Summary",
                               "FILTER":{},"CLASSIFICATION":{"Entity_Gid":[0]}}});
        return response;
     }

     this.getproperty_type=function(data_init){
           var response=$http.post(Appname+"/GetpropertyType/",data_init);
            return response;
     }

     this.getpincodeall = function(pincode) {
        var response = $http.get(Appname + "/allpinget/", {
            params: {
                "pincode": pincode
            }
        });
        return response;
    }

    this.getdistddl = function(state_gid) {
        var response = $http.get(Appname + "/districtddl/", {
            params: {
                "state_gid": state_gid
            }
        });
        return response;
    }

    this.getcityddl = function(district_gid) {
        var response = $http.get(Appname + "/cityddl/", {
            params: {
                "district_gid": district_gid
            }
        });
        return response;
    }

    this.getpincode = function(city_gid) {
        var response = $http.get(Appname + "/pincode/", {
            params: {
                "city_gid": city_gid
            }
        });
        return response;
    }

    this.getstateddl = function(d) {
        var response = $http.get(Appname + "/stateddl/");
        return response;
    }

    this.save_files=function(img){
          var response=$http.post(Appname+"/fileUploadS3/",img,
               {
                 transformRequest: angular.identity,
                 headers: {
                    'Content-Type': undefined
                 }
               }
          );
        return response;
    }

    this.get_approval_summary=function(data){
        var response=$http.post(Appname+"/get_onward_data/",data);
        return response;
    }

    this.get_generated_url_data=function(data){
        var response=$http.post(Appname+"/common_s3_file_url_generate/",data);
        return response;
    }


});










</script>

{% endblock %}